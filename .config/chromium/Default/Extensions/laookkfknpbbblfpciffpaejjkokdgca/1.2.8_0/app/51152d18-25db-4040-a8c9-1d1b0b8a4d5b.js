var fn_addin=function(C,y,t){var x=x||{};return x.styles=x.styles||{},x.commands=x.commands||{},x.dependencies=t||x.dependencies||{},x.styles.style=function(){},x.views=x.views||{},x.collect=x.collect||{},x.models=x.models||{},x.templates=x.templates||{},x.info={widget:!0,placeholderType:"pane",label:"Todo",id:"todo",width:"320",region:"bottom-right",order:"append",addin:"51152d18-25db-4040-a8c9-1d1b0b8a4d5b",visibleSetting:"todoVisible",openState:"showTodoList",keepOpenSetting:"keepTodoState",toggleEvent:"globalEvent:key:T",appClass:"todo-app",storedHeight:"todo-pane-height",class:"todo",commands:["settings.panels.todo"]},C.console.log(C.elapsed()+": "+x.info.id+" started"),x.templates=x.templates||{},x.templates.addtodolist=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(t,e,o,i){return'<span id="add-icon" class="todo-list-add-icon"><i class="icon icon-plus"></i></span>\n<input id="list-new" class="todo-input todo-list-add-input" type="text" placeholder="    New List" />\n<span class="loading todo-list-add-loading"><i class="loading-icon"></i> <span >Loading...</span></span>\n\n'},useData:!0}),x.templates.dropdownmenu=Handlebars.template({1:function(t,e,o,i){var s;return'\t<div class="icon-wrapper dropdown-toggle">\n\t\t<i class="icon '+this.escapeExpression("function"==typeof(s=null!=(s=e.iClassName||(null!=t?t.iClassName:t))?s:e.helperMissing)?s.call(t,{name:"iClassName",hash:{},data:i}):s)+'"></i>\n\t</div>\n'},3:function(t,e,o,i){var s;return null!=(s=e.if.call(t,null!=t?t.providerLogo:t,{name:"if",hash:{},fn:this.program(4,i,0),inverse:this.program(6,i,0),data:i}))?s:""},4:function(t,e,o,i){var s;return'\t<div class="project-chooser-toggle"><span class="icon-wrapper control control-dropdown"><img class="provider-icon" src="'+this.escapeExpression("function"==typeof(s=null!=(s=e.providerLogo||(null!=t?t.providerLogo:t))?s:e.helperMissing)?s.call(t,{name:"providerLogo",hash:{},data:i}):s)+'"><svg class="todo-menu-dropdown-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 34 32"><path d="M16,17H2a1,1,0,0,1,0-2H16a1,1,0,0,1,0,2Z"/><path d="M16,10H2A1,1,0,0,1,2,8H16a1,1,0,0,1,0,2Z"/><path d="M16,24H2a1,1,0,0,1,0-2H16a1,1,0,0,1,0,2Z"/><path d="M28.5,19.12a.87.87,0,0,1-.62-.26l-4.5-4.5a.88.88,0,0,1,1.24-1.24L28.5,17l3.88-3.88a.88.88,0,0,1,1.24,1.24l-4.5,4.5A.87.87,0,0,1,28.5,19.12Z"/></svg></span></div>\n'},6:function(t,e,o,i){return'\t<div class="icon-wrapper dropdown-toggle">\n\t\t<i class="icon icon-ellipsis"></i>\n\t</div>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(t,e,o,i){var s,n;return(null!=(s=e.if.call(t,null!=t?t.iClassName:t,{name:"if",hash:{},fn:this.program(1,i,0),inverse:this.program(3,i,0),data:i}))?s:"")+'<div class="dropdown '+this.escapeExpression("function"==typeof(n=null!=(n=e.dropdownClassName||(null!=t?t.dropdownClassName:t))?n:e.helperMissing)?n.call(t,{name:"dropdownClassName",hash:{},data:i}):n)+'">\n\t<ul class="dropdown-list"></ul>\n\t<ul class="dropdown-detail"></ul>\n</div>\n'},useData:!0}),x.templates["legacy-todo-complete"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(t,e,o,i){var s,n=e.helperMissing,d="function",a=this.escapeExpression;return'<span class="metric-stat">'+a(typeof(s=null!=(s=e.done||(null!=t?t.done:t))?s:n)===d?s.call(t,{name:"done",hash:{},data:i}):s)+'</span>\n<span class="metric-label">'+a(typeof(s=null!=(s=e.item||(null!=t?t.item:t))?s:n)===d?s.call(t,{name:"item",hash:{},data:i}):s)+" complete</span>"},useData:!0}),x.templates["legacy-todo-item"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(t,e,o,i){var s;return'<i class="control destroy">✕</i>\n<i class="loading-icon"></i>\n<i class="control error-icon">!</i>\n<label><input class="todo-item-checkbox" type="checkbox"></label><span class="todo-item-title" >'+this.escapeExpression("function"==typeof(s=null!=(s=e.title||(null!=t?t.title:t))?s:e.helperMissing)?s.call(t,{name:"title",hash:{},data:i}):s)+"</span>\n"},useData:!0}),x.templates["legacy-todo"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(t,e,o,i){return'\n        <div class="todo-header list-row">\n            <span class="todo-count active-list-container"><i class="loading-icon"></i>Loading...</span>\n\n            <div class="error-message">Connection required to add Todo</div>\n\n\t\t\t<div class="todo-actions">\n\t\t\t\t<div class="dropdown-container" id="todo-top-menu"></div>\n\t\t\t</div>\n        </div>\n        <div class="empty empty-todo">\n            <div class="content">\n                <div class="title">No todos yet</div>\n                <div class="description">Add a todo to get started</div>\n                <span class="button new-toggle">New Todo</span>\n            </div>\n        </div>\n        <ol class="todo-list"></ol>\n        <footer class="footer-input">\n            <input id="todo-new" class="todo-input todo-new" type="text" placeholder="New Todo">\n        </footer>\n\n'},useData:!0}),x.templates["todo-list-empty-state"]=Handlebars.template({1:function(t,e,o,i){var s,n=e.helperMissing,d="function",a=this.escapeExpression;return'\t\t<div class="description empty-link" data-target-list-id="'+a(typeof(s=null!=(s=e.targetListId||(null!=t?t.targetListId:t))?s:n)===d?s.call(t,{name:"targetListId",hash:{},data:i}):s)+'" data-use-command="'+a(typeof(s=null!=(s=e.use_command||(null!=t?t.use_command:t))?s:n)===d?s.call(t,{name:"use_command",hash:{},data:i}):s)+'">\n\t\t\t'+a(typeof(s=null!=(s=e.submessage||(null!=t?t.submessage:t))?s:n)===d?s.call(t,{name:"submessage",hash:{},data:i}):s)+'\n\t\t\t<i class="icon icon-angle-right"></i>\n\t\t</div>\n'},3:function(t,e,o,i){var s;return'\t\t<div class="description">\n\t\t\t'+this.escapeExpression("function"==typeof(s=null!=(s=e.submessage||(null!=t?t.submessage:t))?s:e.helperMissing)?s.call(t,{name:"submessage",hash:{},data:i}):s)+"\n\t\t</div>\n"},compiler:[6,">= 2.0.0-beta.1"],main:function(t,e,o,i){var s,n,d=e.helperMissing,a="function",r=this.escapeExpression;return'<li class="empty">\n\t<p class="title empty-title">'+r(typeof(n=null!=(n=e.message||(null!=t?t.message:t))?n:d)===a?n.call(t,{name:"message",hash:{},data:i}):n)+"</p>\n"+(null!=(s=e.if.call(t,null!=t?t.subMessageClickable:t,{name:"if",hash:{},fn:this.program(1,i,0),inverse:this.program(3,i,0),data:i}))?s:"")+'\t<button class="button new-todo-button">New '+r(typeof(n=null!=(n=e.listType||(null!=t?t.listType:t))?n:d)===a?n.call(t,{name:"listType",hash:{},data:i}):n)+"</button>\n</li>\n"},useData:!0}),x.templates.todoitem=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(t,e,o,i){var s;return'<span class="todo-item-wrapper">\n\t<div class="dropdown-container">\n\t</div>\n\n\t<i class="loading-icon"></i>\n\t<i class="control error-icon" title="Error saving click to retry">!</i>\n\n\t<label><input class="todo-item-checkbox" type="checkbox"></label>\n\t<span class="todo-item-title" >'+this.escapeExpression("function"==typeof(s=null!=(s=e.title||(null!=t?t.title:t))?s:e.helperMissing)?s.call(t,{name:"title",hash:{},data:i}):s)+"</span>\n</span>\n"},useData:!0}),x.templates.todolistactive=Handlebars.template({1:function(t,e,o,i){var s;return'\t\t<div class="project-chooser todo-provider-wrapper '+(null!=(s=e.unless.call(t,null!=t?t.supportLists:t,{name:"unless",hash:{},fn:this.program(2,i,0),inverse:this.noop,data:i}))?s:"")+'">\n\t\t<div class="project-chooser-toggle"></div>\n\t\t<div class="project-chooser-dropdown"></div>\n\t</div>\n'},2:function(t,e,o,i){return"has-icon"},4:function(t,e,o,i){var s;return'<img class="provider-icon" src="'+this.escapeExpression("function"==typeof(s=null!=(s=e.providerLogo||(null!=t?t.providerLogo:t))?s:e.helperMissing)?s.call(t,{name:"providerLogo",hash:{},data:i}):s)+'">'},6:function(t,e,o,i){return"no-caps"},8:function(t,e,o,i){var s;return'<div class="message todo-message"><span class="title">'+this.escapeExpression("function"==typeof(s=null!=(s=e.statusMessage||(null!=t?t.statusMessage:t))?s:e.helperMissing)?s.call(t,{name:"statusMessage",hash:{},data:i}):s)+"</span>"},10:function(t,e,o,i){var s,n=e.helperMissing,d="function",a=this.escapeExpression;return'<span class="action" id="status-action" data-action="'+a(typeof(s=null!=(s=e.action||(null!=t?t.action:t))?s:n)===d?s.call(t,{name:"action",hash:{},data:i}):s)+'">'+a(typeof(s=null!=(s=e.actionMessage||(null!=t?t.actionMessage:t))?s:n)===d?s.call(t,{name:"actionMessage",hash:{},data:i}):s)+"</span></div>"},compiler:[6,">= 2.0.0-beta.1"],main:function(t,e,o,i){var s,n,d=e.helperMissing,a="function",r=this.escapeExpression;return'<div class="list-row">\n\t<div class="list-color" style="background-color: '+r(typeof(n=null!=(n=e.color||(null!=t?t.color:t))?n:d)===a?n.call(t,{name:"color",hash:{},data:i}):n)+'"></div>\n\n'+(null!=(s=e.if.call(t,null!=t?t.supportProjects:t,{name:"if",hash:{},fn:this.program(1,i,0),inverse:this.noop,data:i}))?s:"")+'\n\t<div class="active-list-container has-icon">\x3c!--\n\t\t--\x3e'+(null!=(s=e.unless.call(t,null!=t?t.supportProjects:t,{name:"unless",hash:{},fn:this.program(4,i,0),inverse:this.noop,data:i}))?s:"")+'\n\t\t<span class="list-name active-list-name '+(null!=(s=e.if.call(t,null!=t?t.no_caps:t,{name:"if",hash:{},fn:this.program(6,i,0),inverse:this.noop,data:i}))?s:"")+'" title='+r(typeof(n=null!=(n=e.listTitle||(null!=t?t.listTitle:t))?n:d)===a?n.call(t,{name:"listTitle",hash:{},data:i}):n)+">"+r(typeof(n=null!=(n=e.listTitle||(null!=t?t.listTitle:t))?n:d)===a?n.call(t,{name:"listTitle",hash:{},data:i}):n)+'</span>\x3c!--\n\t\t--\x3e<div class="list-chooser-toggle icon-wrapper"><i class="icon icon-angle-down"></i></div>\n\t\t<ul class="u--bg dropdown list-chooser nipple-top-left"></ul>\n\t</div>\n\n\t<div class="todo-actions">\n\t\t<div class="dropdown-container" id="todo-top-menu"></div>\n\t</div>\n</div>\n\n'+(null!=(s=e.if.call(t,null!=t?t.statusMessage:t,{name:"if",hash:{},fn:this.program(8,i,0),inverse:this.noop,data:i}))?s:"")+"\n"+(null!=(s=e.if.call(t,null!=t?t.actionMessage:t,{name:"if",hash:{},fn:this.program(10,i,0),inverse:this.noop,data:i}))?s:"")+"\n"},useData:!0}),x.templates.todolistchoice=Handlebars.template({1:function(t,e,o,i){var s,n=e.helperMissing,d="function",a=this.escapeExpression;return'\t<li class="'+a(typeof(s=null!=(s=e.class||(null!=t?t.class:t))?s:n)===d?s.call(t,{name:"class",hash:{},data:i}):s)+'" data-list-id="'+a(typeof(s=null!=(s=e.listId||(null!=t?t.listId:t))?s:n)===d?s.call(t,{name:"listId",hash:{},data:i}):s)+'">\n\t\t<div class="list-color" style="background-color: '+a(typeof(s=null!=(s=e.color||(null!=t?t.color:t))?s:n)===d?s.call(t,{name:"color",hash:{},data:i}):s)+'">&nbsp;</div>'+a(typeof(s=null!=(s=e.parentTitle||(null!=t?t.parentTitle:t))?s:n)===d?s.call(t,{name:"parentTitle",hash:{},data:i}):s)+"\n\t</li>\n"},3:function(t,e,o,i){return"todo-list-section"},5:function(t,e,o,i){var s;return'<div class="list-color" style="background-color: '+this.escapeExpression("function"==typeof(s=null!=(s=e.color||(null!=t?t.color:t))?s:e.helperMissing)?s.call(t,{name:"color",hash:{},data:i}):s)+'">&nbsp;</div>'},compiler:[6,">= 2.0.0-beta.1"],main:function(t,e,o,i){var s,n,d=e.helperMissing,a="function",r=this.escapeExpression;return(null!=(s=e.if.call(t,null!=t?t.parentTitle:t,{name:"if",hash:{},fn:this.program(1,i,0),inverse:this.noop,data:i}))?s:"")+'<li class="'+r(typeof(n=null!=(n=e.class||(null!=t?t.class:t))?n:d)===a?n.call(t,{name:"class",hash:{},data:i}):n)+" "+(null!=(s=e.if.call(t,null!=t?t.hasParent:t,{name:"if",hash:{},fn:this.program(3,i,0),inverse:this.noop,data:i}))?s:"")+'" data-list-id="'+r(typeof(n=null!=(n=e.listId||(null!=t?t.listId:t))?n:d)===a?n.call(t,{name:"listId",hash:{},data:i}):n)+'">\n\t'+(null!=(s=e.unless.call(t,null!=t?t.hasParent:t,{name:"unless",hash:{},fn:this.program(5,i,0),inverse:this.noop,data:i}))?s:"")+'\n\t<span class="list-name">'+r(typeof(n=null!=(n=e.title||(null!=t?t.title:t))?n:d)===a?n.call(t,{name:"title",hash:{},data:i}):n)+'</span>\n\t<span class="todo-count">'+r(typeof(n=null!=(n=e.count||(null!=t?t.count:t))?n:d)===a?n.call(t,{name:"count",hash:{},data:i}):n)+"</span>\n</li>\n"},useData:!0}),x.templates.todopane=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(t,e,o,i){return'\n\t\t<div class="drop-zone drop-left-zone">\n\t\t\t<span class="u--bg bar left-bar">\n\t\t\t\t<span class="bar-name"></span>\n\t\t\t</span>\n\t\t</div>\n\n\t\t<div class="drop-zone drop-right-zone">\n\t\t\t<span class="u--bg bar right-bar">\n\t\t\t\t<span class="bar-name"></span>\n\t\t\t</span>\n\t\t</div>\n\n\t\t<header class="header todo-header">\n\t\t\t<div class="active-list">\n\t\t\t\t\x3c!-- Seems like this is all getting replaced with todolistactive.hbs? --\x3e\n\t\t\t\t\x3c!-- <li><span class="todo-list-name"></span><span class="todo-count active-todo-count"></span></li> --\x3e\n\t\t\t</div>\n\t\t</header>\n\n\t\t<div class="todo-list-wrapper">\n\t\t\t<ol class="todo-list animating"></ol>\n\t\t</div>\n\n\t\t<footer class="footer-input new-todo-footer">\n\t\t\t<input id="todo-new" class="todo-input todo-new" type="text" placeholder="New Todo">\n\t\t</footer>\n\n'},useData:!0}),x.styles=x.styles||{},x.styles.style=function(){var t=document.createElement("style");t.type="text/css",t.innerHTML='.todo-action,.todo-header .dropdown-list-icon{float:left}.todo{text-align:right;text-shadow:none}.todo .app-container{position:relative}.todo .todo-app{height:auto;width:320px;padding:0;position:absolute;display:block;opacity:1;overflow-y:hidden;text-align:left;transition:all .2s ease-out;transition-property:opacity,height}.todo-app.animating::-webkit-scrollbar-thumb{background-color:rgba(255,255,255,0)!important}.todo .drop-zone{width:37px;position:absolute;top:4px;bottom:4px;z-index:10000;font-size:14px;opacity:0;transition:all .3s ease-out;visibility:hidden;writing-mode:vertical-rl}.todo .bar,.todo .bar:before{position:absolute;top:0;bottom:0;right:0;left:0}.todo .drop-left-zone{left:0}.todo .drop-right-zone{right:0}.todo .has-drop-left .drop-left-zone,.todo .has-drop-right .drop-right-zone{opacity:1;visibility:visible}.todo .bar{padding-top:12px;text-align:left;transition:all .2s ease;box-shadow:0 0 10px rgba(0,0,0,.125)}.todo .bar:before{z-index:-1;background:rgba(255,255,255,.275);content:""}.todo .bar-name,.todo .dropdown-wrapper{position:relative}.todo .hover .bar:before{background:rgba(255,255,255,.525)}.light .todo .bar:before{background:rgba(0,0,0,.17)}.light .todo .hover .bar:before{background:rgba(0,0,0,.21)}.todo .drop-zone.hover .bar{transform:translateX(0)}.todo .bar-name{font-weight:500;line-height:37px;text-transform:capitalize;transform:scale(0);transition:all .2s ease}.todo .drop-zone.hover .bar-name{transform:scale(1)}.todo .left-bar{transform:translateX(-37px);overflow:hidden}.todo .left-bar,.todo .left-bar:before{border-radius:0 var(--border-radius) var(--border-radius) 0}.todo .has-drop-left .left-bar{transform:translateX(-29px)}.todo .right-bar{transform:translateX(37px);overflow:hidden}.todo .right-bar,.todo .right-bar:before{border-radius:var(--border-radius) 0 0 var(--border-radius)}.todo .dropdown,.todo .dropdown:before,.todo .project-chooser-toggle{border-radius:var(--border-radius)}.todo .has-drop-right .right-bar{transform:translateX(29px)}.todo .dropdown{display:none;position:absolute;z-index:10;box-shadow:0 1px 3px transparent}.light .todo .dropdown{box-shadow:0 1px 5px rgba(0,0,0,.25)}.todo .dropdown li{max-width:280px;cursor:pointer;transition:all 0s ease}.todo .dropdown-list-icon{max-height:14px;margin-right:5px;vertical-align:top}.todo .dropdown .loading{margin:2px 0;text-align:center;opacity:.7!important}.todo .dropdown .loading:hover{background:0 0}.todo-header{--header-height:47px;min-height:var(--header-height);position:relative;z-index:2;display:block;cursor:pointer!important}.todo .list-row{height:var(--header-height);position:relative;display:flex}.list-color{width:5px;position:absolute;top:5px;bottom:5px;left:0;display:inline}.todo .list-row>.list-color{top:8px;bottom:4px}.todo .provider-icon{height:16px;width:16px;padding-right:9px}.momentum-todo .provider-icon{display:none}.light .dropdown-list-icon.GitHub,.light .provider-list li img.GitHub,.light .provider-logo.GitHub,.light .todo-GitHub .provider-icon{filter:brightness(13%)}.todo .project-chooser{--left-margin:-8px;margin-right:calc(var(--app-padding) * -1);padding-left:var(--app-padding);flex:0 0 auto;display:flex;align-items:center;z-index:5}.todo .project-chooser-toggle{height:var(--chooser-height);margin:2px 5px 0 var(--left-margin);padding:8px 5px 4px 7px;position:relative;display:inline-block;background:rgba(255,255,255,0);cursor:pointer}.todo .project-chooser .icon-wrapper{padding:0;display:block}.todo .project-chooser .icon-wrapper:after{height:auto;width:auto;top:0;right:0;bottom:0;left:0;border-radius:var(--border-radius)}.todo .project-chooser .provider-icon{padding-right:1px}.todo .project-chooser .todo-menu-dropdown-icon{height:16px;width:17px;margin-left:3px;display:inline-block;cursor:pointer;fill:#fff;opacity:.5}.light .todo .project-chooser .todo-menu-dropdown-icon,.light .todo .project-chooser:hover .todo-menu-dropdown-icon{fill:#000}.todo-provider-wrapper:hover .todo-menu-dropdown-icon{opacity:.8}.project-chooser.active .todo-menu-dropdown-icon{opacity:.6}.todo .project-chooser-dropdown{margin-top:4px;margin-left:var(--left-margin);min-width:230px;top:100%;z-index:100;transition:transform .15s ease}.todo .project-chooser-dropdown .dropdown-list{max-height:209px;overflow:hidden;overflow-y:auto}.todo .project-chooser-dropdown.short-list li:last-child{margin-bottom:20px}.todo .project-chooser-dropdown li:last-child{margin-bottom:4px}.todo-header .project-chooser-dropdown .dropdown-list.available-empty{height:200px}.todo-header .project-chooser-dropdown .available-empty li:last-child{margin-bottom:20px}.todo-header .project-chooser-dropdown li{padding-top:5px;padding-bottom:5px}.todo-header .project-chooser-dropdown .provider-name{margin:4px 0 -1px;cursor:default;font-weight:600;opacity:.85}.todo-header .project-chooser-dropdown .section-title{padding-top:6px;padding-bottom:4px;font-weight:500;font-size:71.42857%;text-transform:uppercase;cursor:default;opacity:.5}.project-chooser-dropdown .provider-name:hover,.project-chooser-dropdown .section-title:hover{background:0 0!important}.todo-header .project-chooser-dropdown .active-item.highlighted{background:rgba(255,255,255,.15)}.light .todo-header .project-chooser-dropdown .active-item.highlighted{background:rgba(0,0,0,.05)}.todo-header .project-chooser-dropdown .loading-dropdown{text-align:center;opacity:.5}.todo .active-list-container{padding-top:4px;padding-left:var(--app-padding);flex:1 1 auto;display:inline-flex;align-items:center;transition:all .2s ease}.todo .active-list-name{max-width:208px;font-size:19px;overflow:hidden;text-overflow:ellipsis;text-transform:capitalize;white-space:nowrap}.todo .active-list-name.no-caps{text-transform:none}.todo .momentum-todo .active-list-name{max-width:236px}.todo .has-projects .active-list-name{max-width:213px}.todo .has-lists .active-list-name{max-width:212px}.todo .list-chooser-toggle{margin-left:7px;padding:0}.todo .list-chooser-toggle:after{height:21px;width:21px}.todo .list-chooser-toggle .icon{font-size:17px}.todo .list-chooser{margin-left:-4px;padding:4px 0;position:absolute;top:var(--header-height);z-index:11;display:none;box-shadow:rgba(0,0,0,.15) 0 2px 2px}.todo .list-chooser li{--padding-v:7px;--padding-h:16px;min-width:240px;padding:var(--padding-v) var(--padding-h);position:relative;box-sizing:border-box;font-size:93.75%;line-height:normal;white-space:nowrap}.todo .list-chooser li:hover{background:rgba(255,255,255,.1)}.light .todo .list-chooser li:hover{background:rgba(255,255,255,.6)}.list-chooser .todo-list-section{padding-left:30px}.list-chooser .list-color{top:1px;bottom:1px}.list-chooser .list-name{opacity:.7;line-height:1.2;white-space:initial}.todo-list-choice-active .list-name{font-weight:500;opacity:1}.list-chooser .todo-count{margin-left:3px;opacity:.45;font-size:93.33333%}.list-chooser .todo-list-add-row{max-width:none!important;padding:0!important}.todo .todo-list-add-input,.todo-list-add-loading{padding:var(--padding-v) var(--padding-h);line-height:normal}.todo .todo-list-add-input{width:100%;opacity:.7;border-bottom:none;cursor:pointer}.todo .input-mode .todo-list-add-input{cursor:text}.todo-list-add-icon{position:absolute;top:var(--padding-v);left:calc(var(--padding-h) - 1px);opacity:.7}.todo-list-add-icon .icon-plus{font-size:14px;opacity:.6375}.todo-actions{flex:0 0 auto}.todo-actions .dropdown-container{height:100%}.todo-actions .icon-wrapper{height:100%;padding:4px 17px 0 5px;position:relative;display:flex;align-items:center;box-sizing:border-box;cursor:pointer}.todo-actions .icon-wrapper:after{height:26px;width:26px;padding-top:2px}.todo-actions .icon{font-size:15px}.todo-actions-dropdown{min-width:auto;margin-top:var(--top-drop);right:7px;bottom:auto}.todo-actions-dropdown ul{margin:4px 0}.light .todo-header .dropdown .header{border-bottom:1px solid #eee}.todo-actions-dropdown li{padding:6px 12px}.todo-action .icon{height:12px;width:12px;opacity:.35}.todo-action.active .icon{opacity:1}.todo-action .icon-external{padding:2px 0 0 1px;opacity:.35}.todo-action .icon-autofocus{height:9px;width:9px;padding-left:2px;vertical-align:5%}.todo-action .icon-assigned{height:14px;width:14px;vertical-align:-13%}.todo-action .icon-subtasks{vertical-align:-7%}.todo-action .icon-archive{height:13px;width:13px;vertical-align:-4%}.todo-header .dropdown-list-label{margin-left:21px;display:block}.no-icon .dropdown-list-label{margin-left:0}.todo-list-wrapper{width:100%;position:relative;z-index:1;overflow:hidden;transition:max-height .3s ease,min-height .3s ease}.todo-list{width:100%;overflow-x:hidden;overflow-y:auto;transition:opacity .2s ease}.todo-list.animating::-webkit-scrollbar-thumb{background-color:rgba(255,255,255,0)!important}.todo-list.dragging{margin:-30px 0 0;padding:30px 0 0}.todo-list.drop-top-margin{margin-top:-52px}.todo-list.hide-scroll{overflow-y:hidden}.todo-list.drop-area{padding:10px 0}.todo-list .placeholder{padding:0}.todo-item{position:relative;display:none;visibility:hidden;opacity:0;font-size:93.75%;line-height:1.266667}.todo-item.visible{width:100%;display:inline-block;visibility:visible;opacity:1}.todo .is-empty .todo-list,.todo-legacy.is-empty .footer-input{visibility:hidden}.todo-item.hidden{display:none}.todo-item.transition{transition:visibility 0s,opacity .4s ease,margin-top .4s ease}.todo-item.drop-area{padding:8px 0}.todo-item-wrapper{padding:3px 0 2px;display:block}.todo-item label{padding-left:var(--app-padding);padding-right:5px;position:relative;top:-1px;left:0;z-index:10;float:left;font-size:100%;opacity:1}.todo-item input{width:auto}.todo-item-title{margin:0 40px;display:block;cursor:default;opacity:.96;outline:0;word-wrap:break-word}.editing>.todo-item-wrapper .todo-item-title{opacity:.7;outline:0}.done>.todo-item-wrapper .todo-item-title{opacity:.5;text-decoration:line-through}.done-list .todo-item-title{opacity:.6;text-decoration:none}.todo-item .dropdown-container{float:right}.todo-item .dropdown-toggle{margin:-3px 0;padding:0 18px 0 0;position:relative;top:0;right:0;z-index:2}.todo-item-wrapper:hover .dropdown-toggle{opacity:.525}.editing .dropdown-container,.todo-item .icon-wrapper{opacity:0}.todo-item-dropdown{top:20px;right:7px;bottom:auto}.todo-item-dropdown ul{margin:4px 0}.todo-item-dropdown li{padding:4px 14px;position:relative;font-size:93.33333%;line-height:1.285714}.todo-item-dropdown .list-color{margin:0;top:1px;bottom:1px}.todo-item .icon-wrapper:after{height:23px;width:23px}.todo-item .icon-ellipsis{padding-top:1px}.todo-item .active .icon-wrapper,.todo-item-wrapper:hover .icon-wrapper{opacity:1}.todo-item-active>.todo-item-wrapper{display:block;background-color:rgba(255,255,255,.06);box-shadow:0 0 0 2px rgba(255,255,255,.06)}.light .todo-item-active>.todo-item-wrapper{background-color:rgba(0,0,0,.03);box-shadow:0 0 0 2px rgba(0,0,0,.03)}.todo-item .control{height:12px;width:12px;right:0;position:absolute;border-radius:100%;cursor:pointer;line-height:12px;text-align:center}.todo-item .error-icon,.todo-item .loading-icon{position:absolute;top:6px;display:none}.todo-item .failed>.todo-item-wrapper .error-icon,.todo-item .loading>.todo-item-wrapper .loading-icon{display:inline-block}.todo-item .failed .destroy,.todo-item .failed .dropdown-container,.todo-item .loading .destroy,.todo-item .loading .dropdown-container,.todo-subsection .todo-item-checkbox{display:none}.todo-item .loading-icon{height:10px;width:10px;right:6px;border-width:1px}.todo-item .error-icon{top:4px;right:13px}.todo-section{margin:0;padding:12px 15px 6px;font-size:11px;font-weight:500;opacity:.75;text-transform:uppercase;cursor:pointer}.todo-list .todo-section:first-child{padding-top:5px}.todo-section-collapsible:active,.todo-section-collapsible:hover{opacity:1}.todo-section .icon-tick{height:7px;width:14px;margin-left:1px;fill:#fff;opacity:.5;vertical-align:10%}.light .todo-section .icon-tick{fill:#222}.todo-section-collapsed .icon-tick{transform:rotate(-90deg);vertical-align:4%;-webkit-backface-visibility:hidden}.todo-section-collapsible:hover .icon-tick{opacity:.85}.todo-subsection{cursor:default}.todo-subsection .todo-item-title{margin-left:16px;margin-bottom:-2px;font-size:13px;opacity:.7}.todo-load-more{padding:8px 15px 4px;text-align:center}.todo-load-more .todo-load-more-button{padding:7px 21px;border-radius:100px;font-size:12px;transition:opacity .2s ease!important}.todo-load-more .loading{height:28px;position:relative;display:block;line-height:25px}.todo-load-more .loading .loading-icon{margin-right:6px;position:relative;top:-2px;left:2px;right:auto}.todo-load-more .loading .loading-title{font-size:12px;opacity:.9}.todo-load-more .todo-load-more-done{height:28px;font-size:12px;line-height:25px;opacity:.9;transition:opacity .2s ease!important}.todo .empty .empty-link,.todo-list .empty .new-todo-button{transition:opacity .3s ease}.todo-list .info{margin-bottom:8px;padding:5px 15px;position:relative;background:#333;color:#ccc}.todo-list .info-hide{height:29px;width:29px;min-width:0;padding:0!important;position:absolute;top:0;right:0;font-size:70%;line-height:29px;opacity:.5;text-align:center}.todo-list .info-title{margin:0 0 1px;font-size:90%}.todo-list .info-description{margin:0;font-size:85%;line-height:120%;opacity:.5}.todo-list .info-action{margin:-3px -15px -5px;padding:5px 15px!important;font-size:80%;opacity:.8}.todo .empty .empty-title{padding:0;cursor:default;opacity:.7}.todo .empty .empty-link{display:inline-block;cursor:pointer}.todo .empty-link .icon{margin-left:3px;font-size:16px;line-height:1;vertical-align:-5%}.todo-list .empty .empty-link:hover{opacity:.8}.todo-item ol{margin-left:18px}.todo .footer-input{display:flex;justify-content:space-between;align-items:center;position:static}.todo .is-empty .todo-app{overflow:hidden}.todo .is-empty .todo-new{position:absolute;bottom:0}.todo .is-empty .empty{display:flex}.todo-legacy .empty-todo{display:none}.todo-legacy .empty-todo .content{margin-top:-20px}.todo-legacy .todo-header{--header-height:39px;cursor:default!important}.todo-legacy .todo-header .active-list-container{font-size:14px;font-weight:600;text-transform:uppercase}.todo-legacy .todo-count{opacity:.75}.todo-legacy .todo-item label{display:inline-block}.todo-legacy .todo-item-title{margin:0 39px}.todo-legacy .done .todo-item-title{opacity:.5;text-decoration:line-through}.todo-legacy .todo-item{padding:3px 0 2px;font-size:100%;display:inline-block;width:100%;visibility:visible;opacity:1}.todo-legacy .editing .todo-item-title{opacity:.7}.todo-legacy .todo-item .destroy{padding:3px;top:3px;right:14px;border:1px solid rgba(255,255,255,0);cursor:pointer;font-size:10px;opacity:0;transition:all .2s ease}.todo-legacy .todo-item:hover .destroy{opacity:.5}.todo-legacy .todo-item .destroy:hover{border:1px solid rgba(255,255,255,.5)!important;opacity:1!important}.todo-legacy .show-completed{margin-top:8px;padding:4px 15px;display:block;cursor:pointer;font-size:75%;opacity:.5}',document.getElementsByTagName("head")[0].appendChild(t)},x.models.legacy=x.models.legacy||{},x.collect.legacy=x.collect.legacy||{},x.views.legacy=x.views.legacy||{},x.models.legacy.TodoBase=Backbone.Model.extend({isTrue:function(t){var e=this.get(t);return void 0!==e&&1==e},saveOptions:function(){return this.collection.saveOptions},getValue:function(t){var e=null;return this.attemptedSaveValues&&this.attemptedSaveValues.hasOwnProperty(t)&&(e=this.attemptedSaveValues[t]),e||(e=this.get(t)),e}}),x.models.legacy.Todo=x.models.legacy.TodoBase.extend({defaults:function(){return{title:"empty todo...",done:!1,archive:!1,order:0,createdDate:new Date,archivedDate:null,completedDate:null,deleted:!1,deletedDate:null}},archive:function(){this.save({archive:!0,archivedDate:new Date},this.saveOptions())},comparator:"order"}),x.models.legacy.TodoProxy=x.models.legacy.TodoBase.extend({defaults:function(){return{done:!1,isProxy:!0,isLoading:!0,saveFailed:!1,proxyValid:!0}}}),x.collect.legacy.TodosBase=Backbone.Collection.extend({saveOptions:{},initialize:function(){this.model=x.models.legacy.Todo,this.loadingFromServer=!0,localStorage.showTodoList||(localStorage.showTodoList=!1),this.listenTo(C,"newDay",this.onNewDay),this.listenTo(this,"reset",this.onReset),this.listenTo(this,"add remove change",this.collectionChanged),this.listenTo(this,"reorder",this.reorderItem)},onReset:function(){this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged")},onNewDay:function(){this.loadingFromServer=!0,this.fetch({reset:!0})},onLoadingFromServerChanged:function(){},clearCompleted:function(){},collectionChanged:function(t){localStorage.setItem("todos-updated",new Date),this.onCollectionChanged(t)},onCollectionChanged:function(t){},completeToday:function(){return this.where({done:!0,archive:!1,deleted:!1})},completedCount:function(){return this.completeToday().length},activeToday:function(){return this.where({archive:!1,deleted:!1})},done:function(){return this.where({done:!0})},deleted:function(){return this.where({deleted:!0})},remaining:function(){return this.where({archive:!1,deleted:!1,done:!1})},nextOrder:function(){return this.length?this.last().get("order")+100:100},comparator:"order",create:function(t,e){return null==t.order&&(t.order=this.nextOrder()),Backbone.Collection.prototype.create.call(this,t,e)},reorderItem:function(t){},hasValidCachedCompletedCount:function(){return!0}}),x.collect.legacy.Todos=x.collect.legacy.TodosBase.extend({url:C.globals.urlRoot+"todos",previousCount:-1,saveOptions:{patch:!0},reorderItem:function(t){var e={operations:[{REORDER:{move_id:t.move_id,move_target_id:t.move_target_id,move_offset:t.move_offset}}]};y.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(e),beforeSend:setMomentumAuthHeader,url:C.globals.urlRootApi+"todos"}).done(function(t){}).fail(function(t,e){})},onLoadingFromServerChanged:function(){this.saveCachedCompletedCount()},onCollectionChanged:function(t){this.saveCachedCompletedCount()},completedCount:function(){return this.loadingFromServer?this.cachedCompletedCount():this.completeToday().length},saveCachedCompletedCount:function(){if(!this.loadingFromServer){var t=this.completeToday().length,e=getActiveDateString();localStorage.cachedCompletedCount=JSON.stringify({count:t,forDate:e}),t!=this.previousCount&&(this.previousCount=t,this.trigger("completedCountChanged"))}},cachedCompletedCount:function(){if(localStorage.cachedCompletedCount){var t=JSON.parse(localStorage.cachedCompletedCount),e=getActiveDateString();if(t&&t.forDate===e)return t.count}return 0},hasValidCachedCompletedCount:function(){if(localStorage.cachedCompletedCount){var t=JSON.parse(localStorage.cachedCompletedCount),e=getActiveDateString();if(t&&t.forDate===e)return!0}return!1},parse:function(t){return t.items?t.items:t}}),x.collect.legacy.TodosLegacy=x.collect.legacy.TodosBase.extend({localStorage:new Backbone.LocalStorage("momentum-todo"),isLegacy:!0,createOrderGaps:function(){var e=100;this.each(function(t){t.save({order:e},{silent:!0}),e+=100})},clearCompleted:function(){var i=!1,t=this.completeToday();_.each(t,function(t){var e=t.get("completedDate");if(e){var o=Date.parse(e);activeDateStringForDate(o)!=getActiveDateString()&&(t.archive(),i=!0)}}),i&&this.trigger("reset")},reorderItem:function(t){var e=this.get(t.move_id),o=this.get(t.move_target_id),i=0<t.move_offset?1:-1,s=this.indexOf(o),n=1;if(0<=s+i&&s+i<this.length){var d=this.at(s+i);(n=Math.abs(d.get("order")-o.get("order")))<=20&&(this.createOrderGaps(),n=Math.abs(d.get("order")-o.get("order")))}var a=o.get("order")+Math.ceil(n/2)*i;e.save({order:a},{silent:!0})}}),x.views.legacy.Todos=Backbone.View.extend({attributes:{id:"todo",class:"app-container todo"},template:x.templates["legacy-todo"],offline:!0,initialFetchStarted:!1,renderedOnce:!1,loadedOnce:!1,events:{"click .todo-list-active":"openList","click .todo-list-chooser-dropdown":"chooseList","click .todo-toggle":"toggleShow","click .show-completed":"showCompleted","click .retry":"onClickRetry","click #clear-completed":"clearCompleted","click .new-toggle":"showInput","keyup #todo-new":"handleInput",dragover:"dragover",dragend:"dragend",drop:"drop"},initialize:function(){this.subViews=[],(x.views.todoPane=this).proxyCollection=new Backbone.Collection({model:x.models.legacy.TodoProxy}),this.show_completed=!1,_.bindAll(this,"addOne","addAll","dragover","dragend","li_index"),this.render(),this.listenTo(C,"globalEvent:esc",this.hide),this.listenTo(C,"globalEvent:toggleTodo",this.toggleShow),this.listenTo(C,"globalEvent:window:resize",this.setMaxWidgetHeight),this.listenTo(this,"connectionOnline",this.connectionOnline),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.proxyCollection,"add",this.addOne),this.listenTo(this.collection,"reset",this.collectionReset),this.listenTo(this.collection,"request",this.collectionRequest),this.listenTo(this.collection,"change",this.collectionModelChanged),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(C.models.customization,"change:todoVisible",this.visibleChanged),this.listenTo(C,"todolist:updateHeight",this.updateHeight),this.collection.isLegacy||C.conditionalFeatures.featureEnabled("prefetchtodos")?this.doFetchIfNeeded():this.collection.hasValidCachedCompletedCount()||this.doFetchIfNeeded(),1==JSON.parse(localStorage.showTodoList)&&(this.showPopup(),this.doFetchIfNeeded()),setTimeout(function(){try{if(C.conditionalFeatures.featureEnabled("plus")&&!localStorage.plus_first_load&&(localStorage.plus_first_load=!0,x.views.legacy.todos))try{x.views.legacy.todos.$el.hide(),x.views.legacy.todos.undelegateEvents(),x.views.legacy.todos.$el.removeData().unbind(),x.views.legacy.todos.remove(),Backbone.View.prototype.remove.call(x.views.legacy.todos)}catch(t){}}catch(t){}},500)},render:function(){if(!this.renderedOnce){this.$el.hasClass("app")&&(this.$el.css("height","auto"),this.$el=this.$el.closest(".todo")),this.$(".app").html(this.template()),this.$(".app").addClass("todo-legacy"),this.$placeholder=y("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.updateTodoCount(),this.renderedOnce=!0;var t=[];t.push({checkStateCmd:"todo.list.check.state.autofocus",commandId:"todo.toggle.autofocus",captionText:"Autofocus",todoIcon:'<span class="todo-action"><svg class="icon icon-autofocus" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 124.512 124.512" class="icon icon-autofocus"><path d="M113.956 57.006l-97.4-56.2c-4-2.3-9 .6-9 5.2v112.5c0 4.6 5 7.5 9 5.2l97.4-56.2c4-2.401 4-8.2 0-10.5z"/></svg></span>',toolTip:"Automatically set top todo as focus"}),t.push({css_class:"line"}),t.push({commandId:"todo.switch.feed",captionText:"Switch to...",css_class:"no-icon"}),t.push({commandId:"todo.show.settings",captionText:"Settings",css_class:"no-icon"});var e=y(this.$el.find("#todo-top-menu")[0]);this.topMenuDropdownView&&this.lastProvider==this.model.activeProvider?this.topMenuDropdownView.attachMenuItems(e,t):(this.topMenuDropdownView&&(this.topMenuDropdownView.unbind(),this.topMenuDropdownView.remove()),this.topMenuDropdownView=new x.views.TodoDropdownMenu({el:e,iClassName:"icon-cog",dropdownClassName:"todo-actions-dropdown",menuItems:new Backbone.Collection(t),model:null,parentContext:null})),this.topMenuDropdownView.render(),this.setMaxWidgetHeight(),this.visibleChanged()}return this},showUpsell:function(t){if(this.upsellView)this.upsellView.options=t,this.upsellView.render();else{t.template=C.templates.upsell.appupsell,this.upsellView=new C.views.upsell.message(t);var e=this.upsellView.render().$el;this.$el.find(".app").append(e)}this.upsellView.show()},visibleChanged:function(){C.models.customization.getComputedSetting("todoVisible")?this.renderedOnce?this.$el.mFadeIn():this.render():this.$el.mFadeOut()},setMaxWidgetHeight:function(){var t=y(window).height()-125,e=y(".todo-app");if(e.css("max-height",t),e){var o=e.find(".todo-header").outerHeight(),i=e.find(".todo-message").outerHeight(!0),s=e.find(".todo-new").outerHeight();0==o&&(o=34),null==i&&(i=0),0==s&&(s=39),e.find(".todo-list").css("max-height",t-(o+i+s))}return t},connectionOnline:function(){this.retryConnection()},doFetch:function(){this.initialFetchStarted=!0,this.collection.fetch({reset:!0})},doFetchIfNeeded:function(){if(!this.initialFetchStarted&&(this.doFetch(),C.conditionalFeatures.featureEnabled("localtodonotify"))){var e=this;window.addEventListener("storage",function(t){if(t.key&&0===t.key.indexOf("todos-updated")){if(e.fetching)return;e.fetching=!0,e.collection.fetch({success:function(){e.fetching=!1},error:function(){e.fetching=!1},reset:!0})}},!1)}},initializeGreetings:function(t){localStorage.greetings&&((t=JSON.parse(atob(localStorage.greetings)).todo)&&(t.none&&(this.emptyTodoGreetings=t.none),t.completed&&(this.completedTodoGreetings=t.completed)));this.emptyTodoGreetings||(this.emptyTodoGreetings=[{caption:"Nothing to do",message:"Add a todo to get started, "}])},randomEmptyTodoGreetings:function(){if(this.initializeGreetings(),!this.emptyTodoGreeting){var t=Math.floor(Math.random()*this.emptyTodoGreetings.length);this.emptyTodoGreeting=this.emptyTodoGreetings.splice(t,1)[0]}return this.emptyTodoGreeting},addOne:function(t){var e=new x.views.legacy.Todo({model:t,parent:this});this.subViews.push(e),this.$(".todo-list").append(e.render().el),this.$el.find("#todo-new")[0].scrollIntoView(!1)},addAll:function(){_.each(this.subViews,function(t){t&&t.destroy()}),this.subViews=[],this.$(".todo-list").html(""),_.each(this.collection.activeToday(),this.addOne),_.each(this.proxyCollection.where({proxyValid:!0}),this.addOne),this.successfulConnection(),this.setMaxWidgetHeight()},displayConnectingText:function(t,e){t&&(this.connectingTextOverride=t),this.$el.find(".todo-count").html(this.connectingTextOverride?this.connectingTextOverride:'<i class="loading-icon"></i>Loading...'),this.$el.find(".todo-count").fadeIn(500)},collectionReset:function(){this.loadedOnce=!0,this.render(),this.addAll()},collectionRequest:function(t){this.loadedOnce||this.displayConnectingText('<i class="loading-icon"></i>Loading...')},collectionError:function(t,e,o){200!==e.status?this.failedConnection():this.successfulConnection()},successfulConnection:function(){var t=this.offline;this.offline=!1,this.dismissConnectionError(),this.checkEmptyPaneState(),t&&this.trigger("connectionOnline")},failedConnection:function(t){this.offline=!0,this.displayConnectingText(t||'Trouble connecting… <span class="retry">Retry</span>'),this.checkEmptyPaneState()},handleInput:function(t){13==t.keyCode&&this.createOnEnter(),27==t.keyCode&&(t.stopPropagation(),this.$el.find("input").blur())},onClickRetry:function(t){t.preventDefault(),t.stopPropagation(),this.retryConnection()},doFirstFetch:function(){this.loadedOnce||this.collection.fetch({reset:!0})},retryConnection:function(){var e=this;this.loadedOnce?(_.each(this.proxyCollection.where({proxyValid:!0,saveFailed:!0,isLoading:!1}),function(t){e.createNewModel(t,!0)}),_.each(this.collection.where({saveFailed:!0,isLoading:!1}),function(t){e.saveToModel(t)})):this.collection.fetch({reset:!0})},createNewModel:function(i,t){var s=this;t?s.displayConnectingText('<i class="loading-icon"></i>Retrying...'):s.displayConnectingText('<i class="loading-icon"></i>Saving...'),i.set({saveFailed:!1,isLoading:!0}),s.collection.create({title:i.get("title")},{wait:!0,success:function(){s.successfulConnection(),i.set("proxyValid",!1),C.sendEvent("Todo","Add")},error:function(t,e,o){s.failedConnection('Error saving… <span class="retry">Retry</span>'),i.set({saveFailed:!0,isLoading:!1})}})},saveToModel:function(s,t){var n=this;n.displayConnectingText('<i class="loading-icon"></i>Saving...');var e=s.saveOptions();e.wait=!0,e.success=function(){var t={};jQuery.extend(t,s.attemptedSaveValues),s.attemptedSaveValues=null,jQuery.extend(t,{saveFailed:!1,isLoading:!1}),setTimeout(function(){s.set(t),n.successfulConnection()},50)},e.error=function(t,e,o){if(200==e.status){var i={};jQuery.extend(i,s.attemptedSaveValues),s.attemptedSaveValues=null,jQuery.extend(i,{saveFailed:!1,isLoading:!1}),setTimeout(function(){s.set(i),n.successfulConnection()},50)}else s.set({saveFailed:!0,isLoading:!1}),n.failedConnection('Error saving… <span class="retry">Retry</span>')},t?(s.attemptedSaveValues?jQuery.extend(s.attemptedSaveValues,t):s.attemptedSaveValues=t,s.save(t,e)):s.attemptedSaveValues&&(t=s.attemptedSaveValues,s.save(s.attemptedSaveValues,e)),jQuery.extend(t,{saveFailed:!1,isLoading:!0}),s.set(t)},createOnEnter:function(t){var e=this.$el.find("#todo-new")[0].value.trim();if(e){var o=new x.models.legacy.TodoProxy({title:e});this.proxyCollection.add(o),this.$el.find("#todo-new")[0].value="",this.createNewModel(o)}},dragover:function(t){return t.preventDefault(),t.stopPropagation(),!(t.originalEvent.dataTransfer.dropEffect="move")},dragend:function(t){return t.originalEvent.dataTransfer.dropEffect="move",t.preventDefault(),t.stopPropagation(),"todo"==this.dragmode&&(this.dragging.$el.show(),this.$placeholder.hide(),this.collection.trigger("reorder",{move_id:this.dragging.model.id,move_target_id:this.move_target_id,move_offset:this.move_offset})),!1},drop:function(t){t.preventDefault(),t.stopPropagation()},li_index:function(t){return this.$("li").index(t)},updateHeight:function(t){if(!this.$(".app").hasClass("is-empty")){var e=this.$(".todo-list");0===t?e.css("min-height",""):e.outerHeight()<=t&&e.css("min-height",t)}},toggleShow:function(t){t&&t.preventDefault(),this.doFetchIfNeeded(),this.setMaxWidgetHeight(),this.$el.hasClass("show")?this.hidePopup(t):this.showPopup(),localStorage.showTodoList=!JSON.parse(localStorage.showTodoList)},showPopup:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in").find(".pane").css("height","auto"),this.$el.find("#todo-new").focus()},hidePopup:function(){if(this.$el.hasClass("show")){var e=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(t){e.$el.removeClass("show").find(".pane").css("height","auto")})}},showCompleted:function(t){t.preventDefault(),t.stopPropagation(),this.show_completed=!0,this.addAll()},hide:function(t){var o=!1;y(".todo-item-title").each(function(t,e){"true"==y(this).attr("contentEditable")&&(o=!0)}),!o&&this.$el.hasClass("show")&&this.toggleShow()},openList:function(t){this.$el.find(".todo-list-chooser-dropdown").show()},chooseList:function(t){this.$el.find(".todo-list-chooser-dropdown").hide()},revealConnectionError:function(){"none"===y(".error-message").css("display")&&y(".error-message").slideDown("slow")},dismissConnectionError:function(){"none"!=y(".error-message").css("display")&&y(".error-message").slideUp("slow")},collectionModelChanged:function(t){this.checkEmptyPaneState()},showInput:function(t){t&&(t.preventDefault(),t.stopPropagation()),this.$el.find("#todo-new").css({visibility:"visible"}).focus(),this.$el.find(".new-toggle").css({opacity:0})},hideInput:function(t){t&&(t.preventDefault(),t.stopPropagation()),this.$el.find("#todo-new").css({visibility:""}),this.$el.find(".new-toggle").css({opacity:1})},checkEmptyPaneState:function(){if(this.subViews){var t=_.every(this.subViews,function(t){return!t.$el.is(":visible")});0!=this.collection.activeToday().length&&(t=!1),this.$el.find(".todo-app").toggleClass("is-empty",t),t&&this.hideInput(),this.offline||this.showcompleted||!t?this.$el.find(".todo-app").css("min-height",""):this.$el.find(".todo-app").css("min-height",200),this.updateTodoCount()}},updateTodoCount:function(){if(!this.offline){var t=this.collection.remaining().length;switch(t){case 0:break;case 1:break;default:}this.$(".todo-count").html(t+" to do"),this.$(".todo-count").removeClass("pulsetext")}}}),x.views.legacy.Todo=Backbone.View.extend({tagName:"li",className:"todo-item todo-item-legacy",template:x.templates["legacy-todo-item"],events:{"click .todo-item-checkbox":"toggleDone",dblclick:"edit","click .destroy":"clear","keypress .editing":"handleInput","keypress .todo-item-title":"handleInput","blur .todo-item-title":"saveEdit","click .error-icon":"retrySave",dragstart:"dragstart",dragenter:"dragenter",dragleave:"dragleave"},editing:!1,initialize:function(t){_.bindAll(this,"dragstart","dragenter","dragleave"),this.parent=t.parent,this.listenTo(this.model,"change",this.render),this.listenTo(C,"globalEvent:esc",this.abortEdit)},render:function(){var t="",e=C.utils.captionFormatter(this.model.getValue("title"));if(done=this.model.getValue("done"),done)t="checked";var o={title:e,checked:t};return this.$el.html(this.template(o)),this.$el.find(".todo-item-checkbox").prop("checked",this.model.isTrue("done")),this.$el.toggleClass("done",done),this.$el.toggleClass("loading",this.model.isTrue("isLoading")),this.$el.toggleClass("failed",this.model.isTrue("saveFailed")),this.model.isTrue("isProxy")?(this.$el.toggle(this.model.isTrue("proxyValid")),this.$el.addClass("isproxy"),this.$el.data("cid",this.model.cid)):this.$el.prop("draggable","true"),this.$title=this.$el.find(".todo-item-title").first(),this.$title.text(e),this},destroy:function(){this.remove(),this.unbind()},clear:function(){C.sendEvent("Todo","Delete"),this.$el.hide(),x.views.legacy.todos.saveToModel(this.model,{deleted:!0,deletedDate:new Date})},abortEdit:function(){this.editing&&(this.$el.addClass("viewing"),this.$el.removeClass("editing"),this.$title.text(this.originalText),this.setEditable(this.$title,!1),el.attr("contentEditable",!1),el.closest(".todo-item").attr("draggable",!0),this.editing=!1)},setEditable:function(t,e){t.attr("contentEditable",e),t.closest(".todo-item").attr("draggable",!e)},saveEdit:function(){if(this.editing){this.$el.addClass("viewing"),this.$el.removeClass("editing"),this.editing=!1;var t=this.$title.text();this.setEditable(this.$title,!1),t?x.views.legacy.todos.saveToModel(this.model,{title:t}):this.clear()}},retrySave:function(){this.model.isTrue("isProxy")?x.views.legacy.todos.createNewModel(this.model,!0):this.model.attemptedSaveValues&&x.views.legacy.todos.saveToModel(this.model)},edit:function(t){this.editing||(this.originalText=this.$title.text(),this.$el.hasClass("isproxy")||this.$el.hasClass("loading")||this.$el.hasClass("failed")||(this.editing=!0,this.$el.addClass("editing"),this.$el.removeClass("viewing"),this.setEditable(this.$title,!0),this.$title.get(0).focus(),setEndOfContenteditable(this.$title.get(0)),C.sendEvent("Todo","Activate Edit")))},dragstart:function(t){if(this.editing)return!1;t.originalEvent.dataTransfer.effectAllowed="move",t.originalEvent.dataTransfer.setData("text","dummy"),this.parent.dragmode="todo",this.parent.dragging=this,C.sendEvent("Todo","Reorder")},dragenter:function(t){if("todo"==this.parent.dragmode){this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var e=this.parent.$placeholder;this.parent.$placeholder.css("display","list-item"),e.height(this.$el.height()),e.after(this.parent.dragging.$el)}},dragleave:function(t){},toggleDone:function(){C.sendEvent("Todo","Done");var t=!this.model.get("done");x.views.legacy.todos.saveToModel(this.model,{done:t,completedDate:t?new Date:null})},handleInput:function(t){this.editing&&(13==t.keyCode&&(this.saveEdit(),C.sendEvent("Todo","Edit"),t.preventDefault(),t.stopPropagation()),27==t.keyCode&&(t.stopPropagation(),this.abortEdit()))}}),x.views.legacy.TodosComplete=Backbone.View.extend({attributes:{id:"todo-complete",class:"metric"},template:x.templates["legacy-todo-complete"],initialize:function(){this.listenTo(this.collection,"completedCountChanged",this.render),this.render()},render:function(){var t=this.collection.completedCount(),e="todos";1==t&&(e="todo");var o={done:t,item:e},i=(this.options.order||"append")+"To";return this.$el[i]("."+this.options.region).html(this.template(o)).fadeTo(500,1),t?this.$el.show():this.$el.hide(),this}}),x.collect.ProjectTodoLists=Backbone.Collection.extend({url:C.globals.urlRoot+"todos/lists",loadedFromCache:!1,listStatus:null,initialize:function(t,e){if(this.model=x.models.TodoList,this.listenTo(this,"reset",this.collectionChanged),this.listenTo(this,"sync",this.collectionSync),this.listenTo(this,"change:count",this.handleCountChanged),this.listenTo(C,"globalEvent:resetLists",this.resetLists),this.project=e.project,e)if(this.project=e.project,e.isDummy)this.setAsDummy();else{e.prefetchTodos&&(this.externallyFetchedOnce=!0),e.provider&&(this.provider=e.provider);var o=this.listCacheKey(),i=localStorage[o];if(i){var s=JSON.parse(i);s&&0<s.length&&(this.loadedFromCache=!0,this.reset(s,{project:this.project}))}}},comparator:"order",resetLists:function(t){(!t||t.providerId==(this.provider||this.project.provider).id||t.listId&&this.get(t.listId))&&this.fetch()},setAsDummy:function(){this.isDummy=!0,this.models=[],this.models.push(new x.models.TodoList({id:this.project.get("id"),title:this.project.get("title"),isDummy:!0},{project:this.project}))},mergeLists:function(t){var e=t;t&&t.lists&&(e=t.lists);var o=this,i=this.selectedList();if(0==e.length?_.each(e,function(t){o.add(t,{merge:!0})}):this.set(e,{merge:!0}),!this.contains(i)){var s=this.models[0];this.selectItem(s.id)}},listCacheKey:function(){return this.project?"listCache-"+this.project.id:"listCache-default"},selectedListCacheKey:function(){return this.project?"activeTodoListId-"+this.project.id:null},cacheLists:function(){var t=JSON.stringify(this.models),e=this.listCacheKey();localStorage[e]=t},doFetchIfNeeded:function(t){this.isDummy&&(this.selectedList().doFetchIfNeeded(),this.trigger("reset")),this.forceFetch=!0,this.externallyFetchedOnce=!0,this.loadedFromCache?this.fetch():this.fetch({reset:!0})},parse:function(t){if(null!=t)return t.setAsDummy?(this.setAsDummy(),this.doFetchIfNeeded(!0),[]):(t.aux_data_cmd&&(this.aux_data_cmd=t.aux_data_cmd),t.aux_data&&(this.aux_data=t.aux_data),t.providerReset&&x.models.todoListManager.resetProvider(t.providerReset),t.lists)},handleCountChanged:function(){this.checkSelectedList(),this.cacheLists()},collectionSync:function(){this.setStatus("Done"),this.checkSelectedList(this.forceFetch),this.forceFetch=!1,this.cacheLists()},setStatus:function(t){this.listStatus=t,C.trigger("todo:loadingStateChange",t)},fetch:function(t){var i=this;if(!this.isDummy){var e=t||{};if(this.project){var o={},s=this.project.get("providerId");o.data={provider_id:s,project_id:this.project.get("id")},C.models.customization.get("archived-"+s)&&(o.data.loadArchived=!0),e=_.extend(e,o)}return e.error=function(t,e,o){this.externallyFetchedOnce=!0,403==e.status&&e.responseJSON&&e.responseJSON.status&&"authRequired"==e.responseJSON.status?i.setStatus({status:"error",message:"Authentication Required…",actionMessage:"Connect",action:"auth.connect",actionParameter:e.responseJSON}):i.setStatus({status:"error",message:"Trouble connecting…",actionMessage:"Retry",action:"todo.connection.retry"})},e&&null!=e.reset?this.setStatus({status:"loading",message:"Loading..."}):this.listStatus&&"loading"!=this.listStatus.status&&this.setStatus({status:"loading",message:"Loading..."}),e.project=this.project,Backbone.Collection.prototype.fetch.call(this,e)}setTimeout(function(){i.trigger("reset")})},collectionChanged:function(){this.setStatus(null),this.checkSelectedList(this.forceFetch),this.forceFetch=!1},selectedList:function(){var t;if(this.selectedListId&&this.get(this.selectedListId))t=this.get(this.selectedListId);else{if(!(t=this.findWhere({selected:!0}))&&(t=this.getListOfType("today"))){var e=this.getListOfType("inbox");e&&e.doFetchIfNeeded()}t||(t=this.getListOfType("inbox")),t?this.selectItem(t.id):this.models.length&&(t=this.models[0],this.selectItem(t.id)),!t&&this.models.length&&(t=this.models[0])}return t?(this.selectItem(t.id),t):null},getListOfType:function(t){return this.findWhere({type:t})},getListById:function(t){return this.findWhere({id:t})},unselectedLists:function(){var e=this;return this.selectedListId?this.reject(function(t){return t.id==e.selectedListId}):this.toArray()},isDoneList:function(){var t=this.selectedList();return!(!t||!t.get("done"))},checkSelectedList:function(t){if(!this.selectedListId){var e=null,o=this.selectedListCacheKey();if(o&&localStorage.getItem(o)){var i=localStorage.getItem(o);e=this.findWhere({id:i})}e||(e=this.findWhere({selected:!0})),!e&&0<this.models.length&&(e=this.models[0]),e?this.selectItem(e.id):this.selectItem(null)}},selectItem:function(t){if(t!=this.selectedListId){var e=this.selectedListCacheKey();e&&localStorage.setItem(e,t),this.selectedListId=t,this.project.triggerChangeEvent("Selected"),this.project.provider.triggerChangeEvent(),null!=t&&this.externallyFetchedOnce&&this.selectedList().doFetchIfNeeded(!1,!0)}}}),x.collect.ProviderTodoProjects=Backbone.Collection.extend({url:C.globals.urlRoot+"todos/projects",loadedFromCache:!1,projectStatus:null,initialize:function(t,e){if(this.model=x.models.TodoProject,this.listenTo(this,"reset",this.collectionChanged),this.listenTo(this,"sync",this.collectionSync),this.listenTo(this,"add",this.cacheProjects),this.listenTo(this,"change:count",this.handleCountChanged),this.listenTo(C,"globalEvent:resetLists",this.fetch),this.provider=e.provider,e&&e.isDummy){this.isDummy=!0,this.models=[];var o=new x.models.TodoProject({id:this.provider.get("id"),title:this.provider.get("title"),isDummy:!this.provider.get("supportProjects"),providerId:this.provider.get("id")},{provider:this.provider});this.models.push(o)}e&&e.prefetchTodos&&(this.externallyFetchedOnce=!0),e&&e.allProjects&&(this.allProjects=!0,this.url+="/all");var i=this.projectCacheKey(),s=localStorage[i];if(s){var n=JSON.parse(s);n&&0<n.length&&(this.loadedFromCache=!0,this.reset(n,{provider:this.provider}))}},comparator:"order",mergeProjects:function(t){var e=t;t&&t.projects&&(e=t.projects);var o=this,i=this.selectedProject();if(0==e.length?_.each(e,function(t){o.add(t,{merge:!0})}):this.set(e,{merge:!0}),!this.contains(i)){var s=this.models[0];this.selectItem(s.id)}},fetchSelectedProject:function(){var t=this.selectedProject();t&&t.doFetchIfNeeded()},projectCacheKey:function(){return this.provider?"projectCache-"+this.provider.id:"projectCache-default"},selectedProjectCacheKey:function(){return this.provider?"activeTodoProjectId-"+this.provider.id:null},cacheProjects:function(){var t=JSON.stringify(this.models),e=this.projectCacheKey();localStorage[e]=t},doFetchIfNeeded:function(t){this.forceFetch=!0,this.externallyFetchedOnce=!0,this.loadedFromCache?this.fetch():this.fetch({reset:!0})},parse:function(t){return t.aux_data_cmd&&(this.aux_data_cmd=t.aux_data_cmd),t.aux_data&&(this.aux_data=t.aux_data),t.projects},handleCountChanged:function(){this.checkSelectedProject(),this.cacheProjects()},collectionSync:function(){this.setStatus(null),this.checkSelectedProject(this.forceFetch),this.forceFetch=!1,this.cacheProjects()},setStatus:function(t){this.projectStatus=t,C.trigger("todo:loadingStateChange",t)},fetch:function(t){var i=this;if(!this.isDummy){var e=t||{};if(this.provider){var o={};o.data={provider_id:this.provider.id},e=_.extend(e,o)}return e.error=function(t,e,o){this.externallyFetchedOnce=!0,403==e.status&&e.responseJSON&&e.responseJSON.status&&"authRequired"==e.responseJSON.status?i.setStatus({status:"error",message:"Authentication Required…",actionMessage:"Connect",action:"auth.connect",actionParameter:e.responseJSON}):i.setStatus({status:"error",message:"Trouble connecting…",actionMessage:"Retry",action:"todo.connection.retry"})},e&&null!=e.reset?this.setStatus({status:"loading",message:"Loading..."}):this.projectStatus&&"loading"!=this.projectStatus.status&&this.setStatus({status:"loading",message:"Loading..."}),Backbone.Collection.prototype.fetch.call(this,e)}setTimeout(function(){i.trigger("reset")})},collectionChanged:function(){this.setStatus(null),this.checkSelectedProject(this.forceFetch),this.forceFetch=!1},selectedProject:function(){var t;return this.selectedProjectId&&this.findWhere({id:this.selectedProjectId})?this.findWhere({id:this.selectedProjectId}):((t=this.findWhere({selected:!0}))?this.selectItem(t.id):this.models.length&&(t=this.models[0],this.selectItem(t.id)),t||null)},getProjectById:function(t){return this.findWhere({id:t})},checkSelectedProject:function(t){if(!this.selectedProjectId){var e=null,o=this.selectedProjectCacheKey();if(o&&localStorage.getItem(o)){var i=localStorage.getItem(o);e=this.findWhere({id:i})}if(e||(e=this.findWhere({selected:!0})),!e&&0<this.models.length)return e=this.models[0],void this.selectItem(e.id);e?this.selectItem(e.id):this.selectItem(null)}},selectItem:function(t){if(t!=this.selectedProjectId){var e=this.findWhere({id:this.selectedProjectId});e&&e.resetSelection();var o=this.selectedProjectCacheKey();o&&localStorage.setItem(o,t),this.selectedProjectId=t,this.trigger("selectionChanged"),null!=t&&this.externallyFetchedOnce&&this.selectedProject().doFetchIfNeeded()}}}),x.collect.ProviderTodoProjectsAll=Backbone.Collection.extend({url:C.globals.urlRoot+"todos/projects/all",loadedFromCache:!1,projectStatus:null,initialize:function(t,e){this.model=x.models.TodoProject,this.listenTo(this,"sync",this.collectionSync),this.provider=e.provider},comparator:"order",collectionSync:function(){this.loaded=!0,this.loading=!1},mergeProjects:function(t){var e=t;t&&t.projects&&(e=t.projects);var o=this,i=this.selectedProject();if(0==e.length?_.each(e,function(t){o.add(t,{merge:!0})}):this.set(e,{merge:!0}),!this.contains(i)){var s=this.models[0];this.selectItem(s.id)}},doFetchIfNeeded:function(t){return t||!this.loaded&&!this.loading?(this.fetch(),!(this.loading=!0)):!!this.loaded||void 0},parse:function(t){return t.aux_data_cmd&&(this.aux_data_cmd=t.aux_data_cmd),t.aux_data&&(this.aux_data=t.aux_data),t.projects},fetch:function(t){var e=this,o=t||{};if(o.reset=!0,this.provider){var i={};i.data={provider_id:this.provider.id},C.models.customization.get("archived-"+this.provider.id)&&(i.data.loadArchived=!0),o=_.extend(o,i)}return o.error=function(){e.loading=!1,C.trigger("todo:failedLoadingItems")},this.reset(null,{silent:!0}),Backbone.Collection.prototype.fetch.call(this,o)}}),x.collect.TodoProviders=Backbone.Collection.extend({url:C.globals.urlRoot+"todos/providers",loadedOnce:!1,initialize:function(t,e){this.model=x.models.TodoProvider,this.listenTo(this,"reset",this.collectionReset)},collectionReset:function(){this.loadedOnce=!0},parse:function(t){return t.connected?t.connected:null}}),x.collect.TodoProxy=Backbone.Collection.extend({initialize:function(t,e){this.model=x.models.TodoProxy,e&&e.parentList&&(this.parentList=e.parentList)}}),x.collect.TodosBase=Backbone.Collection.extend({saveOptions:{},initialize:function(t,e){this.model=x.models.Todo,e&&e.parentList&&(this.parentList=e.parentList),localStorage.showTodoList||(localStorage.showTodoList=!1),this.listenTo(C,"newDay",this.onNewDay),this.listenTo(this,"reset",this.onReset),this.listenTo(this,"sync",this.onSync),this.listenTo(this,"add remove change",this.collectionChanged),this.listenTo(this,"reorder",this.reorderItem)},onReset:function(){this.fetchedOnce=!0,this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged")},onSync:function(){this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged"),C.trigger("todo:listSync")},onNewDay:function(){this.fetchedOnce&&(this.parentList&&x.models.todoListManager&&x.models.todoListManager.activeProvider.selectedList().id!==this.parentList.id||this.fetch({reset:!0}))},onLoadingFromServerChanged:function(){},clearCompleted:function(){},collectionChanged:function(t){localStorage.setItem("todos-updated",new Date),this.onCollectionChanged(t)},onCollectionChanged:function(t){},completeToday:function(){var s=this;return this.filter(function(t){var e=t.get("completedDate");if(e){var o="";if(e instanceof Date)o=activeDateStringForDate(e);else{var i=e.split("T");if(1<i.length)o=i[0]}if(o!=getActiveDateString())return!1}if(1==t.get("done")&&0==t.get("archive")&&0==t.get("deleted")&&t.get("listId")==s.parentList.id)return!0})},completedCount:function(){return this.completeToday().length},activeToday:function(){var o=this;return this.parentList.isDoneList()?this.where({deleted:!1,done:!0}):this.filter(function(t){if(0==t.get("archive")&&0==t.get("deleted")){var e=t.get("listId");if(e==o.parentList.id||!e)return!0;if("1-##default"==o.parentList.id)return!0}})},done:function(){return this.where({done:!0})},deleted:function(){return this.where({deleted:!0})},remaining:function(){var t=this.activeToday();return this.parentList.isDoneList()?t:_.filter(t,function(t){return!t.get("done")})},nextOrder:function(){return this.length?this.last().get("order")+100:100},comparator:"order",create:function(t,e){return null==t.order&&(t.order=this.nextOrder()),Backbone.Collection.prototype.create.call(this,t,e)},reorderItem:function(t){},hasValidCachedCompletedCount:function(){return!0}}),x.collect.Todos=x.collect.TodosBase.extend({url:C.globals.urlRoot+"todos",previousCount:-1,saveOptions:{patch:!0},listStatus:null,firstLoadCompleted:!1,reorderItem:function(t,e){var o=this,i={operations:[{REORDER:Object.assign({},t)}]},s=this.get(t.move_id);if(s){s.set({isLoading:!0});var n=s.collection.parentList.project;i.providerId=n.provider.id,i.projectId=n.id,y.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(i),beforeSend:setMomentumAuthHeader,url:C.globals.urlRootApi+"todos"}).done(function(t){s.set({isLoading:!1}),o.fetch({success:e})}).fail(function(t,e){s.pendingReorderData=i,s.set({saveFailed:!0,isLoading:!1})})}},onLoadingFromServerChanged:function(){this.setStatus("Done"),this.checkRemainingItemCount()},onCollectionChanged:function(t){this.checkRemainingItemCount()},completedCount:function(){return this.completeToday().length},checkRemainingItemCount:function(){if(!this.loadingFromServer){this.firstLoadCompleted=!0;var t=this.remaining().length;t!=this.previousCount&&(this.previousCount=t,this.trigger("remainingCountChanged",t))}},doFetchIfNeeded:function(t){this.firstItemFetchStarted?this.fetch(this.moreLoaded?{remove:!1,listChanged:t}:{listChanged:t}):(this.firstItemFetchStarted=!0,this.fetch({reset:!0}))},loadMore:function(t){this.moreLoaded=!0,this.todoChangedListener||(this.todoChangedListener=!0,this.listenTo(C,"todo:changed",this.todoChanged)),this.fetch({endDate:t,remove:!1})},setStatus:function(t){this.listStatus=t,C.trigger("todo:loadingStateChange",t)},parse:function(t){if(null!=t)return t.items?(t.sections?this.itemSections=t.sections:this.itemSections=null,t.hasOldTodos?this.hasOldTodos=t.hasOldTodos:this.hasOldTodos=!1,t.menu_options?this.menuOptions=t.menu_options:this.menuOptions=null,t.default_commands?this.defaultCommands=t.default_commands:this.defaultCommands=null,this.noAssigned=t.noAssigned,this.groupingInfo=t.groupingInfo,t.items):t},todoChanged:function(t){if(this.moreLoaded){var e=this.get(t);e&&e.fetch()}},activeToday:function(){var o=this;if(!this.firstItemFetchStarted)return this.parentList.doFetchIfNeeded(),[];if(this.parentList.isDoneList()){if(o.parentList.showAssignedTodosOnly&&!item.get("assigned"))return;return this.where({deleted:!1,done:!0})}return this.filter(function(t){if((!o.parentList.showAssignedTodosOnly||t.get("assigned"))&&(!t.get("today")||o.parentList.isTodayList())&&(t.get("today")||!o.parentList.isTodayList())&&t.get("title")&&0!=t.get("title").length&&0==t.get("archive")&&0==t.get("deleted")){var e=t.get("listId");if(e==o.parentList.id||t.get("today")&&o.parentList.isTodayList()||!e)return!0;if("1-##default"==o.parentList.id)return!0}})},fetch:function(t){var i=this;if(!this.loadingFromServer){this.loadingFromServer=!0;var e={data:{}};return this.parentList&&(e.data.listId=this.parentList.id),this.parentList.project&&!this.parentList.project.get("isDummy")&&(e.data.projectId=this.parentList.project.get("id"),e.data.providerId=this.parentList.project.provider.get("id")),C.models.customization.get("assigned-"+this.parentList.id)&&(e.data.loadMineOnly=!0),C.models.customization.get("subtask-"+this.parentList.id)&&(e.data.loadSubtasks=!0),C.models.customization.get("showOld-"+this.parentList.id)&&(e.data.loadOldCompleted=!0),t&&t.endDate&&(e.data=e.data||{},e.data.endDate=t.endDate),e.error=function(t,e,o){i.loadingFromServer=!1,403==e.status&&e.responseJSON&&e.responseJSON.status&&"authRequired"==e.responseJSON.status?i.setStatus({status:"error",message:"Authentication Required…",actionMessage:"Connect",action:"auth.connect",actionParameter:e.responseJSON}):i.setStatus({status:"error",message:"Trouble connecting…",actionMessage:"Retry",action:"todo.connection.retry"})},(t=_.extend(t||{},e))&&null!=t.reset?(this.setStatus({status:"loading",message:"Loading...",listChanged:t.listChanged}),this.moreLoaded=!1):this.listStatus&&"loading"!=this.listStatus.status&&this.setStatus({status:"loading",message:"Loading...",listChanged:t.listChanged}),Backbone.Collection.prototype.fetch.call(this,t)}}}),x.collect.TopDropdownMenuItems=Backbone.Collection.extend({url:C.globals.urlRoot+"settings/todo/menu",fetchCompleted:!1,initialize:function(t,e){this.model=x.models.DropdownMenuItem,e&&e.listId&&(this.listId=e.listId)},parse:function(t){return t.menuoptions},fetchIfRequired:function(t){if(this.fetchCompleted)return!1;var e={data:{},reset:this.fetchCompleted=!0,error:function(t,e,o){self.fetchCompleted=!1}};return t&&(e.data.providerId=t),this.fetch(e),!0},queueFetch:function(){this.fetchCompleted=!1},fetch:function(t){return this.listId?(additionalData={listId:this.listId},t.data=_.extend(t.data||{},additionalData),Backbone.Collection.prototype.fetch.call(this,t)):null}}),x.models.DropdownMenuItem=Backbone.Model.extend({}),x.models.TodoBase=Backbone.Model.extend({isTrue:function(t){var e=this.get(t);return void 0!==e&&1==e},attemptSave:function(t,e){},retrySave:function(){this.get("isProxy")?this.collection.parentList&&this.collection.parentList.createNewModel&&this.collection.parentList.createNewModel(this):this.attemptedSaveValues&&this.attemptSave(this.model)},saveOptions:function(){return this.collection.saveOptions},getValue:function(t){var e=null;return this.attemptedSaveValues&&this.attemptedSaveValues.hasOwnProperty(t)&&(e=this.attemptedSaveValues[t]),e||(e=this.get(t)),e},isSibling:function(t){return t.get("parentId")==this.get("parentId")}}),x.models.Todo=x.models.TodoBase.extend({defaults:function(){return{title:"empty todo...",done:!1,archive:!1,order:0,createdDate:new Date,archivedDate:null,completedDate:null,deleted:!1,deletedDate:null,listId:"inbox"}},parse:function(t){return t&&t.done&&t.archive&&(t.listId="1-done"),t},archive:function(){this.setArchiveState(!0)},setArchiveState:function(t){var e={};e.archive=void 0===t?!this.get("archive"):t,e.archive?(e.archivedDate=new Date,this.get("done")||(e.done=!0,e.completedDate=new Date)):e.archivedDate=null,this.attemptSave(e)},toggleDoneState:function(){this.setDoneState()},setDoneState:function(t,e){var o=this.getDoneStateChanges(t,e);this.attemptSave(o),o.done&&C.sendEvent("Todo","Done"),C.trigger("todo:loadingStateChange",status)},getDoneStateChanges:function(t,e){var o={};if(o.done=void 0===t?!this.get("done"):t,o.done){var i=this.collection.parentList;if(i.has("done_disabled")){var s=i.get("done_disabled");return void(s.message&&C.trigger("todo:status",s))}o.completedDate=new Date,e&&(o.archive=!0,o.archivedDate=new Date)}else o.archive=!1,o.archivedDate=null,o.completedDate=null;return o},getTodayStateChanges:function(t){var e={};return(e.today=t)&&this.get("archive")&&(e.archive=!1,e.archivedDate=null),e},setTodayState:function(t){var e=this.getTodayStateChanges(t);this.attemptSave(e)},deleteItem:function(){this.attemptSave({deleted:!0,deletedDate:(new Date).toISOString()})},displayConnectingText:function(t){},successfulConnection:function(){},failedConnection:function(t){},attemptSave:function(t,s){var n=this;n.displayConnectingText('<i class="loading-icon"></i>Saving...');var e=n.saveOptions();e.wait=!0;var o=this.collection.parentList.project;t&&(t.projectId=this.get("projectId")||o.id,t.providerId=o.provider.id),e.success=function(){var t={};jQuery.extend(t,n.attemptedSaveValues),n.attemptedSaveValues=null,jQuery.extend(t,{saveFailed:!1,isLoading:!1}),C.trigger("todo:changed",n.id,t),setTimeout(function(){n.set(t),n.successfulConnection(),s&&s(!0)},50)},e.error=function(t,e,o){if(200==e.status){var i={};jQuery.extend(i,n.attemptedSaveValues),n.attemptedSaveValues=null,jQuery.extend(i,{saveFailed:!1,isLoading:!1}),C.trigger("todo:changed",n.id,i),setTimeout(function(){n.set(i),n.successfulConnection(),s&&s(!0)},50)}else{n.set({saveFailed:!0,isLoading:!1,deleted:!1,deletedDate:null}),C.trigger("todo:loadingStateChange"),n.failedConnection('Error saving… <span class="retry">Retry</span>'),s&&s(!1)}},t?(n.attemptedSaveValues?jQuery.extend(n.attemptedSaveValues,t):n.attemptedSaveValues=t,n.save(t,e)):n.attemptedSaveValues?(t=n.attemptedSaveValues,n.save(n.attemptedSaveValues,e)):n.pendingReorderData&&(n.set({isLoading:!0}),y.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(n.pendingReorderData),beforeSend:setMomentumAuthHeader,url:C.globals.urlRootApi+"todos"}).done(function(t){n.set({isLoading:!1,saveFailed:!1})}).fail(function(t,e){n.set({saveFailed:!0,isLoading:!1})})),jQuery.extend(t,{saveFailed:!1,isLoading:!0}),n.set(t),C.trigger("todo:changing",n.id,t)},comparator:"order",save:function(t,e){e||(e={}),t||(t=_.clone(this.attributes));try{if(this.collection&&this.collection.parentList&&this.collection.parentList.collection&&this.collection.parentList.collection.aux_data&&jQuery.extend(t,{aux_data:this.collection.parentList.collection.aux_data}),this.collection&&this.collection.parentList&&this.collection.parentList.collection&&this.collection.parentList.collection.aux_data_cmd){var o=C.commandManager.execute(this.collection.parentList.collection.aux_data_cmd,this,this.collection.parentList.collection.aux_data);jQuery.extend(t,{aux_data:this.collection.parentList.collection.aux_data,aux_data_result:o})}}catch(t){}return Backbone.Model.prototype.save.call(this,t,e)},fetch:function(t){var e=t||{};return e.data=y.param({projectId:this.get("projectId"),providerId:this.get("providerId"),listId:this.get("listId")}),Backbone.Model.prototype.fetch.call(this,e)}}),x.models.TodoProxy=x.models.TodoBase.extend({defaults:function(){return{done:!1,isProxy:!0,isLoading:!0,saveFailed:!1,proxyValid:!0}}}),x.models.TodoList=Backbone.Model.extend({itemFetchStarted:!1,showAssignedTodosOnly:!1,defaults:{selected:!1},initialize:function(t,e){e&&(e.project&&(this.project=e.project),t.isDummy&&Object.assign(this.attributes,this.project.attributes)),this.itemCollection=new x.collect.Todos(null,{parentList:this}),this.listenTo(this.itemCollection,"add remove change reset",this.triggerChangeEvent),this.listenTo(this.itemCollection,"remainingCountChanged",this.remainingCountChanged),this.proxyCollection=new x.collect.TodoProxy(null,{parentList:this}),this.listenTo(this.proxyCollection,"add change",this.triggerChangeEvent),this.supportsFeature("assigned")&&this.refreshShowAssignedTodosOnly()},supportsFeature:function(t){return this.get("isDummy")?this.project.get(t+"_support"):this.get(t+"_support")},todoItemMenuOptions:function(){if(this.itemCollection.menuOptions&&(this._todoItemMenuOptions=new Backbone.Collection(this.itemCollection.menuOptions)),!this._todoItemMenuOptions){var t=[{captionText:"Edit",commandId:"todo.edit"},{captionText:"Set to Focus",commandId:"todo.focus.pin"},{css_class:"line"},{captionText:"Move to Today",commandId:"todo.toggle.today",options:{}},{captionText:"Move Back",commandId:"todo.undone",options:{}},{captionText:"Move to...",commandId:"todo.moveTo"},{captionText:"Archive",commandId:"todo.archive"},{css_class:"line"},{captionText:"Delete",commandId:"todo.delete"}];C.conditionalFeatures.featureEnabled("plus")||t.splice(1,1),this._todoItemMenuOptions=new Backbone.Collection(t)}return this._todoItemMenuOptions},toggleSubtasks:function(){C.models.customization.get("assigned-"+this.id)||(this.allSubtasksLoaded=!0),this.itemFetchStarted=!0,this.itemCollection.firstLoadCompleted=!1,this.itemCollection.fetch({reset:!0})},loadOldCompletedTodos:function(){this.itemFetchStarted=!0,this.itemCollection.firstLoadCompleted=!1,this.itemCollection.fetch({reset:!0})},showAssignedTodosOnlyChanged:function(){this.refreshShowAssignedTodosOnly(),this.itemCollection.checkRemainingItemCount(),this.showAssignedTodosOnly&&this.loadAssignedTodosOnly||!this.allSubtasksLoaded&&C.models.customization.get("subtask-"+this.id)||this.itemCollection.noAssigned&&!this.allFetched?(this.loadAssignedTodosOnly=this.showAssignedTodosOnly,this.itemFetchStarted=!0,this.loadAssignedTodosOnly&&(this.allFetched=!0),this.itemCollection.firstLoadCompleted=!1,this.itemCollection.fetch({reset:!0})):C.trigger("todo:showAssignedTodosOnlyChanged",this.id),!C.models.customization.get("assigned-"+this.id)&&C.models.customization.get("subtask-"+this.id)&&(this.allSubtasksLoaded=!0)},refreshShowAssignedTodosOnly:function(){this.showAssignedTodosOnly=C.models.customization.get("assigned-"+this.id)},topMenuItems:function(){return this._topMenuItems||(this._topMenuItems=new x.collect.TopDropdownMenuItems(null,{listId:this.id})),this._topMenuItems},refreshItems:function(){this.doFetchIfNeeded(!0)},doFetchIfNeeded:function(t,e){this.loadedOnce||(this.loadAssignedTodosOnly=!1,this.loadedOnce=!0),!t&&this.itemFetchStarted||(this.itemFetchStarted=!0,this.showAssignedTodosOnly&&(this.loadAssignedTodosOnly=!0)),this.itemCollection.doFetchIfNeeded(e)},triggerChangeEvent:function(t){this.trigger("change",this),C.trigger("todo:globalChange",t)},getDefaultCommands:function(){return this.collection&&1!=this.collection.project.provider.id?[]:this.isDoneList()?[{commandId:"todo.undone",options:{}}]:[{commandId:"todo.toggle.today",options:{}}]},isDoneList:function(){return"done"==this.get("type")},isTodayList:function(){return"today"==this.get("type")},listType:function(){return this.get("type")},displayConnectingText:function(t){},successfulConnection:function(){},failedConnection:function(t){},remainingTodoCount:function(){var t=this.get("count");return null!=t&&null!=t?t:""},remainingCountChanged:function(t){this.get("count")!=t&&this.set("count",t)},changeCount:function(t){if(void 0===this.get("count")){var e=this;setTimeout(function(){e.refreshItems()},500)}else this.set("count",this.get("count")+(t?1:-1)),this.collection&&this.collection.cacheLists()},supportsReordering:function(){return!!this.get("reorder")},groupingInfo:function(){return this.isDoneList()?{type:"date",field:"completedDate"}:this.itemCollection.groupingInfo?this.itemCollection.groupingInfo:null},createNewModel:function(t,e,o){var i={};this.collection&&1!=this.collection.project.provider.id&&(o=!1),(o=o||"top"==this.get("defaultTaskPosition"))&&(i={at:0}),this.addedToTop=o;var s=0;if("bottomOfIncomplete"==this.get("defaultTaskPosition")){for(;s<this.itemCollection.models.length&&!this.itemCollection.models[s].get("done");)s++;i={at:s}}var n=null;t instanceof Backbone.Model?n=t:(t.listId=this.id,this.isDoneList()&&(t.done=!0),this.isTodayList()&&(t.today=!0),t.viewSection=this.get("defaultSection"),n=new x.models.TodoProxy(t),this.proxyCollection.add(n,i)),this.showAssignedTodosOnly&&n.set("assigned",!0),n.set("viewSection",this.get("defaultSection"));var d=this;e?d.displayConnectingText('<i class="loading-icon"></i>Retrying...'):d.displayConnectingText('<i class="loading-icon"></i>Saving...'),n.set({saveFailed:!1,isLoading:!0});var a=this.collection?this.collection.project.getDefaultList():this,r=a?a.get("id"):null,l=d.isDoneList()&&r?r:n.get("listId"),c=null;Object.assign(i,{wait:!0,success:function(t){d.successfulConnection(),o&&1==d.project.provider.id&&c?(c.move_id=t.get("id"),d.waitForReorder=!0,d.itemCollection.reorderItem(c,function(){n.set("proxyValid",!1),d.waitForReorder=!1})):n.set("proxyValid",!1),C.sendEvent("Todo","Add")},error:function(t,e,o){d.failedConnection('Error saving… <span class="retry">Retry</span>'),n.set({saveFailed:!0,isLoading:!1}),n.targetList=d}}),0<d.itemCollection.models.length&&(c={move_target_id:d.itemCollection.models[0].get("id"),move_offset:"-1",list_id:l}),d.itemCollection.create({title:n.get("title"),listId:n.get("listId"),today:n.get("today"),done:n.get("done"),assigned:n.get("assigned"),homeListId:l,viewSection:n.get("viewSection"),providerId:this.project.provider.id,projectId:this.project.id,completedDate:n.get("done")?new Date:null},i)}}),x.models.TodoListManager=Backbone.Model.extend({defaults:{activeTodoList:null},initialize:function(t){if(t&&t.prefetchTodos&&(this.prefetchTodos=!0),this.todoProviders=new x.collect.TodoProviders,this.listenTo(C,"todoListManager:fetch",this.mergeLists),this.listenTo(C,"globalEvent:refreshInbox",this.refreshInbox),this.listenTo(this.todoProviders,"reset",this.todoProvidersReset),localStorage.activeTodoProvider){var e=JSON.parse(localStorage.activeTodoProvider);e&&e.id?this.changeProvider(e.id,!0,e):e?this.changeProvider(e,!0):this.changeProvider(1,!0)}else this.changeProvider(1,!0)},refreshInbox:function(){this.activeProvider.selectedProject().getDefaultList()&&this.activeProvider.selectedProject().getDefaultList().refreshItems()},triggerChangeEvent:function(){this.trigger("change",this)},forceFetch:function(){this.doFetchIfNeeded(!0)},doFetchIfNeeded:function(t){this.externallyFetchedOnce=!0,this.activeProvider.doFetchIfNeeded(t)},changeProvider:function(t,e){var o=this.todoProviderDetails(t,!0);if(!o){var i={id:t,prefetchTodos:this.prefetchTodos};1==t&&(i.add_lists=!0,i.supportLists=!0,i.supportProjects=!1),this.todoProviders.add(i),this.todoProviders.fetch({reset:!0}),o=this.todoProviders.get(t)}null==o.get("supportProjects")&&(o.set("supportProjects",!1),o.set("supportLists",!0)),o&&this.activeProvider!=o&&(C.trigger("todo:topmenu:reset"),localStorage.activeTodoProvider=JSON.stringify(o.id),this.activeProvider&&this.stopListening(this.activeProvider),this.activeProvider=o,this.listenTo(this.activeProvider,"change",this.triggerChangeEvent),this.triggerChangeEvent(),(this.externallyFetchedOnce||this.prefetchTodos)&&this.activeProvider.refreshTodoItems(),C.trigger("todo:providerChanged",t))},switchProject:function(t){this.activeProvider.selectProject(t,!0)},todoProvidersReset:function(){this.pendingResetCallback&&(this.pendingResetCallback(),this.pendingResetCallback=null)},resetProvider:function(t){-1<(t.id+"").indexOf(this.activeProvider.id)&&this.todoProviders.remove(this.activeProvider),this.todoProviders.add(t),this.fetchAndCacheTodoProviders(),this.changeProvider(t.id)},todoProviderDetails:function(t,e){var o;if(this.todoProviders){if(0<this.todoProviders.length&&(o=this.todoProviders.get(t)))return o;if(this.cachedTodoProviders){if(!(o=this.cachedTodoProviders.findWhere({id:t+""}))){var i=t+"-";this.cachedTodoProviders.forEach(function(t){0<=t.id.indexOf(i)&&(o=t)})}if(o)return e&&!o.isProviderModel&&(this.cachedTodoProviders.remove(o),o=new x.models.TodoProvider(o.attributes),this.cachedTodoProviders.add(o)),o}if(localStorage.cachedTodoProviders){var s=JSON.parse(localStorage.cachedTodoProviders);this.cachedTodoProviders=new Backbone.Collection;if(this.cachedTodoProviders.reset(s),o=this.cachedTodoProviders.get(t+"")){if(localStorage.tsCachedTodoProviders){var n=new Date,d=JSON.parse(localStorage.tsCachedTodoProviders);new Date(d)<new Date(n.getTime()-864e5)&&this.fetchAndCacheTodoProviders()}else this.fetchAndCacheTodoProviders();return e&&(this.cachedTodoProviders.remove(o),o=new x.models.TodoProvider(o.attributes),this.cachedTodoProviders.add(o)),o}}return this.fetchAndCacheTodoProviders(),null}},fetchAndCacheTodoProviders:function(t){var e=this;this.fetchingTodoProviders||(this.fetchingTodoProviders=!0,this.pendingResetCallback=function(){e.cacheTodoProviders(),t?t():e.triggerChangeEvent()},this.todoProviders.fetch({reset:!0}))},cacheTodoProviders:function(){if(this.todoProviders&&this.todoProviders.loadedOnce){var t=new Date;localStorage.setItem("tsCachedTodoProviders",JSON.stringify(t.getTime()));var e=this.todoProviders.toJSON();localStorage.setItem("cachedTodoProviders",JSON.stringify(e))}},selectPreviousProvider:function(){var i=this,t=function(){var t=i.todoProviders.get(i.activeProvider.id);if(t){var e=i.todoProviders.indexOf(t);if(0<e){var o=i.todoProviders.at(e-1);o&&i.changeProvider(o.id,!0)}}};this.todoProviders&&(this.todoProviders.loadedOnce?t():this.fetchAndCacheTodoProviders(t))},selectNextProvider:function(){var i=this,t=function(){var t=i.todoProviders.get(i.activeProvider.id);if(t){var e=i.todoProviders.indexOf(t);if(e<i.todoProviders.length-1){var o=i.todoProviders.at(e+1);o&&i.changeProvider(o.id,!0)}}};this.todoProviders&&(this.todoProviders.loadedOnce?t():this.fetchAndCacheTodoProviders(t))}}),x.models.TodoProject=Backbone.Model.extend({itemFetchStarted:!1,defaults:{selected:!1},initialize:function(t,e){e&&e.provider?this.provider=e.provider:this.get("providerId")&&x.models.todoListManager&&(this.provider=x.models.todoListManager.todoProviderDetails(this.get("providerId"),!0)),this.listCollection=new x.collect.ProjectTodoLists(null,{project:this,prefetchTodos:this.prefetchTodos,isDummy:!(void 0===this.get("supportLists")?this.provider.get("supportLists"):this.get("supportLists"))}),this.listenTo(this,"add",this.onAdd),this.listenTo(this.listCollection,"add remove change reset selectionChanged",this.triggerChangeEvent)},todoItemMenuOptions:function(){return this.listCollection.menuOptions&&(this._todoItemMenuOptions=new Backbone.Collection(this.listCollection.menuOptions)),this._todoItemMenuOptions},topMenuItems:function(){return this._topMenuItems||(this._topMenuItems=new x.collect.TopDropdownMenuItems(null,{listId:this.id})),this._topMenuItems},resetSelection:function(){this.listCollection.selectedListId=null},refreshItems:function(){this.doFetchIfNeeded(!0)},triggerChangeEvent:function(t){this.trigger("change",this),C.trigger("todo:globalChange",t)},doFetchIfNeeded:function(t){!t&&this.fetchStarted||(this.fetchStarted=!0,this.listCollection.doFetchIfNeeded(t))},refreshTodoItems:function(){var t=this.selectedList();t?t.refreshItems():this.listCollection.doFetchIfNeeded(!0)},getDefaultList:function(){return this.getListOfType("inbox")},getDoneList:function(){return this.getListOfType("done")},getListOfType:function(t){return this.listCollection.getListOfType(t)},getListById:function(t){return this.listCollection.getListById(t)},triggerParentChangeEvent:function(){this.trigger("change",this),this.listCollection.doFetchIfNeeded(!0)},selectedList:function(){return this.listCollection?this.listCollection.selectedList():null},projectStatus:function(){if(this.listCollection.listStatus)return this.listCollection.listStatus;var t=this.selectedList();return t?t.listCollection.listStatus:null},addNewList:function(t,e,o){var i=this,s=C.globals.urlRootApi+"todos/lists",n={providerId:x.models.todoListManager.activeProvider.id,projectId:this.id,title:t};y.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(n),url:s}).done(function(t){t&&t.success&&i.listCollection.fetch({success:function(){i.selectList(t.id),e&&e()}})}).fail(function(t,e){o&&o()})},selectList:function(t){this.listCollection.selectItem(t),this.provider.trigger("change",this.provider)},getNeighboringList:function(t){if(this.listCollection){var e=this.listCollection.selectedList();if(e){var o=this.listCollection.indexOf(e);if(0<t&&o<this.listCollection.length-1||t<0&&0<o)return this.listCollection.at(o+t)}}return null},selectPreviousList:function(){var t=this.getNeighboringList(-1);t&&this.selectList(t.id)},selectNextList:function(){var t=this.getNeighboringList(1);t&&this.selectList(t.id)}}),x.models.TodoProvider=Backbone.Model.extend({fetchStarted:!1,initialize:function(t){this.prefetchTodos=this.get("prefetchTodos"),void 0===t.supportLists&&(this.attributes.supportLists=!0,this.attributes.supportProjects=!1),this.projectCollection=new x.collect.ProviderTodoProjects(null,{provider:this,prefetchTodos:this.prefetchTodos,isDummy:!this.get("supportProjects")}),this.get("supportProjects")&&(this.allProjectsCollection=new x.collect.ProviderTodoProjectsAll(null,{provider:this})),this.listenTo(this.projectCollection,"reset",this.projectsAvailable),this.get("supportProjects")&&this.listenTo(this.allProjectsCollection,"sync",this.projectsAvailableSynced),this.listenTo(this,"add",this.onAdd),this.listenTo(C,"globalEvent:altUp",this.altReleased),this.listenTo(this.projectCollection,"reset selectionChanged",this.triggerChangeEvent)},isProviderModel:function(){},refreshItems:function(){this.projectCollection.fetch({reset:!0})},doFetchIfNeeded:function(t){!t&&this.fetchStarted||(this.fetchStarted=!0,this.projectCollection.doFetchIfNeeded(t))},getAllProjects:function(){if(this.allProjectsCollection&&0<this.allProjectsCollection.length)return this.allProjectsCollection;var t=localStorage.getItem("cachedTodoProjects-"+this.id);return!t||this.loadingFromCache||this.allProjectsCollection.loading?this.refreshAllProjects():(this.loadingFromCache=!0,this.allProjectsCollection.reset(JSON.parse(t)),this.loadingFromCache=!1),this.allProjectsCollection},projectsAvailableSynced:function(){var i=this;this.projectCollection.models.map(function(t,e){var o=i.allProjectsCollection.findWhere({id:t.get("id")});o?t.set("title",o.get("title")):(i.projectCollection.models.splice(e,1),i.projectCollection.length--)}),this.cacheAllProjects(),C.trigger("todo:allProjectsLoaded")},refreshAllProjects:function(t){this.allProjectsCollectionSynced||(this.allProjectsCollectionSynced=!0,this.allProjectsCollection&&this.allProjectsCollection.doFetchIfNeeded(t)&&C.trigger("todo:allProjectsLoaded"))},cacheAllProjects:function(){var t=new Date;localStorage.setItem("tsCachedTodoProjects-"+this.id,JSON.stringify(t.getTime()));var e=this.allProjectsCollection.toJSON();localStorage.setItem("cachedTodoProjects-"+this.id,JSON.stringify(e))},projectsAvailable:function(){this.selectedProject()&&this.selectedProject().doFetchIfNeeded()},refreshTodoItems:function(){var t=this.selectedProject();t?t.refreshTodoItems():this.doFetchIfNeeded(!0)},getDefaultList:function(){return this.getListOfType("inbox")},getDoneList:function(){return this.getListOfType("done")},getListOfType:function(t){return this.selectedProject().getListOfType(t)},getListById:function(t){return this.selectedProject().getListById(t)},triggerChangeEvent:function(){this.trigger("change",this)},triggerParentChangeEvent:function(){this.trigger("change",this),this.projectCollection.doFetchIfNeeded(!0)},selectedList:function(){var t=this.selectedProject();return t?t.selectedList():null},selectedProject:function(){return this.projectCollection?this.projectCollection.selectedProject():null},providerStatus:function(){if(this.projectCollection.projectStatus)return this.projectCollection.projectStatus;var t=this.selectedProject();if(t&&t.listCollection.projectStatus)return t.listCollection.projectStatus;var e=this.selectedList();return e?e.itemCollection.listStatus:null},selectList:function(t){this.selectedProject().selectList(t)},selectProject:function(t,e){var o=this.projectCollection.get(t);o?(this.projectCollection.selectItem(t),e&&o.set({last_active:(new Date).toISOString()})):this.allProjectsCollection&&(o=this.allProjectsCollection.get(t))&&(this.projectCollection.add(o),this.projectCollection.selectItem(t),e&&o.set({last_active:(new Date).toISOString()})),e&&C.trigger("todo:resetProjectList")},getNeighboringProject:function(t){var e=this.projectCollection;if(e=e.sortBy("last_active").reverse()){var o=this.selectedProject();if(o){var i=e.indexOf(o);if(0<t&&i<e.length-1||t<0&&0<i)return e[i+t]}}return null},selectPreviousProject:function(){this.altReleased=!1;var t=this.getNeighboringProject(-1);t&&(this.watchingAlt=!0,this.selectProject(t.id,!1))},selectNextProject:function(){this.altReleased=!1;var t=this.getNeighboringProject(1);t&&(this.watchingAlt=!0,this.selectProject(t.id,!1))},altReleased:function(){(this.altReleased=!0,this.watchingAlt)&&(this.selectedProject().set({last_active:(new Date).toISOString()}),C.trigger("todo:resetProjectList"))}}),x.views.AddTodoList=Backbone.View.extend({tagName:"li",attributes:{class:"todo-list-add-row"},template:x.templates.addtodolist,events:{keyup:"handleKeyup",keydown:"handleKeydown",click:"ignoreClick","click #list-new":"handleClick","blur #list-new":"handleBlur"},initialize:function(t){this.parent=t.parent,this.listenTo(C,"todo:loadingStateChange",this.render),this.adding=!1},render:function(){this.adding=!1,this.$el.html(this.template()),this.$inputNewList=this.$("#list-new"),this.$addListIcon=this.$("#add-icon"),this.$loading=this.$(".todo-list-add-loading");var t=this.model.activeProvider.selectedList();return t&&t.get("add_hidden")?(this.$el.prop("disabled",!0),void this.$el.prop("placeholder","")):(this.$el.is(":disabled")&&(this.$el.prop("disabled",!1),this.$el.prop("placeholder","New List")),this.$loading.hide(),this.$addListIcon.show(),this)},ignoreClick:function(t){t.stopPropagation(),t.preventDefault()},handleClick:function(t){if(t.stopPropagation(),t.preventDefault(),!C.conditionalFeatures.featureEnabled("plus")){this.$inputNewList.blur();return C.commandManager.execute("upsell.message",{targetRegion:"todo",sourceEvent:"todoAddList",buttonText:"Learn more",title:"Multi-todo lists",description:"Create and customize multiple todo lists"}),void C.trigger("globalEvent:closeDropdowns")}this.adding=!0,this.$addListIcon.hide(),this.$el.addClass("input-mode"),this.$inputNewList.attr("placeholder",""),this.focusInputField()},handleBlur:function(t){this.$inputNewList.val()||(this.$inputNewList.attr("placeholder","    New List").val(""),this.$addListIcon.show(),this.$el.removeClass("input-mode"))},cancelEdit:function(t){this.adding=!1,this.$inputNewList.blur(),this.$inputNewList.attr("placeholder","    New List").val(""),this.$addListIcon.show()},createOnEnter:function(t){var e=C.utils.capitalizeFirstLetter(this.$inputNewList.val());e&&0!=e.length&&0!=e.trim().length&&this.model.activeProvider&&(this.$inputNewList.val(""),this.model.activeProvider.selectedProject().addNewList(e,function(){C.trigger("todo:listAdded")}),this.adding=!1,this.$inputNewList.val(""),this.$inputNewList.blur(),this.$loading.show())},focusInputField:function(){this.$inputNewList.focus()},handleKeyup:function(t){13==t.keyCode?this.createOnEnter():27==t.keyCode&&(t.stopPropagation(),this.cancelEdit(),this.$el.blur())},handleKeydown:function(t){}}),x.views.TodoDropdownMenu=Backbone.View.extend({template:x.templates.dropdownmenu,expanded:!1,renderedOnce:!1,menuOptionsFetched:!1,events:{"click .dropdown-toggle":"toggleDropdown","dblclick .dropdown-toggle":"eatDblClick","click li":"clickMenuItem","click .show-dropdown-detail":"showDropdownDetail","click .dropdown-detail-back":"hideDropdownDetail","mouseover .project-chooser-dropdown":"removeActiveItemClass","mouseleave .project-chooser-dropdown":"addActiveItemClass","click .failed-loading":"retryLoadingItems","click .dropdown-list":"eatDblClick","dblclick .dropdown-list":"eatDblClick"},initialize:function(t){this.submenu=null,this.menuItems=t.menuItems,this.loadAllOnExpand=t.loadAllOnExpand,this.parentContext=t.parentContext,this.comparisonNode=t.comparisonNode,this.iClassName=t.iClassName,this.dropdownClassName=t.dropdownClassName,this.providerLogo=t.providerLogo,this.keepOpen=t.keepOpen,this.listenTo(this.menuItems,"add remove reset",this.renderMenuOptions),this.listenTo(C,"globalEvent:closeDropdowns",this.closeDropdown),this.listenTo(C,"globalEvent:esc globalEvent:click",this.closeDropdown),this.listenTo(C,"todo:submenuUpdate",this.showDropdownDetail),this.listenTo(this.menuItems,"failedLoadingItems",this.failedLoading),this.listenTo(C,"todo:providerChanged",this.resetMenuItems),this.subViews=[]},render:function(){var t={};t.providerLogo=this.providerLogo,this.iClassName&&(t.iClassName=this.iClassName),"icon-cog"==this.iClassName&&(t.iClassName=""),this.dropdownClassName&&(t.dropdownClassName=this.dropdownClassName);var e=this.template(t);this.$el.html(e),this.$dropdown=y(this.$el.find(".dropdown")[0]),this.$dropdownList=y(this.$el.find(".dropdown-list")[0]),this.$todoProjectDropdown=y(".project-chooser-dropdown .dropdown-list"),this.isOpen&&this.keepOpen&&(this.renderMenuOptions(),this.setExpandedState(!0));var o=this;this.dropdownClassName.includes("project-chooser-dropdown")&&this.$todoProjectDropdown.scroll(function(){o.refreshItems()})},updateModel:function(t){this.model=t},resetMenuItems:function(){this.menuOptionsFetched=!1,this.isLoading=!1,this.itemsRefreshed=!1;var t=this.expanded;delete this.expanded,t&&this.setExpandedState(t)},setExpandedState:function(t,e){if(this.expanded!=t){this.expanded=null!=t?t:!this.expanded,this.$el.toggleClass("active",this.expanded),this.$dropdown.closest(".dropdown-parent").toggleClass("dropdown-parent-active",this.expanded);var o=this;this.expanded?(this.$dropdown.show(),e?(o.$dropdown.css({opacity:1,display:"block"}),this.renderMenuOptions(),o.ensureVisible(o.$dropdown.outerHeight()),this.$dropdown.hasClass("project-chooser-dropdown")&&o.forceScrollableHeight(o.$dropdown)):(o.renderMenuOptions(),o.$dropdown.css({opacity:1,display:"block"}),o.ensureVisible(o.$dropdown.outerHeight()),o.$dropdown.hasClass("project-chooser-dropdown")&&o.forceScrollableHeight(o.$dropdown)),this.isOpen=!0):(this.$dropdown.css("opacity",0),this.hideDropdownDetail(null),this.isOpen=!1,setTimeout(function(){o.$dropdown.css("opacity")<.7&&o.$dropdown.hide()},300))}},forceScrollableHeight:function(t){if(t.find(".dropdown-list").children().length<=7){var e=t.outerHeight();t.addClass("short-list"),t.find(".dropdown-list").css("max-height",e)}else t.removeClass("short-list")},eatDblClick:function(t){t&&(t.preventDefault(),t.stopPropagation())},closeDropdown:function(t){this!=t&&!0===this.expanded&&this.setExpandedState(!1)},attachMenuItems:function(t,e){this.isLoading=!1,this.menuItems&&this.menuItems!=e&&this.stopListening(this.menuItems),this.$el[0]!=t[0]&&(this.setElement(t),this.renderedOnce=!1),this.menuItems!=e&&(this.menuItems=e,this.listenTo(this.menuItems,"add remove reset",this.renderMenuOptions),this.menuOptionsFetched=!1),this.render()},renderMenuOptions:function(){var i=this;if(this.items=this.getActiveMenuOptions(),this.items&&0<this.items.length){this.$dropdownList.html("");var t=this.items.filter(function(t){return C.commandManager.canExecute(t.get("commandId"),i.model,t.get("options"),i.parentContext)}),s=t.length;if(0<s){var n=0,d=null;_.each(t,function(t){var e,o=t.get("css_class");(!o||"line"!=o||"line"!=d&&"header"!=d)&&("line"!=o||0!=n&&n!=s-1?(e=i.buildMenuItem(t),i.$dropdownList.append(e)):n+=1,n+=1,d=o)})}}else 0==this.items&&i.$dropdownList.html('<li class="loading"><i class="loading-icon"></i> Loading...</li>');10<i.$dropdownList.outerHeight(!0)&&(C.trigger("todolist:updateHeight",i.$dropdownList.outerHeight(!0)+5),this.ensureVisible(this.$dropdown.outerHeight(!0))),this.menuOptionsFetched=!0},buildMenuItem:function(t){var e,o=C.commandManager.getProperties(t.get("commandId"),this.model,t.get("options"),this.parentContext);o&&o.captionText&&(e=o.captionText);var i=t.get("css_class"),s=y("<li/>");t.id?s.attr("data-itemid",t.id):s.attr("data-itemid",t.cid),t.get("toolTip")&&s.attr("title",t.get("toolTip"));var n=y("<span/>");if(n.addClass("dropdown-list-label"),n.text(e||t.get("captionText")),s.append(n),t.get("imageUrl")){var d=y("<img />");d.addClass("dropdown-list-icon"),t.get("captionText").includes("GitHub")&&d.addClass("GitHub"),d.attr("src",t.get("imageUrl")),s.prepend(d)}if(t.get("color")){var a=y("<span />");a.html("&nbsp;"),a.addClass("list-color menu-item-color"),a.css("background-color",t.get("color")),s.prepend(a)}if(t.get("todoIcon")&&($svg=t.get("todoIcon"),s.prepend($svg)),t.get("checkStateCmd")){var r=C.commandManager.execute(t.get("checkStateCmd"),this.model,t.get("options"),this.parentContext);t.get("todoIcon")?r?s.children().first().addClass("active"):s.children().first().removeClass("active"):r&&s.prepend('<i class="icon icon-check dropdown-list-icon"></i>')}return i&&s.addClass(i),s},getActiveMenuOptions:function(){return!(this.menuItems&&this.menuItems.fetchIfRequired&&this.menuItems.fetchIfRequired(this.model.collection.provider.id))&&this.menuItems},toggleDropdown:function(t){t&&(t.stopPropagation(),t.preventDefault()),this.expanded||C.trigger("globalEvent:closeDropdowns",this),this.loadAllOnExpand&&!this.expanded&&this.showAllAvailableItems(),this.setExpandedState(!this.expanded)},clickMenuItem:function(t){t.preventDefault(),t.stopPropagation();var e=y(t.currentTarget).data("itemid");if(e&&this.items){var i=this.items.get(e);null==i&&(i=this.submenu.items.get(e));var o=i.get("commandId");if(void 0===o)return;var s=this;C.commandManager.getCommandAsync(o).then(function(t){var e=s.isOpen;s.isOpen=!1;var o=t.execute(s.model,i.get("options"),s.parentContext);s.isOpen=e,t.getSubmenu&&(s.submenu=t.getSubmenu()),i.get("checkStateCmd")&&s.renderMenuOptions(),o||s.closeDropdown(),t.getSubmenu&&s.submenu&&(s.listenTo(s.submenu.items,"sync",s.showDropdownDetail),s.submenu.items.fetchIfRequired&&s.submenu.items.fetchIfRequired(s.parentContext.id),s.showDropdownDetail())})}},expandedHeight:function(){return this.expanded?this.$dropdown.outerHeight():0},ensureVisible:function(t){var e=y(this.comparisonNode);if(this.comparisonNode&&this.$dropdown&&this.expanded){var o,i=this.$dropdown.parentsUntil(".todo-item").parent(),s=t;s>e.outerHeight()&&(o=Math.min(s+5,document.body.getBoundingClientRect().height-150),C.trigger("todolist:updateHeight",o));var n=e.offset().top+e.outerHeight()-(i.offset().top+i.outerHeight()+s);n<2?this.$dropdown.css({top:Math.max(e.offset().top-i.offset().top,n+18)+"px",right:"40px"}):this.$dropdown.css({top:"26px"}),this.$dropdown.css({bottom:"auto"}).show()}else this.$dropdown&&!this.expanded&&C.trigger("todolist:updateHeight",0)},showDropdownDetail:function(){if(this.submenu){var i=this,s=y(this.$el.find(".dropdown-detail")[0]);if(s.html(""),this.submenu.items&&0<this.submenu.items.length){s.removeClass("todo-provider-loading"),this.$dropdown.hasClass("todo-actions-dropdown")&&this.$el.find(".dropdown").addClass("provider-submenu");var t=this.submenu.items.length,e=this.submenu.title;e?s.append(y('<li class="dropdown-detail-back dropdown-title">'+e+"</li>")):s.append(y('<li class="dropdown-detail-back dropdown-list-label"><i class="icon icon-left dropdown-detail-title-back"></i></li>'));if(0<t){var n=null,o=this.submenu.items.models.filter(function(t){return C.commandManager.canExecute(t.get("commandId"),i.model,t.get("options"),i.parentContext)});_.each(o,function(t){var e=t.get("css_class");if(!e||"line"!=e||"line"!=n&&"header"!=n){var o=i.buildMenuItem(t);s.append(o),1,n=e}})}var d=this.$el.find(".dropdown-detail").outerHeight(!0);C.trigger("todolist:updateHeight",d),this.$el.find(".dropdown").addClass("show-detail").height(d),setTimeout(function(){i.ensureVisible(d+20)},0)}else s.addClass("todo-provider-loading"),s.append(y('<li class="loading dropdown-detail-back dropdown-title u--no-hover">Loading...</li>')),this.$el.find(".dropdown").addClass("show-detail")}},hideDropdownDetail:function(t){var e=this.$el.find(".dropdown-list").outerHeight(!0);C.trigger("todolist:updateHeight",e+20),this.$el.find(".dropdown").removeClass("show-detail").removeClass("provider-submenu").height("auto");this.ensureVisible(e+20)},removeActiveItemClass:function(){this.$el.find(".active-item").removeClass("highlighted")},addActiveItemClass:function(){this.$el.find(".active-item").addClass("highlighted")},showAllAvailableItems:function(){this.isLoading||(this.isLoading=!0,this.trigger("showAllItems"))},failedLoading:function(){this.menuItems.pop(),this.menuItems.add({captionText:"Trouble connecting... Retry",css_class:"message failed-loading no-icon"})},retryLoadingItems:function(){this.menuItems.pop(),this.menuItems.add({captionText:"Loading...",css_class:"loading-dropdown u--no-hover"}),this.showAllAvailableItems()},refreshItems:function(){this.itemsRefreshed||(this.trigger("refreshItems"),this.itemsRefreshed=!0)}}),x.views.NewTodoInput=Backbone.View.extend({events:{keyup:"handleKeyup",keydown:"handleKeydown"},initialize:function(t){this.parent=t.parent,this.todoList=t.todoList,this.listenTo(C,"todo:loadingStateChange",this.render),this.listenTo(C,"todo:listAdded",this.focusInputField)},render:function(){var t=this.model.activeProvider.selectedList(),e=this.model.activeProvider.selectedProject();if(t){if(t.get("add_hidden"))return this.$el.prop("disabled",!0),void this.$el.prop("placeholder","");if(t.get("todo_type")||e&&e.get("todo_type")){var o="New "+(e.get("todo_type")?e.get("todo_type"):t.get("todo_type"));this.$el.prop("disabled",!1),this.$el.prop("placeholder",o)}else this.$el.prop("disabled",!1),this.$el.prop("placeholder","New Todo")}this.$el.is(":disabled")&&(this.$el.prop("disabled",!1),this.$el.prop("placeholder","New Todo"))},createOnEnter:function(t){if(!this.todoList.isLoading()){var e=this.$el.val();if(e&&0!=e.length&&0!=e.trim().length){var o=this.model.activeProvider.selectedList();if(o){o.changeCount(!0),this.$el[0].value="";var i=t&&(t.ctrlKey||t.metaKey);o.createNewModel({title:e},!1,i)}}}},focusInputField:function(){this.$el.focus()},handleKeyup:function(t){27==t.keyCode&&(t.stopPropagation(),this.$el.blur())},handleKeydown:function(t){var e=null;if(13==t.keyCode?this.createOnEnter(t):32==t.keyCode?e="globalEvent:spacebar":37==t.keyCode?e="globalEvent:arrowLeft":39==t.keyCode&&(e="globalEvent:arrowRight"),e){var o=this.$el.val();o&&0!=o.length&&0!=o.trim().length||(t.preventDefault(),t.stopPropagation(),C.trigger(e,t))}}}),x.views.TodoItem=Backbone.View.extend({attributes:{class:"todo-item"},tagName:"li",template:x.templates.todoitem,events:{"click .todo-item-checkbox":"toggleDone",dblclick:"edit","keypress .editing":"handleInput","keypress .todo-item-title":"handleInput","blur .todo-item-title":"saveEdit","click .error-icon":"retrySave",dragstart:"dragstart",dragenter:"dragenter",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave"},editing:!1,renderedOnce:!1,initialize:function(t){this.parent=t.parent,this.provider=t.provider,this.listId=t.list_id,this.menu_options=t.menu_options,this.selectedList=this.provider.selectedList(),this.isDoneList=this.selectedList.isDoneList(),this.isTodayList=this.selectedList.isTodayList(),this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"todo:edit",this.edit),this.listenTo(this.model,"todo:close",this.toggleDone),this.listenTo(this.model,"todo:open",this.toggleDone),this.listenTo(C,"todo:refresh",this.refreshTodo),this.listenTo(C,"todo:set:done",this.setDone),this.listenTo(C,"globalEvent:esc",this.abortEdit)},refreshTodo:function(t){t==this.model.id&&this.model.fetch()},setDone:function(t,e){t==this.model.id&&this.toggleDone()},render:function(){if(this.selectedList=this.provider.selectedList(),this.isDoneList=this.selectedList.isDoneList(),this.isTodayList=this.selectedList.isTodayList(),this.model.get("deleted"))return this.hideTodoItem(),this;if(!this.isDoneList&&(this.model.get("listId")!=this.listId&&(!this.isTodayList||!this.model.get("today"))||this.model.get("archive")))return this.hideTodoItem(),this;if(this.isDoneList&&!this.model.get("done"))return this.hideTodoItem(),this;if(!this.isTodayList&&!this.isDoneList&&this.model.get("today"))return this.hideTodoItem(),this;if(this.isTodayList&&!this.model.get("today"))return this.hideTodoItem(),this;var t=C.utils.captionFormatter(this.model.getValue("title"));if(this.renderedOnce)this.$title.text(t);else{var e={title:t};this.$el.html(this.template(e)),this.$title=this.$el.find(".todo-item-title").first(),this.$checkbox=this.$el.find(".todo-item-checkbox").first(),this.renderedOnce=!0}if(this.$checkbox.prop("checked",this.model.isTrue("done")),this.$el.toggleClass("done",this.model.isTrue("done")),this.$el.toggleClass("loading",this.model.isTrue("isLoading")),this.$el.toggleClass("failed",this.model.isTrue("saveFailed")),this.$el.attr("data-todo-id",this.model.id),this.model.isTrue("isProxy")?(this.$el.toggle(this.model.isTrue("proxyValid")),this.$el.addClass("isproxy"),this.$el.data("cid",this.model.cid)):!this.selectedList.supportsReordering()&&!this.selectedList.get("boardId")||this.model.get("noMove")||this.$el.prop("draggable","true"),this.menu_options&&"subsection"!=this.model.get("viewType")){var o=y(this.$el.find(".dropdown-container")[0]);this.topMenuDropdownView||(this.topMenuDropdownView=new x.views.TodoDropdownMenu({el:o,iClassName:"icon-ellipsis",dropdownClassName:"todo-item-dropdown",menuItems:this.menu_options,model:this.model,parentContext:this.provider,comparisonNode:this.parent.$el})),this.topMenuDropdownView.render()}return"subsection"==this.model.get("viewType")&&this.$el.addClass("todo-subsection"),this.model.get("viewSectionId")&&this.$el.attr("data-view-section-id",this.model.get("viewSectionId")),this},hideTodoItem:function(){this.$el.html(""),this.$el.hide(),this.stopListening(C,"globalEvent:spacebar"),this.parent&&this.parent.checkForEmptyState()},isHidden:function(){return!this.$el.is(":visible")},scrollIntoView:function(){this.parent.isScrolling&&this.$el[0].scrollIntoView(!1)},destroy:function(){this.stopListening(),this.remove(),this.unbind()},abortEdit:function(){this.editing&&(this.parent.toggleScroll(!0),this.$el.removeClass("editing"),this.$title.text(this.originalText),this.setEditable(this.$title,!1),this.editing=!1)},setEditable:function(t,e){t.attr("contentEditable",e),t.closest(".todo-item").attr("draggable",!e)},saveEdit:function(){if(this.editing){this.$el.removeClass("editing"),this.parent.toggleScroll(!0);var t=this.$title.text();t?0==(t=t.trim()).length?this.abortEdit():this.model.attemptSave({title:t}):this.abortEdit(),this.editing=!1,this.setEditable(this.$title,!1),this.parent.updateHeight()}},retrySave:function(){this.model.isTrue("isProxy")?this.model.targetList&&this.model.targetList.createNewModel(this.model,!0):(this.model.attemptedSaveValues||this.model.pendingReorderData)&&this.model.attemptSave()},edit:function(t){this.editing||(this.originalText=this.$title.text(),t&&t.stopPropagation(),this.$el.hasClass("isproxy")||this.$el.hasClass("loading")||this.$el.hasClass("failed")||(this.editing=!0,this.parent.toggleScroll(!1),this.$el.addClass("editing"),this.setEditable(this.$title,!0),this.$title.get(0).focus(),setEndOfContenteditable(this.$title.get(0)),C.sendEvent("Todo","Activate Edit")))},dragstart:function(t){if(t.stopPropagation(),this.editing||this.topMenuDropdownView&&this.topMenuDropdownView.expanded)return!1;if(t.originalEvent.dataTransfer.effectAllowed="move",t.originalEvent.dataTransfer.setData("todo_id",this.model.id),0==this.model.get("leafNode")){var e=this.$el.cloneNode(!0);e.className="ghost",e.style.position="absolute",e.style.zIndex="-1",e.querySelector(".todo-item-checkbox").style.marginTop="3px",t.currentTarget.appendChild(e),t.originalEvent.dataTransfer.setDragImage(e,t.originalEvent.offsetX-15,t.originalEvent.offsetY+2)}this.parent.dragmode="todo",C.trigger("todo:dragging",this),(this.parent.dragging=this).parent.original_index=this.parent.li_index(this.$el,!0),0!=this.parent.original_index?(this.parent.$preceeding_item=this.previousSiblingTodo(),this.parent.preceedingTodoId=this.previousSiblingTodoId()):(this.parent.$preceeding_item=null,this.parent.preceedingTodoId=null),C.sendEvent("Todo","Reorder")},dragenter:function(t){if(t.stopPropagation(),!this.parent.selectedList.get("reorder"))return!1;if("todo"==this.parent.dragmode){if(!this.isSibling(this.parent.dragging.model))return!0;this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var e=this.parent.$placeholder;return this.parent.$placeholder.css("display","list-item"),e.height(this.parent.dragging.$el.height()),e.after(this.parent.dragging.$el),!1}},isSibling:function(t){return this.model.isSibling(t)},previousSiblingTodo:function(){return this.$el.prevAll("li").not(".placeholder").first()},previousSiblingTodoId:function(){return this.$el.prevAll("li").not(".placeholder").first().data("todo-id")},onMouseEnter:function(t){x.views.todoPane.isHovered=!0,this.listenTo(C,"globalEvent:spacebar",this.invokeDefaultCommand)},onMouseLeave:function(t){this.stopListening(C,"globalEvent:spacebar"),x.views.todoPane.isHovered=!1},invokeDefaultCommand:function(){var e=this,t=this.selectedList.getDefaultCommands();if(t&&0<t.length){var o=_.find(t,function(t){return!!C.commandManager.canExecute(t.commandId,e.model,t.options,e.provider)});o&&(C.commandManager.execute(o.commandId,e.model,o.options,e.provider),this.parent.updateHeight())}},toggleDone:function(t){if(t&&t.stopPropagation(),this.selectedList.has("done_disabled")){t&&t.preventDefault();var e=this.selectedList.get("done_disabled");e.message&&C.trigger("todo:status",e)}else{C.sendEvent("Todo","Done");var o=!this.model.get("done");this.model.attemptSave({done:o,completedDate:o?new Date:null}),this.selectedList.recurseOnDone=!0,(this.selectedList.get("recurse_on_done")&&o||this.selectedList.get("recurse_on_done")&&this.selectedList.get("recurse_on_reopen"))&&this.recurseToggleDone(this.model.id,o),this.topMenuDropdownView.resetMenuItems(),C.trigger("todo:loadingStateChange",null);var i=this.provider.getDoneList();i&&!this.selectedList.isDoneList()&&i.changeCount(o)}},recurseToggleDone:function(t,e){var o=this;this.selectedList.itemCollection.where({parentId:t}).forEach(function(t){t.set({done:e,completedDate:new Date}),o.recurseToggleDone(t.get("id"),e)})},handleInput:function(t){this.editing&&(this.parent.updateHeight(),13==t.keyCode&&(this.saveEdit(),C.sendEvent("Todo","Edit"),t.preventDefault(),t.stopPropagation()),27==t.keyCode&&(t.stopPropagation(),this.abortEdit()))}}),x.views.TodoList=Backbone.View.extend({events:{dragover:"dragover",dragend:"dragend",drop:"drop","click .empty-link":"clickEmptyStateLink","click .empty-title":"clickEmptyTitleLink","click .todo-load-more-button":"loadMore","click .todo-section-collapsible":"toggleSection","click .new-todo-button":"showAndFocusTodoInput"},reordered:!1,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],weekdayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],itemsRendered:!0,initialize:function(){this.scrollingAllowed=!0,this.emptyListGreeting="No todos yet",this.emptyListSubmessage="Add a todo to get started",this.subViews=[],this.isScrolling=!1,this.$loading=y('<span class="message-fill"><i class="loading-icon"></i> Loading...</span>'),this.$inPlaceLoading=y('<span class="message-overlay"><i class="loading-icon"></i> <span class="loading-title">Loading...</span></span>'),this.listenTo(this.model,"change",this.providerChanged),this.listenTo(this.model.project,"change",this.providerChanged),this.listenTo(C,"todo:loadingStateChange",this.handleTodoLoadingStateChange),this.listenTo(C,"todo:providerChanged",this.providerChanged),this.listenTo(C,"todo:showAssignedTodosOnlyChanged",this.showAssignedTodosOnlyChanged),this.listenTo(C,"todolist:updateHeight",this.updateHeight),this.listenTo(C,"todo:loadingStateChange",this.renderLoading),this.listenTo(C,"todo:show-new-todo-button",this.showNewTodoButton),this.listenTo(C,"todo:dragging",this.todoDragging),this.providerChanged();var t=this;y(window).on("resize",function(){t.updateHeight()})},render:function(){if(!this.renderedOnce){this.$placeholder=y("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.renderLoading({status:"loading"});var t=this.getHeightLimit();t&&this.$el.css("max-height",t+"px");var e=localStorage.getItem("todo-list-min-height");this.$el.css("min-height",e||"22px"),this.renderedOnce=!0}this.$el.removeClass().addClass("todo-list");var o=this.model.activeProvider.selectedList(),i=(this.model.activeProvider.selectedProject(),o&&o.get("list_class"));i&&this.$el.addClass(i);var s=this;this.addAll(function(t){s.renderItems(t)})},renderItems:function(t){this.$el.css("max-height",this.$el.outerHeight(!0));var e=this.model.activeProvider.selectedList();t?(this.$el.removeClass("is-empty"),C.trigger("todo:show-input"),e&&e.isDoneList()&&0==this.$el.find(".todo-load-more").length&&(this.lastCount&&this.lastCount==e.itemCollection.length?this.$el.append('<li class="todo-load-more"><span class="todo-load-more-done" style="text">That\'s all!</span></li>'):this.$el.append('<li class="todo-load-more"><span class="button todo-load-more-button">Load More</span></li>'))):this.renderEmptyState();this.$el.css("opacity",1),this.updateHeight(0),e&&!e.itemCollection.loadingFromServer&&this.removeLoading(),this.loadTriggered||(C.trigger(x.info.id+":loadedComplete"),this.loadTriggered=!0)},showAndFocusTodoInput:function(){this.$el.find(".new-todo-button").css({opacity:0}),C.trigger("todo:show-and-focus-input")},showNewTodoButton:function(){this.$el.find(".new-todo-button").css({opacity:1})},showAssignedTodosOnly:function(){this.model.activeProvider.selectedList().showAssignedTodosOnlyChanged()},toggleSubtasks:function(){this.model.activeProvider.selectedList().toggleSubtasks()},toggleShowOld:function(){this.model.activeProvider.selectedList().loadOldCompletedTodos()},loadMore:function(){this.$el.find(".todo-load-more-button").remove(),this.$el.find(".todo-load-more").prepend(this.$inPlaceLoading);var t=this.model.activeProvider.selectedList();this.lastCount=t.itemCollection.length,t.itemCollection.loadMore(this.endDate)},dismissEmptyState:function(){this.emptyStateActive&&(this.$el.find(".empty").hide(),C.trigger("todo:show-input"),this.emptyStateActive=!1)},checkForEmptyState:function(){this.subViews&&(_.every(this.subViews,function(t){return t.isHidden()})&&this.render())},renderEmptyState:function(){var t;this.$el.addClass("is-empty"),this.emptyListGreeting="No todos yet",this.emptyListSubmessage="Add a todo to get started",this.overrideListType=null;var e=this.model.activeProvider.selectedList(),o=this.model.activeProvider.selectedProject();if(e){var i=e&&e.get("list_class");i&&this.$el.addClass(i);var s=e.get("todo_type");e.get("todo_type")&&(this.emptyListGreeting="No "+s+"s yet",this.emptyListSubmessage="Add a new "+s+" to get started",this.overrideListType=s.charAt(0).toUpperCase()+s.slice(1))}var n=o&&o.get("todo_type");if(n&&(this.emptyListGreeting="No "+n+"s yet",this.emptyListSubmessage="Add a new "+n+" to get started",this.overrideListType=n.charAt(0).toUpperCase()+n.slice(1)),e&&e.itemCollection&&e.itemCollection.firstLoadCompleted){var d={};if(e.has("empty_message"))d.message=e.get("empty_message"),d.submessage=e.get("empty_submessage"),d.use_command=!!e.get("empty_command");else if("today"==e.listType()){d.message=this.emptyListGreeting;var a=this.model.activeProvider.selectedProject().getListOfType("inbox");if(a){d.targetListId=a.id;var r=a.get("count");1==r?d.submessage="1 todo in Inbox":1<r?d.submessage=r+" todos in Inbox":(d.submessage="Switch to Inbox",d.message="Add a todo to get started")}}else if("inbox"==e.listType())d.message=this.emptyListGreeting,(t=this.model.activeProvider.selectedProject().getListOfType("today"))&&(d.targetListId=t.id,d.submessage="Switch to Today",d.message="Add a todo to get started");else if("done"==e.listType())d.message="No completed todos yet",(t=this.model.activeProvider.selectedProject().getListOfType("today"))&&(d.targetListId=t.id,d.submessage="Get started in Today");else if(e.showAssignedTodosOnly&&0<e.itemCollection.models.length){var l="No tasks assigned to me";e.get("todo_type")&&(l="No "+e.get("todo_type")+"s assigned to me"),e.get("project")&&e.get("project").get("todo_type")&&(l="No "+e.get("project").get("todo_type")+"s assigned to me"),d.message=l}else d.message=this.emptyListGreeting,d.submessage=this.emptyListSubmessage;d.subMessageClickable=d.targetListId||d.use_comand,d.listType=this.overrideListType||"Todo",C.trigger("todo:hide-input"),this.$el.find("new-todo-button").css({opacity:1}),this.emptyStateActive=!0,this.$el.append(x.templates["todo-list-empty-state"](d)),this.itemsRendered=!0,this.updateHeight(0)}},addedToProxyCollection:function(t,e,o){this.isScrolling||this.$el.addClass("hide-scroll"),this.dismissEmptyState(),this.addOne(t,o?o.at:null)},addOne:function(t,e,o){var i=this,s=null,n=this.model.activeProvider.selectedList();n&&(s=n.todoItemMenuOptions());var d=new x.views.TodoItem({model:t,parent:this,menu_options:s,provider:this.model.activeProvider,list_id:n.id});this.subViews.push(d);var a=d.render().el,r=t.get("parentId");if(r){var l=this.getTodoSubelementContainer(r);l?l.append(a):this.$el.append(a)}else if(1<t.get("depth")){var c=this.$el.find("li").last().attr("data-todo-id"),h=n.itemCollection.where({id:c});if(0<h.length&&(t.get("depth")==h[0].get("depth")&&h[0].get("parentId")&&(c=h[0].get("parentId")),t.get("depth")<=h[0].get("depth")-1&&h[0].get("parentId"))){c=h[0].get("parentId");var p=n.itemCollection.where({id:c});if(p[0].get("parentId")&&(c=p[0].get("parentId")),t.get("depth")==h[0].get("depth")-2&&h[0].get("parentId")){c=p[0].get("parentId");var g=n.itemCollection.where({id:c});g[0].get("parentId")&&(c=g[0].get("parentId"))}}t.set("parentId",c);var u=this.getTodoSubelementContainer(c);u&&u.append(a)}else if(t.get("isProxy")&&n.isDoneList())y(this.$el.find("li.todo-section")[0]).after(a);else if(e||0===e){for(var m=-1,v=this.$el.children(),f=0;m<e;){var w=y(v[f++]);w.hasClass("todo-section")||m++}0<=m?w.before(a):this.$el.prepend(a)}else this.$el.append(a);t.get("isProxy")&&t.get("proxyValid")?(this.isScrolling&&d.scrollIntoView(),this.newTodoAdded=!0,function(){var t=!1;i.addedToTop&&(i.$el.addClass("drop-top-margin"),t=!0);C.trigger("todolist:updateHeight"),y(a).addClass("transition"),setTimeout(function(){t&&i.$el.removeClass("drop-top-margin"),y(a).addClass("visible"),setTimeout(function(){y(a).removeClass("transition")},200)},1)}()):y(a).addClass("visible")},getTodoSubelementContainer:function(t){var e=this.$el.find('[data-todo-id="'+t+'"]');if(e&&0<e.length){var o=y(e[0]).find("ol").first();if(o&&0!=o.length)return y(o);var i=y("<ol>");return y(e[0]).append(i),i}return null},addAll:function(e){var o=this,t=function(){var t=o.addAllNow();e(t)};this.lastLisId!=this.model.activeProvider.selectedList()?(this.lastLisId=this.model.activeProvider.selectedList(),setTimeout(t,200),this.$el.css("opacity",0)):t()},addAllNow:function(){_.each(this.subViews,function(t){t&&t.destroy()});var t=!(this.subViews=[]);this.reordered=!1;var e,i=this;if(this.$el.html(""),e=this.model.activeProvider.selectedList()){var o=e.itemCollection.activeToday(),s=e.proxyCollection.where({proxyValid:!0});0<o.length&&(t=!0),s&&0<s.length&&(t=!0);var n,d=!1,a=e.groupingInfo();if(a){var r=[];if("date"==a.type){if(!_.isEmpty(o)){var l=_.map(o,function(t){var e=t.get(a.field),o=new Date(e);return{sortDate:o.getTime(),year:o.getFullYear(),month:o.getMonth(),day:o.getDate(),item:t}});n=_(l).chain().sortBy("sortDate").reverse().value();var c=null,h=null,p=null;_.each(n,function(t){if(t.year!=c||t.month!=h||t.day!=p){c=t.year,h=t.month,p=t.day;var e=i.formatDate(t),o=e.calendarDate;r.push(o),i.$el.append('<li draggable="false" data-view-section-parent-id="'+o+'" class="todo-section" title="'+e.calendarDate+'">'+e.friendlyDate+"</li>"),t.item.set("viewSectionId",e.calendarDate)}i.addOne(t.item),i.endDate=t.item.get("completedDate")})}d=!0}else if("viewSection"==a.type){var g="";n=_.sortBy(o,function(t){return a.order[t.get("viewSection")]}),_.each(n,function(t){if(t.get("viewSection")!=g){g=t.get("viewSection");r.push(g),i.$el.append('<li data-view-section-parent-id="'+g+'"class="todo-section todo-section-collapsible">'+g.replace("_"," ")+'<svg class="icon-tick" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 292.362 292.362"><path d="M286.935 69.377c-3.614-3.617-7.898-5.424-12.848-5.424H18.274c-4.952 0-9.233 1.807-12.85 5.424C1.807 72.998 0 77.279 0 82.228c0 4.948 1.807 9.229 5.424 12.847l127.907 127.907c3.621 3.617 7.902 5.428 12.85 5.428s9.233-1.811 12.847-5.428L286.935 95.074c3.613-3.617 5.427-7.898 5.427-12.847 0-4.948-1.814-9.229-5.427-12.85z"/></svg></li>')}t.set("viewSectionId",g),i.addOne(t)}),d=!0}r.forEach(function(t){i.updateSectionExpansion(t)})}d||(_.each(o,function(t,e){i.addOne(t,!1,e==o.length-1),i.endDate=t.get("completedDate")},this),_.each(s,function(t){i.addOne(t)},this))}if(t&&(this.itemsRendered=!0),(e=this.model.activeProvider.selectedList())&&(this.addedToTop=e.addedToTop),this.newTodoAdded){var u=this.addedToTop?this.$el.children().first():this.$el.children().last();u&&0<u.length&&this.isScrolling&&u[0].scrollIntoView(!1),this.newTodoAdded=!1,this.addedToTop=!1}return t},updateSectionExpansion:function(t){var e="collapsed-"+this.model.activeProvider.selectedList().id+":"+t,o=C.models.customization.get(e);null==o&&(o=!1),this.$el.find('[data-view-section-id="'+t+'"]').toggleClass("hidden",o),this.$el.find('[data-view-section-parent-id="'+t+'"]').toggleClass("todo-section-collapsed",o),C.trigger("todo:sectionExpansion")},toggleSection:function(t){var e=this.model.activeProvider.selectedList(),o=t.currentTarget.dataset.viewSectionParentId,i="collapsed-"+e.id+":"+o;C.models.customization.set(i,!C.models.customization.get(i)),this.updateSectionExpansion(o),this.updateHeight()},formatDate:function(t){var e=new Date,o=this.monthNames[t.month]+" "+t.day+(e.getFullYear()==t.year?"":", "+t.year);if(t.year==e.getFullYear()&&t.month==e.getMonth()&&t.day==e.getDate())return{friendlyDate:"Today",calendarDate:o};var i=new Date(e.getTime()-864e5);if(t.year==i.getFullYear()&&t.month==i.getMonth()&&t.day==i.getDate())return{friendlyDate:"Yesterday",calendarDate:o};var s=new Date(t.sortDate);return new Date(e.getTime()-5184e5)<s?{friendlyDate:this.weekdayNames[s.getDay()],calendarDate:o}:{friendlyDate:o,calendarDate:""}},clickEmptyStateLink:function(t){if(t&&t.currentTarget){if(t.preventDefault(),t.stopPropagation(),y(t.currentTarget).data("use-command")){var e=this.model.activeProvider.selectedList(),o=e.get("empty_command"),i=e.get("empty_command_options");return void C.commandManager.execute(o,null,i)}var s=y(t.currentTarget).data("target-list-id");s&&this.model.activeProvider.selectList(s)}},clickEmptyTitleLink:function(t){if(t&&t.currentTarget&&(t.preventDefault(),t.stopPropagation(),y(t.currentTarget).text()==this.emptyListGreeting)){var e=this.$el.parent().find(".todo-new")[0];e&&e.focus()}},dragover:function(t){return t.preventDefault(),!(t.originalEvent.dataTransfer.dropEffect="move")},dragend:function(t,e){t.preventDefault(),this.$el.removeClass("dragging"),this.$el.closest(".app").removeClass("has-drop-left has-drop-right");var o=this.$el[0].getBoundingClientRect(),i=t.originalEvent.pageX,s=t.originalEvent.pageY,n=this.dragging.model.id;if(this.move_target_id!=n&&!0!==e){if(i-10<o.right&&i+30>o.left&&s-20<o.top&&o.top-s<40)return void this.drop(t);if(i-10<o.right&&i+30>o.left&&s+20>o.bottom&&s-o.bottom<40)return void this.drop(t)}if("todo"==this.dragmode){var d=this.dragging.$el;"none"==t.originalEvent.dataTransfer.dropEffect&&(null!=this.$preceeding_item?this.$preceeding_item.after(d):this.$el.prepend(d)),this.$placeholder.hide(),d.show(),d.find(".ghost").remove()}return!1},drop:function(t){if(!this.selectedList.get("reorder"))return this.dragend(t,!0),!1;if("todo"==this.dragmode){var e=this.dragging.$el,o=this.dragging.model.id,i=this.move_target_id;if(i==o)return void this.dragend(t);t.preventDefault(),this.$el.closest(".app").removeClass("has-drop-left has-drop-right");var s=this.move_offset;if(0==this.li_index(this.dragging.$el,!0)&&0==this.original_index)return this.dragend(t,!0),!1;if(this.preceedingTodoId==this.dragging.previousSiblingTodoId())return this.$placeholder.hide(),e.show(),!1;var n=this.model.activeProvider.selectedList(),d=n.itemCollection.get(o),a=n.itemCollection.get(i);if(!d||!a||!d.isSibling(a))return!1;this.$placeholder.hide(),e.show(),n.itemCollection.reorderItem({move_id:o,move_target_id:i,move_offset:s,list_id:n.id}),this.reordered=!0}},getTopActiveTodoId:function(){return this.$("li:not(.done, .placeholder, .todo-section, .todo-subsection, .hidden)").first().data("todo-id")},li_index:function(t,e){return e?this.$("li").not(".placeholder").index(t):this.$("li").index(t)},handleManagerChange:function(){this.render()},handleTodoLoadingStateChange:function(t){this.selectedList&&this.selectedList.waitForReorder||t&&"loading"==t.status||this.render()},showAssignedTodosOnlyChanged:function(t){var e=this.model.activeProvider.selectedList();e&&e.id==t&&this.render()},providerChanged:function(){var t=this.model.activeProvider.selectedList();this.selectedList!=t&&(this.itemsRendered=!1,this.selectedList&&this.stopListening(this.selectedList.proxyCollection),(this.selectedList=t)&&this.listenTo(t.proxyCollection,"add",this.addedToProxyCollection)),this.render(),t&&t.supportsFeature("assigned")&&this.listenTo(C.models.customization,"change:assigned-"+t.id,this.showAssignedTodosOnly),t&&(this.listenTo(C.models.customization,"change:subtask-"+t.id,this.toggleSubtasks),this.listenTo(C.models.customization,"change:showOld-"+t.id,this.toggleShowOld))},todoDragging:function(){this.$el.addClass("dragging"),this.isScrolling||this.$el.addClass("hide-scroll")},toggleScroll:function(t){this.scrollingAllowed=t,this.$el.toggleClass("hide-scroll",!t)},updateHeight:function(i){if(!(0<this.lastHeight&&void 0===i)){this.lastHeight=i;var t,e=0,o=this;0==i&&(i=void 0);var s=this.$el;if(s.is(":visible")){var n=this.$el.closest(".app");this.isScrolling?i>s.outerHeight(!0)&&s.addClass("animating"):s.addClass("hide-scroll"),n.addClass("animating"),this.$el.bind("transitionend webkitTransitionEnd",r),setTimeout(r,500);var d=this.getHeightLimit();if(d){if(void 0===i){var a="Firefox"===getBrowserName();if(i=2,this.$loading.parent()&&0==s.children().length)return;s.children().each(function(t,e){var o=y(e);"none"!=o.css("display")&&(i+=a?o.outerHeight(!0)+1:o.outerHeight(!0))});try{x.views.todoPane.todoHeader.projectDropdownView.expanded&&(i=Math.max(x.views.todoPane.todoHeader.projectDropdownView.$dropdown.outerHeight(!0),i)),x.views.todoPane.todoHeader.topMenuDropdownView.expanded&&(i=Math.max(x.views.todoPane.todoHeader.topMenuDropdownView.$dropdown.outerHeight(!0),i))}catch(t){}t=!0,this.contentHeight=i,this.visibleHeight=Math.min(i,d)}i>=s.outerHeight(!0)?(i=Math.min(i,d),this.isScrolling=i==d,e=i+"px",s.parent().css({"min-height":e})):(s.parent().css({"min-height":Math.max(this.visibleHeight,i)+"px"}),e=Math.max(this.visibleHeight,i)+"px"),s.css({"min-height":e}),s.parent().css({"max-height":(t?i:d)+"px"}),s.css({"max-height":(t?i:d)+"px"}),x.views.todoPane&&x.views.todoPane.setStoredHeight(),localStorage.setItem("todo-list-min-height",e)}}}function r(){o.scrollingAllowed&&s.removeClass("hide-scroll"),s.removeClass("animating"),n.removeClass("animating"),o.$el.unbind("transitionend webkitTransitionEnd",r)}},renderLoading:function(t){this.renderedOnce&&this.updateHeight();var e=this;t&&("loading"==t.status?(this.loadingRemoved=!1,setTimeout(function(){e.loadingRemoved||(0<e.subViews.length||e.$el.find(".empty").is(":visible")?(e.$loading.removeClass("message-fill"),e.$loading.addClass("message-overlay u--bg"),t.listChanged||e.$el.parent().append(e.$loading)):(e.$loading.removeClass("message-overlay u--bg"),e.$loading.addClass("message-fill"),e.$el.parent().append(e.$loading)))},10)):"error"==t.status&&setTimeout(function(){e.removeLoading()},20))},removeLoading:function(){this.loadingRemoved=!0,this.$loading.remove(),this.$inPlaceLoading.remove(),this.updateHeight()},isLoading:function(){return 0<this.$loading.parent().length},getHeightLimit:function(){var t=this.$el.closest(".app"),e=t.find(".todo-header").outerHeight(!0);if(!e)return null;var o=t.find(".todo-message").outerHeight(!0)||0,i=t.find(".todo-new").outerHeight()||0,s=y(".top-right").outerHeight(!0)+y(".bottom-right").outerHeight(!0),n=y(".bookmarks-wrapper"),d=0;return n.css("transform")&&(d=parseInt(n.css("height"))-parseInt(n.css("transform").split(",")[5])),document.body.getBoundingClientRect().height-(s+e+o+i+d+4)}}),x.views.TodoListHeader=Backbone.View.extend({events:{"mouseenter .active-list-container":"handleHeaderHover","mouseleave .active-list-container":"handleHeaderLeave","click .active-list-container":"handleHeaderClick","click .project-chooser":"toggleProjectDropdown","click .todo-list-choice":"chooseList","click .control-autofocus":"toggleAutoFocus","click .control-assignee":"toggleAssignee","click #status-action":"statusActionClick"},choosing:!1,initialize:function(t){this.listeningTo=null,this.parent=t.parent,this.listenTo(C,"globalEvent:closeDropdowns",this.stopChoosing),this.listenTo(this.model,"change",this.handleManagerChange),this.listenTo(C,"todo:loadingStateChange",this.handleTodoLoadingStateChange),this.listenTo(C,"todo:providerChanged",this.providerChanged),this.listenTo(C,"todo:changed",this.todoChanged),this.listenTo(C.models.customization,"change:autoFocus",this.autoFocusChanged),this.listenTo(C.models.customization,"change:assigned-"+this.id,this.showAssignedTodosOnlyChanged),this.listenTo(C,"globalEvent:click",this.globalClick),this.listenTo(C,"todo:status",this.renderActiveItem),this.listenTo(C,"todo:topmenu:reset",this.topMenuReset),this.listenTo(C,"todo:resetProjectList",this.resetProjectList),this.listenTo(C,"todo:allProjectsLoaded",this.prepareProjectList),this.defaultColor="rgba(0,0,0,0)",this.model.activeProvider.selectedProject()&&(this.activeList=this.model.activeProvider.selectedProject().listCollection)},render:function(t){var e=this.activeList;e&&this.listeningTo!==e&&(this.listenTo(e,"change",this.handleCollectionChange),this.listeningTo&&this.stopListening(this.listeningTo,"change"),this.listeningTo=e),this.model.activeProvider.get("supportProjects")&&this.prepareProjectList(),this.$activeContainer=this.$el.closest(".header"),this.$chooserContainer=this.$(".list-chooser"),this.renderActiveItem(t);var o=this.model.todoProviderDetails(this.model.activeProvider.id);if(o){if(this.$el.closest(".todo").removeClass(this.providerClass),o.get("provider_title")){var i=o.get("provider_title").indexOf("-");this.providerClass="todo-"+o.get("provider_title").substring(0,0<i?i:o.get("provider_title").length)}this.$el.closest(".todo").addClass(this.providerClass)}},handleHeaderHover:function(t){this.$(".project-chooser").addClass("hover")},handleHeaderLeave:function(t){this.$(".project-chooser").removeClass("hover")},handleHeaderClick:function(t){y(t.currentTarget.parentElement).hasClass("show-external")?(this.handleIconHoverOff(),this.visitExternal()):this.toggleChooser(t,!this.model.activeProvider.get("supportLists"))},visitExternal:function(t){var e=this.model.activeProvider.selectedList().get("url");e||(e=this.providerUrl),getBrowser().tabs.create({url:e})},toggleChooser:function(t,e){t&&(t.preventDefault(),t.stopPropagation()),1<this.model.activeProvider.selectedProject().listCollection.length&&(C.trigger("globalEvent:closeDropdowns",this),this.setChoosingState(!this.choosing)),e&&this.toggleProjectDropdown()},toggleProjectDropdown:function(t){t&&(t.preventDefault(),t.stopPropagation()),this.model.activeProvider.get("supportProjects")&&this.projectDropdownView.toggleDropdown()},globalClick:function(t){t!=this&&this.setChoosingState(!1)},todoChanged:function(t,e){e&&(e.hasOwnProperty("done")||e.hasOwnProperty("listId"))&&this.renderActiveItem()},topMenuReset:function(){this.topMenuDropdownView&&this.topMenuDropdownView.resetMenuItems()},autoFocusChanged:function(t){this.renderActiveItem()},showAssignedTodosOnlyChanged:function(){this.renderActiveItem()},setChoosingState:function(t){if(this.choosing!=t)if(this.choosing=t,this.$(".active-list-container").toggleClass("active",this.choosing),this.choosing){this.$el.closest(".app").css("overflow-y","auto"),C.trigger("todolist:updateHeight",this.$chooserContainer.height());var e=this;setTimeout(function(){e.$chooserContainer.show()},30)}else this.$el.closest(".app").css("overflow-y","hidden"),C.trigger("todolist:updateHeight",0),this.$chooserContainer.hide()},expandedHeight:function(){var t=0,e=0;return this.choosing&&(t=this.$chooserContainer.outerHeight()),this.topMenuDropdownView&&(e=this.topMenuDropdownView.expandedHeight()),_.max([t,e])},stopChoosing:function(t){t!=this&&t!=x.views.todoPane&&this.setChoosingState(!1)},chooseList:function(t){t&&t.stopPropagation(),this.stopChoosing();var e=y(t.currentTarget).data("list-id");this.model.activeProvider.selectList(e)},chooseProject:function(t){t&&t.stopPropagation(),this.stopChoosing();var e=y(t.currentTarget).data("list-id");this.model.activeProvider.selectProject(e)},statusActionClick:function(t){if(t){t.preventDefault(),t.stopPropagation();var e=y(t.currentTarget).data("action");e&&C.commandManager.execute(e,this.lastStatus)}},handleCollectionChange:function(t){var e=t.get("count"),o=this.$el.find("[data-list-id='"+t.id+"']");y(o.find(".todo-count")[0]).text(e);var i=this.model.activeProvider.selectedList();i&&i.id==t.id&&y(this.$el.find(".active-todo-count")[0]).text(e)},handleTodoCountUpdate:function(t,e){var o;if((o=t?this.model.activeProvider.getListById(t):this.model.activeProvider.selectedList())&&o.itemCollection){var i=o.remainingTodoCount();this.$el.find("span.active-todo-count").text(e)}var s=this.$el.find("[data-list-id='"+o.id+"']");y(s.find(".todo-count")[0]).text(i)},renderActiveItem:function(t){if(this.$activeContainer){if(this.model.activeProvider.selectedProject()&&this.model.activeProvider.selectedProject().listCollection){var e={},o={};t||(t=this.model.activeProvider.providerStatus()),t&&"loading"!=(this.lastStatus=t).status&&t.message&&(e.statusMessage=t.message,t.actionMessage&&(e.actionMessage=t.actionMessage),t.action&&(e.action=t.action)),e.supportProjects=this.model.activeProvider.get("supportProjects"),e.no_caps=this.model.activeProvider.get("no_caps");var i=this.model.activeProvider.selectedProject();e.supportLists=void 0===i.get("supportLists")?this.model.activeProvider.get("supportLists"):i.get("supportLists"),this.$el.toggleClass("has-projects",e.supportProjects),this.$el.toggleClass("has-lists",e.supportLists);var s,n,d,a,r,l,c=i.selectedList(),h="task";if(c){var p=c.get("color");e.color=p?p.indexOf("rgb")<0&&"#"!=p.charAt(0)?"#"+p:p:this.defaultColor,e.listTitle=c.get("title"),e.providerLogo=c.get("small_icon_url"),e.remaining=c.remainingTodoCount(),c.get("todo_type")&&(h=c.get("todo_type"))}if(i&&(p=i.get("color"),o.color=p?p.indexOf("rgb")<0&&"#"!=p.charAt(0)?"#"+p:p:this.defaultColor,o.listTitle=i.get("title"),o.providerLogo=i.get("small_icon_url"),i.get("todo_type")&&(h=i.get("todo_type"))),!e.providerLogo&&this.model.activeProvider&&1!=this.model.activeProvider.id&&(s=this.model.todoProviderDetails(this.model.activeProvider.id))&&(e.providerLogo=o.providerLogo=s.get("small_icon_url"),e.providerTitle=o.providerTitle=s.get("provider_title"),this.providerUrl=s.get("provider_url")),!this.compareObjects(e,this.lastContext)||!this.compareObjects(o,this.lastParentContext)){this.lastContext=e,this.lastParentContext=o,s=this.model.todoProviderDetails(this.model.activeProvider.id);var g=x.templates.todolistactive(e);c&&(n=c.supportsFeature("assigned"),d=c.supportsFeature("subtask"),a=c.supportsFeature("showComplete"),r=c.supportsFeature("showArchivedProject"),l=c.supportsFeature("archiveCompleted"),C.models.customization.get("assigned-"+c.id)),this.$activeContainer.html(g),this.$chooserContainer=this.$activeContainer.find(".list-chooser");var u=[];if(s&&s.attributes.provider_url&&u.push({commandId:"todo.visit.external",captionText:"View in "+s.get("provider_title"),options:{urlField:c&&c.get("url")?"url":null,providerUrl:this.providerUrl},todoIcon:'<span class="todo-action"><svg class="icon icon-external" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 438.536 438.536"><path d="M414.41 24.123C398.333 8.042 378.963 0 356.315 0H82.228C59.58 0 40.21 8.042 24.126 24.123 8.045 40.207.003 59.576.003 82.225v274.084c0 22.647 8.042 42.018 24.123 58.102 16.084 16.084 35.454 24.126 58.102 24.126h274.084c22.648 0 42.018-8.042 58.095-24.126 16.084-16.084 24.126-35.454 24.126-58.102V82.225c-.001-22.649-8.043-42.021-24.123-58.102zm-48.961 204.279c0 7.994-3.717 13.606-11.136 16.844-2.471.951-4.859 1.427-7.139 1.427-5.134 0-9.418-1.811-12.847-5.424l-41.11-41.112-152.453 152.462c-3.621 3.614-7.9 5.425-12.85 5.425-4.952 0-9.235-1.811-12.851-5.425l-29.121-29.126c-3.617-3.61-5.426-7.901-5.426-12.847 0-4.944 1.809-9.229 5.426-12.843l152.462-152.464-41.113-41.112c-5.902-5.52-7.233-12.178-3.999-19.985 3.234-7.421 8.852-11.136 16.846-11.136h137.037c4.948 0 9.232 1.81 12.854 5.428 3.613 3.614 5.421 7.898 5.421 12.847v137.041z"/></svg></span>',toolTip:"Open in "+s.get("provider_title")}),s&&this.model.activeProvider.get("supportSubtasks")&&u.push({checkStateCmd:"todo.list.check.state.subtasks",commandId:"todo.list.toggle.subtasks",captionText:"Show subtasks"}),u.push({checkStateCmd:"todo.list.check.state.autofocus",commandId:"todo.toggle.autofocus",captionText:"Autofocus",todoIcon:'<span class="todo-action"><svg class="icon icon-autofocus" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 124.512 124.512" class="icon icon-autofocus"><path d="M113.956 57.006l-97.4-56.2c-4-2.3-9 .6-9 5.2v112.5c0 4.6 5 7.5 9 5.2l97.4-56.2c4-2.401 4-8.2 0-10.5z"/></svg></span>',toolTip:"Automatically set top todo as focus"}),n&&u.push({checkStateCmd:"todo.list.check.state.assigned",commandId:"todo.toggle.assignee",captionText:"Assigned to me",todoIcon:'<span class="todo-action"><svg class="icon icon-assigned" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 60"><path d="M9.56 48.67v2.91c0 4.18 13.21 5.35 20.46 5.4s20.46-1.21 20.46-5.4v-2.91a8.11 8.11 0 0 0-4.23-7.12l-7.81-4.26-.21-.12A2.38 2.38 0 0 1 37 35.08v-3l.26-.36a18.89 18.89 0 0 0 2.89-6.15 3.58 3.58 0 0 0 1.35-2.8V19.2a3.59 3.59 0 0 0-.9-2.36v-4.78a8.06 8.06 0 0 0-1.88-5.87C36.93 4.16 33.85 3.1 30 3c-3.83.08-6.91 1.14-8.69 3.17a8.07 8.07 0 0 0-1.88 5.87v4.78a3.59 3.59 0 0 0-.9 2.36v3.6a3.58 3.58 0 0 0 1.35 2.8 18.89 18.89 0 0 0 2.89 6.15l.26.36v3a2.38 2.38 0 0 1-1.24 2.09l-.21.12-7.81 4.26a8.11 8.11 0 0 0-4.21 7.11z"/></svg></span>',toolTip:"Show assigned to me only"}),(d||a||r||l)&&u.push({css_class:"line"}),d&&u.push({checkStateCmd:"todo.list.check.state.subtasks",commandId:"todo.list.toggle.subtasks",captionText:"Show subtasks",todoIcon:'<span class="todo-action"><svg class="icon icon-subtasks" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500"><path d="M36 387c-19 0-36 16-36 35s17 36 36 36 35-17 35-36-16-35-35-35zM36 215c-19 0-36 16-36 35s17 35 36 35 35-16 35-35-16-35-35-35zM164 110h303c18 0 33-14 33-32s-15-33-33-33H164c-18 0-33 15-33 33s15 32 33 32zM36 42C17 42 0 59 0 78s17 35 36 35 35-16 35-35-16-36-35-36zM467 217H164c-18 0-33 15-33 33s15 33 33 33h303c18 0 33-15 33-33s-15-33-33-33zM467 389H164c-18 0-33 15-33 33s15 33 33 33h303c18 0 33-15 33-33s-15-33-33-33z"/></svg></span>'}),a&&u.push({checkStateCmd:"todo.list.check.state.old.todos",commandId:"todo.list.show.old.todos",captionText:"Show all completed "+h+"s",todoIcon:'<span class="todo-action"><svg class="icon icon-check" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 497.5 497.5"><path d="M487.75 78.125c-13-13-33-13-46 0l-272 272-114-113c-13-13-33-13-46 0s-13 33 0 46l137 136c6 6 15 10 23 10s17-4 23-10l295-294c13-13 13-34 0-47z"/></svg></span>'}),r&&u.push({checkStateCmd:"todo.check.state.archived.projects",commandId:"todo.show.archived.projects",captionText:"Show archived projects",todoIcon:'<span class="todo-action"><svg class="icon icon-archive" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 536.461 536.46"><path d="M144.752 263.52c19.603-9.038 38.354-13.559 56.243-13.559h237.548v-45.683c0-17.511-6.283-32.555-18.85-45.118-12.565-12.562-27.596-18.842-45.11-18.842H219.266v-9.136c0-17.511-6.28-32.548-18.842-45.107-12.563-12.562-27.6-18.846-45.111-18.846h-91.36c-17.511 0-32.548 6.283-45.111 18.846C6.279 98.635 0 113.672 0 131.183v274.084c0 .764.049 1.955.144 3.576.094 1.615.144 2.807.144 3.566l1.426-1.704L97.93 297.637c11.61-13.706 27.218-25.081 46.822-34.117z"/><path d="M528.898 290.214c-5.041-2.478-10.797-3.72-17.272-3.72H200.995c-12.562 0-26.219 3.381-40.968 10.14-14.75 6.766-26.219 14.986-34.401 24.701l-95.93 113.059c-5.902 6.662-8.853 12.945-8.853 18.849 0 5.708 2.523 9.802 7.566 12.272 5.043 2.478 10.8 3.716 17.273 3.716h310.64c12.56 0 26.21-3.381 40.963-10.136 14.75-6.756 26.214-14.989 34.399-24.701l95.931-113.059c5.899-6.663 8.846-12.939 8.846-18.849.004-5.707-2.515-9.797-7.563-12.272z"/></svg></span>'}),l&&u.push({commandId:"todo.list.archive",captionText:"Archive completed tasks",todoIcon:'<span class="todo-action"><svg class="icon icon-archive" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 536.461 536.46"><path d="M144.752 263.52c19.603-9.038 38.354-13.559 56.243-13.559h237.548v-45.683c0-17.511-6.283-32.555-18.85-45.118-12.565-12.562-27.596-18.842-45.11-18.842H219.266v-9.136c0-17.511-6.28-32.548-18.842-45.107-12.563-12.562-27.6-18.846-45.111-18.846h-91.36c-17.511 0-32.548 6.283-45.111 18.846C6.279 98.635 0 113.672 0 131.183v274.084c0 .764.049 1.955.144 3.576.094 1.615.144 2.807.144 3.566l1.426-1.704L97.93 297.637c11.61-13.706 27.218-25.081 46.822-34.117z"/><path d="M528.898 290.214c-5.041-2.478-10.797-3.72-17.272-3.72H200.995c-12.562 0-26.219 3.381-40.968 10.14-14.75 6.766-26.219 14.986-34.401 24.701l-95.93 113.059c-5.902 6.662-8.853 12.945-8.853 18.849 0 5.708 2.523 9.802 7.566 12.272 5.043 2.478 10.8 3.716 17.273 3.716h310.64c12.56 0 26.21-3.381 40.963-10.136 14.75-6.756 26.214-14.989 34.399-24.701l95.931-113.059c5.899-6.663 8.846-12.939 8.846-18.849.004-5.707-2.515-9.797-7.563-12.272z"/></svg></span>'}),u.push({css_class:"line"}),u.push({commandId:"todo.switch.feed",captionText:"Switch to...",css_class:"no-icon"}),u.push({commandId:"todo.show.settings",captionText:"Settings",css_class:"no-icon"}),u=new Backbone.Collection(u),c){var m=y(this.$el.find("#todo-top-menu")[0]);this.topMenuDropdownView&&this.lastProvider==this.model.activeProvider?this.topMenuDropdownView.attachMenuItems(m,u):(this.topMenuDropdownView&&(this.topMenuDropdownView.unbind(),this.topMenuDropdownView.remove()),this.topMenuDropdownView=new x.views.TodoDropdownMenu({el:m,iClassName:"icon-cog",dropdownClassName:"todo-actions-dropdown",menuItems:u,model:c,parentContext:this.model.activeProvider})),this.topMenuDropdownView.render();var v=this.$el.find(".project-chooser");this.projectDropdownView?(this.projectDropdownView.dropdownClassName="project-chooser-dropdown",this.projectDropdownView.providerLogo=s?s.get("small_icon_url"):null,this.projectDropdownView.attachMenuItems(v,this.projectMenuCollection)):(this.projectDropdownView=new x.views.TodoDropdownMenu({el:v,loadAllOnExpand:!0,menuItems:this.projectMenuCollection,dropdownClassName:"project-chooser-dropdown",model:c,parentContext:this.project,providerLogo:s?s.get("small_icon_url"):null,keepOpen:!0}),this.listenTo(this.projectMenuCollection,"failedLoadingItems",this.failedLoadingProjects),this.listenTo(this.projectDropdownView,"refreshItems",this.refreshProjects)),this.projectDropdownView.render(),this.lastProvider=this.model.activeProvider,n=c.supportsFeature("assigned"),this.$activeContainer.find(".control-assignee").toggleClass("disabled",!n),this.$activeContainer.find(".control-autofocus").removeClass("disabled"),this.$activeContainer.toggleClass("has-assignee",n),this.$activeContainer.find(".control-assignee").toggleClass("active",1==C.models.customization.get("assigned-"+c.id))}}this.$activeContainer&&this.$activeContainer.find(".control-autofocus").toggleClass("active",C.models.customization.getComputedSetting("autoFocus"));var f=!c||this.model.activeProvider.selectedProject().listCollection.length<=1;this.$activeContainer.find(".list-chooser-toggle").toggle(!f),this.parent.setMaxWidgetHeight(),this.$activeContainer.toggleClass("momentum-todo",1==this.model.activeProvider.id),this.fetchedAllProjects=!1}this.model.activeProvider.selectedProject()&&this.renderListChooser(this.model.activeProvider.selectedProject().listCollection,this.$chooserContainer,"todo-list-choice")}else{var w=this;setTimeout(function(){w.renderActiveItem(t)},300)}},compareObjects:function(t,e){return t==e||JSON.stringify(t)==JSON.stringify(e)},prepareProjectList:function(){if(!(this.preparing||this.lastPreparedProjects&&this.lastPreparedProjects==this.model.activeProvider.projectCollection&&this.lastPreparedProjects.models[0]==this.model.activeProvider.projectCollection)){var e=this;this.preparing=!0;var o=this.projectItems=[];this.projectMenuCollection||(this.projectMenuCollection=new Backbone.Collection(o)),this.fetchedAllProjects=!0,this.loadingProjects=!1,this.fetchProjectsFailed=!1;var i=this.lastPreparedProjects=this.model.activeProvider.projectCollection,s=this.model.activeProvider.getAllProjects();if(i&&s){if(sortedProjects=i.sortBy("last_active").reverse(),sortedProjects=_.chain(sortedProjects).first(10).value().filter(function(t){return s.get(t.get("id"))}),sortedAllProjects=s.toArray().filter(function(t){return!i.get(t.get("id"))}),1<this.model.activeProvider.id.length){var t=this.model.activeProvider.get("variant_title")||this.model.activeProvider.get("provider_title");o.push({captionText:t,css_class:"provider-name no-icon"})}var n=this.model.activeProvider.selectedProject();if(n)var d=n.selectedList();o.push({captionText:"Recent",css_class:"section-title no-icon"}),_.map(sortedProjects,function(t){o.push({commandId:"todo.switch.parent.project",captionText:t.get("title"),color:t.get("color"),options:{projectId:t.get("id")},css_class:e.model.activeProvider.get("supportProjects")&&n&&n.id==t.get("id")||d&&t.get("id")==d.id?"active-item no-icon":"no-icon",projectId:t.get("id")})}),5<s.length&&o.push({captionText:"Other",css_class:"section-title empty-list no-icon"}),_.map(sortedAllProjects,function(t){var e;for(e in o)if(o[e].projectId==t.get("id"))return;o.push({commandId:"todo.switch.parent.project",captionText:t.get("title"),color:t.get("color"),options:{projectId:t.get("id")},css_class:"no-icon",projectId:t.get("id")})}),this.projectMenuCollection.set(o,{silent:!0}),this.projectMenuCollection.trigger("reset"),this.fetchedAllProjects=this.loadingProjects=!1,this.preparing=!1}else this.preparing=!1}},resetProjectList:function(){var t=this;setTimeout(function(){t.projectDropdownView.resetMenuItems()},250)},failedLoadingProjects:function(){this.fetchedAllProjects=!1,this.loadingProjects=!1,this.fetchProjectsFailed=!0},renderListChooser:function(s,n,d){if(s){var t=s.toArray();n.html("");var a=null;_.map(t,function(t){var e={};e.listId=t.id,e.title=t.get("title"),e.color=t.get("color"),e.count=t.get("count"),e.class=d;var o=t.get("parentTitle");o&&(e.hasParent=!0,o!=a&&(e.parentTitle=o),a=o),t.id==s.selectedList().get("id")&&(e.class="todo-list-choice-active");var i=x.templates.todolistchoice(e);n.append(i).data("list-id",t.id)});var e=x.models.todoListManager.todoProviderDetails(this.model.activeProvider.get("id"));e&&e.get("add_lists")&&(this.addTodoListView||(this.addTodoListView=new x.views.AddTodoList({model:this.model}),this.listenTo(C,"todo:listAdded",this.stopChoosing)),n.append(this.addTodoListView.render().el),this.addTodoListView.delegateEvents())}},handleManagerChange:function(){if(this.topMenuDropdownView){var t=this.model.activeProvider.selectedList();this.topMenuDropdownView.updateModel(t)}this.render()},handleTodoLoadingStateChange:function(t){t!=this.lastStatus&&this.render(t),this.lastStatus=t},providerChanged:function(){this.fetchedAllProjects=!1,this.loadingProjects=!1,this.fetchProjectsFailed=!1,this.render()},handleIconHoverOn:function(){},handleIconHoverOff:function(){},refreshProjects:function(){this.model.activeProvider.refreshAllProjects()}}),x.views.TodoPane=Backbone.View.extend({attributes:{id:"todo",class:"app-container todo"},template:x.templates.todopane,renderedOnce:!1,todoListOpen:!1,events:{"click .Todo-toggle":"toggleShow","dragover .drop-left-zone":"ignoreDragOver","dragover .drop-right-zone":"ignoreDragOver","dragenter .drop-left-zone":"hoverLeftBar","dragenter .drop-right-zone":"hoverRightBar","dragleave .drop-left-zone":"hoverLeftBar","dragleave .drop-right-zone":"hoverRightBar","dragend .drop-right-zone":"dragend","dragend .drop-left-zone":"dragend","drop .drop-right-zone":"drop","drop .drop-left-zone":"drop"},libraryLoadStarted:!1,initialize:function(){this.subViews=[],this.listenToOnce(C,"background:loadSuccessful",this.onBackgroundLoaded),this.listenTo(C,"globalEvent:toggleTodo",this.toggleShow),this.listenTo(C,"globalEvent:toggle:bottom-right",this.onToggleBottomRight),this.listenTo(C,"globalEvent:esc globalEvent:click",this.setTodoStateClosed),this.listenTo(C,"todo:visible",this.todoVisible),this.listenTo(C,"globalEvent:key:shiftN",this.focusOnNewTodo),this.listenTo(C,"globalEvent:key:A",this.focusOnNewTodo),this.listenTo(C,"globalEvent:arrowLeft",this.arrowLeft),this.listenTo(C,"globalEvent:arrowRight",this.arrowRight),this.listenTo(C,"globalEvent:altArrowUp",this.altUp),this.listenTo(C,"globalEvent:altArrowDown",this.altDown),this.listenTo(C,"globalEvent:window:resize",this.windowResize),this.listenTo(C,"todo:hide-input",this.hideInput),this.listenTo(C,"todo:show-input",this.showInput),this.listenTo(C,"todo:show-and-focus-input",this.showAndFocusInput),this.listenTo(C,"todo:hidden",this.todoHidden),this.listenTo(C,"todo:dragging",this.todoDragging),this.listenTo(C,"todo:newProvider",this.openTodo),this.listenTo(C,"todo:providerChanged",this.providerChanged),this.listenTo(C.models.customization,"change:todoVisible",this.visibleChanged),this.render()},render:function(){if(!this.renderedOnce){this.setMaxWidgetHeight();var t=this.template({});this.$el.hasClass("app")&&(this.$el=this.$el.closest(".todo")),this.$popup=this.$(".app-wrapper"),this.$app=this.$(".app"),this.$app.html(t),this.$app.css("height","auto"),this.$listcontainer=this.$el.find(".todo-list")[0],this.$headercontainer=this.$el.find(".todo-header")[0],this.$newTodoFooter=this.$el.find(".new-todo-footer"),this.$newtodoinput=this.$el.find("#todo-new"),this.showTodoList()&&C.models.customization.get("keepTodoState")&&this.setTodoOpenState(!0),this.renderedOnce=!0}var e=this;return setTimeout(function(){e.$el.find(".todo-item").first().find(".dropdown").show()},1e3),x.models.todoListManager||this.initializeManager(),this},showUpsell:function(t){if(this.upsellView)this.upsellView.options=t,this.upsellView.render();else{t.template=C.templates.upsell.appupsell,this.upsellView=new C.views.upsell.message(t);var e=this.upsellView.render().$el;this.$app.append(e)}this.upsellView.show()},showTodoList:function(){var t=localStorage.getItem("showTodoList");return!!t&&JSON.parse(t)},toggleHandler:function(t){this.toggleShow(t)},toggleShow:function(t){t&&"t"===t.key&&t.preventDefault(),C.trigger("globalEvent:closeDropdowns",this),C.trigger("globalEvent:toggle:bottom-left",this),!this.todoListOpen?this.todoVisible():this.todoHidden(),this.setMaxWidgetHeight()},onToggleBottomRight:function(t){t!=this&&this.todoListOpen&&this.todoHidden()},openTodo:function(){this.setTodoOpenState(!0)},setTodoStateClosed:function(t){if(t!=this&&!(t.originalEvent&&"click"==t.type&&t.target&&y.contains(this.$el[0],t.target))){var o=!1;y(".todo-item-title").each(function(t,e){"true"==y(this).attr("contentEditable")&&(o=!0)}),o||C.models.customization.get("keepTodoState")&&"27"!=t.keyCode||this.todoHidden()}},setTodoOpenState:function(t){this.todoListOpen=t,C.models.customization.get("keepTodoState")?localStorage.showTodoList=t:localStorage.showTodoList=!1,1==t?this.showPopup():this.hidePopup(),t?(this.newTodoInput&&this.newTodoInput.focusInputField(),this.doFirstFetch()):this.todoHeader&&this.todoHeader.stopChoosing()},windowResize:function(){this.setMaxWidgetHeight()},setMaxWidgetHeight:function(){var t=y(window).height()-125,e=this.$el.find(".app");if(e){var o=e.find(".active-list").outerHeight(),i=e.find(".todo-message").outerHeight(!0),s=e.find(".todo-new").outerHeight();0==o&&(o=39),null==i&&(i=0),0==s&&(s=38)}return t},showPopup:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in").find(".pane").css("height","auto")},hidePopup:function(){if(this.$el.hasClass("show")){var e=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(t){e.$el.removeClass("show").find(".pane").css("height","auto")})}},hideInput:function(){this.$newTodoFooter.css({visibility:"hidden"})},showInput:function(){this.$newTodoFooter.css({visibility:"visible"})},showAndFocusInput:function(){this.showInput(),this.$newtodoinput.focus()},doFirstFetch:function(){this.initializeManager(),x.models.todoListManager.externallyFetchedOnce=!0,x.models.todoListManager.activeProvider.doFetchIfNeeded()},todoVisible:function(){this.setTodoOpenState(!0)},todoDragging:function(t){if(this.draggingTodo=t,this.hoverCounter=0,!t.model.get("noMove")){var e=x.models.todoListManager.activeProvider.selectedProject().getNeighboringList(-1);e&&e.get("boardId")&&e.get("boardId")==t.selectedList.get("boardId")&&(this.$app.addClass("has-drop-left"),this.$el.find(".left-bar .bar-name").html(e.get("title")));var o=x.models.todoListManager.activeProvider.selectedProject().getNeighboringList(1);o&&o.get("boardId")&&o.get("boardId")==t.selectedList.get("boardId")&&(this.$app.addClass("has-drop-right"),this.$el.find(".right-bar .bar-name").html(o.get("title")))}},getTopTodo:function(){var t=this.manager;if(t&&t.activeProvider&&t.activeProvider.selectedList){var e=t.activeProvider.selectedList();if(e&&e.itemCollection&&(0<e.itemCollection.length||!e.itemCollection.loadingFromServer)){var o=null;if(this.todoList&&this.todoList.reordered){var i=this.todoList.getTopActiveTodoId();i&&(o=e.itemCollection.get(i))}else{var s=_(e.itemCollection.activeToday()).chain().filter(function(t){var e=!1;if(t.get("viewSection")){var o="collapsed-"+t.get("listId")+":"+t.get("viewSection");e=C.models.customization.get(o)}return!t.get("done")&&"subsection"!=t.get("viewType")&&!e}).value();s&&0<s.length&&(o=s[0])}return o}e&&e.itemCollection&&e.itemCollection.doFetchIfNeeded()}},todoHidden:function(){this.setTodoOpenState(!1)},onBackgroundLoaded:function(){this.initializeManager()},initializeManager:function(){x.models.todoListManager||(this.manager=x.models.todoListManager=new x.models.TodoListManager({prefetchTodos:this.todoListOpen||C.models.customization.getComputedSetting("autoFocus")}),C.trigger("todo:managerReady"),this.todoHeader=new x.views.TodoListHeader({el:this.$headercontainer,model:x.models.todoListManager,parent:this}),this.todoList=new x.views.TodoList({el:this.$listcontainer,model:x.models.todoListManager}),this.newTodoInput=new x.views.NewTodoInput({todoList:this.todoList,el:this.$newtodoinput[0],model:x.models.todoListManager}),this.setMaxWidgetHeight())},visibleChanged:function(t){C.models.customization.getComputedSetting("todoVisible")?this.renderedOnce?this.$el.mFadeIn():this.render():this.$el.mFadeOut()},arrowLeft:function(t){this.todoListOpen&&(C.trigger("globalEvent:closeDropdowns"),t.shiftKey?x.models.todoListManager.selectPreviousProvider():x.models.todoListManager.activeProvider&&x.models.todoListManager.activeProvider.selectedProject().selectPreviousList())},arrowRight:function(t){this.todoListOpen&&(C.trigger("globalEvent:closeDropdowns"),t.shiftKey?x.models.todoListManager.selectNextProvider():x.models.todoListManager.activeProvider&&x.models.todoListManager.activeProvider.selectedProject().selectNextList())},altUp:function(t){this.todoListOpen&&(C.trigger("globalEvent:closeDropdowns"),x.models.todoListManager.activeProvider.selectPreviousProject())},altDown:function(t){this.todoListOpen&&(C.trigger("globalEvent:closeDropdowns"),x.models.todoListManager.activeProvider.selectNextProject())},focusOnNewTodo:function(t){this.todoListOpen&&(t&&(t.preventDefault(),t.stopPropagation()),this.newTodoInput.focusInputField())},getHoverInfo:function(t){var e=this,o="dragenter"==t.type;o&&t.preventDefault(),this.hoverCounter+=o?1:-1;var i=0<this.hoverCounter;return i?this.$el.find(".todo-list .placeholder").hide():setTimeout(function(){e.dropListOffset=null},400),i},hoverRightBar:function(t){var e=this.getHoverInfo(t);this.$el.find(".drop-right-zone").toggleClass("hover",e),e&&(this.dropListOffset=1)},hoverLeftBar:function(t){var e=this.getHoverInfo(t);this.$el.find(".drop-left-zone").toggleClass("hover",e),e&&(this.dropListOffset=-1)},dragend:function(t){this.hoverCounter=0,t.preventDefault(),this.$el.find(".todo-list").removeClass("dragging"),this.$el.find(".todo-list .placeholder").hide(),this.$el.find(".drop-left-zone").removeClass("hover"),this.$el.find(".drop-right-zone").removeClass("hover"),this.$app.removeClass("has-drop-left has-drop-right"),this.dropListOffset=null,this.draggingTodo=null},drop:function(t){if(this.$el.find(".todo-list .placeholder").hide(),this.dropListOffset){var e=x.models.todoListManager.activeProvider.selectedProject().getNeighboringList(this.dropListOffset);(new x.commands.TodoMove).execute(this.draggingTodo.model,{target_id:e.id}),this.dragend(t)}else this.dragend(t)},ignoreDragOver:function(t){return t.preventDefault(),!(t.originalEvent.dataTransfer.dropEffect="move")},setStoredHeight:function(){localStorage.setItem("todo-pane-height",this.$el.outerHeight(!0))}}),x.commands.TodoAsanaMoveSectionMenu=C.models.Command.extend({defaults:{id:"todo.asana.move.section.menu"},execute:function(t,e,o){return this.parentContext=o,!0},canExecute:function(t,e){return t.collection.parentList.get("allow_move")},getSubmenu:function(){var s=[],n=this,d=n.parentContext.selectedList().id;return this.parentContext.selectedProject().listCollection.map(function(t){var e=d.substring(0,d.lastIndexOf("-")),o=t.id.substring(0,t.id.lastIndexOf("-"));if(n.parentContext.selectedList().id!=t.id&&o==e){var i={};i.listId=t.id,i.captionText=t.get("title"),i.count=t.get("count"),s.push(i),i.commandId="todo.asana.move.section",i.options={target_id:t.id}}}),{title:null,items:new Backbone.Collection(s)}}}),x.commands.TodoAsanaMoveSection=C.models.Command.extend({defaults:{id:"todo.asana.move.section"},execute:function(t,e){var o={listId:e.target_id};t.attemptSave(o),C.trigger("todo:loadingStateChange",null)},canExecute:function(t,e){return e&&t.get("listId")!=e.target_id}}),x.commands.TodoGithubMoveSectionMenu=C.models.Command.extend({defaults:{id:"todo.github.move.section.menu"},execute:function(t,e,o){return this.parentContext=o,!0},canExecute:function(t,e){return t.collection.parentList.get("allow_move")},getSubmenu:function(){var s=[],n=this,d=n.parentContext.selectedList().id;return this.parentContext.selectedProject().listCollection.map(function(t){var e=d.substring(0,d.lastIndexOf("-")),o=t.id.substring(0,t.id.lastIndexOf("-"));if(n.parentContext.selectedList().id!=t.id&&o==e){var i={};i.listId=t.id,i.captionText=t.get("title"),i.count=t.get("count"),s.push(i),i.commandId="todo.github.move.section",i.options={target_id:t.id}}}),{title:null,items:new Backbone.Collection(s)}}}),x.commands.TodoGithubMoveSection=C.models.Command.extend({defaults:{id:"todo.github.move.section"},execute:function(t,e){var o={listId:e.target_id};t.attemptSave(o),C.trigger("todo:loadingStateChange",null)},canExecute:function(t,e){return!!e&&t.get("listId")!=e.target_id}}),x.commands.TodoMove=C.models.Command.extend({defaults:{id:"todo.move.id"},execute:function(t,e){var o=t.collection.parentList.collection.findWhere({id:e.target_id}),i={};t.collection.parentList.isTodayList()?C.utils.mergeObjects(i,t.getTodayStateChanges(!1)):t.collection.parentList.isDoneList()&&C.utils.mergeObjects(i,t.getDoneStateChanges(!1)),o.isTodayList()?C.utils.mergeObjects(i,t.getTodayStateChanges(!0)):o.isDoneList()&&C.utils.mergeObjects(i,t.getDoneStateChanges(!0)),o.isTodayList()||o.isDoneList()||C.utils.mergeObjects(i,{listId:e.target_id}),t.attemptSave(i),o.changeCount(!0),C.trigger("todo:loadingStateChange",null),setTimeout(function(){o.refreshItems()},200)},canExecute:function(t,e){return!!e&&t.get("listId")!=e.target_id}}),x.commands.TodoDoneAndArchive=C.models.Command.extend({defaults:{id:"todo.done.archive"},execute:function(t,e){t.setDoneState(!0,!0),t.collection.parentList.collection.findWhere({id:"1-done"}).changeCount(!0)},canExecute:function(t,e,o){return!o.selectedList().isDoneList()}}),x.commands.TodoToggleToday=C.models.Command.extend({defaults:{id:"todo.toggle.today"},execute:function(t,e,o){var i=!t.get("today");t.setTodayState(i),"today"!=t.collection.parentList.get("type")&&t.collection.parentList.collection.findWhere({type:"today"}).changeCount(i),"today"==t.collection.parentList.get("type")&&t.collection.parentList.collection.findWhere({id:t.get("homeListId")}).changeCount(!i)},canExecute:function(t,e,o){return!(t.collection.parentList.id==t.get("homeListId")&&t.get("today")||o.selectedList().isDoneList())},getProperties:function(t,e,o){var i=t.collection.parentList.collection.findWhere({id:t.get("homeListId")});return i?{captionText:"Move to "+(t.get("today")?i.get("title"):"Today")}:{captionText:null}}}),x.commands.TodoUnDone=C.models.Command.extend({defaults:{id:"todo.undone"},execute:function(t,e,o){t.get("archive");t.setDoneState(!1),t.collection.parentList.collection.findWhere({id:t.get("homeListId")}).changeCount(!0),C.trigger("todo:loadingStateChange",null)},canExecute:function(t,e,o){return o.selectedList().isDoneList()},getProperties:function(t,e,o){var i=t.collection.parentList.collection.findWhere({id:t.get("homeListId")});return i?{captionText:"Move to "+(t.get("today")?"Today":i.get("title"))}:{captionText:null}}}),x.commands.TodoArchive=C.models.Command.extend({defaults:{id:"todo.archive"},execute:function(t,e,o){t.get("archive");t.setArchiveState(!0),C.trigger("todolist:updateHeight")},canExecute:function(t,e,o){return!o.selectedList().isDoneList()&&t.get("done")}}),x.commands.TodoArchiveAlways=C.models.Command.extend({defaults:{id:"todo.archive.always"},execute:function(t,e,o){t.get("archive");t.setArchiveState(!0),C.trigger("todolist:updateHeight")},canExecute:function(t,e,o){return!0}}),x.commands.TodoDelete=C.models.Command.extend({defaults:{id:"todo.delete"},execute:function(e){e.collection.models.map(function(t){t.get("parentId")==e.get("id")&&t.deleteItem()}),e.deleteItem(),C.trigger("todo:loadingStateChange")},canExecute:function(t,e){return!0}}),x.commands.TodoMoveTo=C.models.Command.extend({defaults:{id:"todo.moveTo"},execute:function(t,e,o){return this.parentContext=o,!0},canExecute:function(t,e){return t.collection.parentList.get("allow_move")},getSubmenu:function(){var o=[],i=this;return this.parentContext.selectedProject().listCollection.map(function(t){if(i.parentContext.selectedList().id!=t.id){var e={};e.listId=t.id,e.captionText=t.get("title"),e.color=t.get("color"),e.count=t.get("count"),o.push(e),t.isDoneList()&&(e.commandId="todo.done.archive"),e.commandId||(e.commandId="todo.move.id"),e.options={target_id:t.id}}}),{title:null,items:new Backbone.Collection(o)}}}),x.commands.TodoSwitchFeed=C.models.Command.extend({defaults:{id:"todo.switch.feed"},execute:function(t,e,o){if(!(this.parentContext=o)){C.commandManager.execute("upsell.message",{targetRegion:"todo",sourceEvent:"integrations",buttonText:"Learn more",title:"Todo Integrations",description:"Sync your todos from other task managers"})}return!0},canExecute:function(t,e){return!0},getSubmenu:function(){if(!this.parentContext)return null;var t=this.parentContext.selectedList().topMenuItems();return t.fetchIfRequired(this.parentContext.id),{title:null,items:t}}}),x.commands.TodoVisitExternal=C.models.Command.extend({defaults:{id:"todo.visit.external"},execute:function(t,e,o){var i=e.providerUrl;return e.urlField&&(i=t.get(e.urlField)||i),getBrowser().tabs.create({url:i}),!0}}),x.commands.TodoToggleAssignee=C.models.Command.extend({defaults:{id:"todo.toggle.assignee"},execute:function(t,e,o){var i="assigned-"+o.selectedList().id;C.models.customization.set(i,!C.models.customization.get(i)),C.trigger("toggleAssignee",i)}}),x.commands.ToggleAutoFocus=C.models.Command.extend({defaults:{id:"todo.toggle.autofocus"},execute:function(t){if(C.conditionalFeatures.featureEnabled("pinfocus"))return C.models.customization.toggle("autoFocus"),C.trigger("toggleAutoFocus",C.models.customization.get("autoFocus")),!0;C.commandManager.execute("upsell.message",{targetRegion:"todo",sourceEvent:"autofocus",buttonText:"Learn more",title:"Autofocus",description:"Automatically display your top to-do in the center of the screen"})}}),x.commands.TodoShowSettings=C.models.Command.extend({defaults:{id:"todo.show.settings"},execute:function(){C.commandManager.executeAsync("settings.display",null,{section:"todo"})}}),x.commands.MenuIgnore=C.models.Command.extend({defaults:{id:"menu.ignore"},execute:function(t){return!0},canExecute:function(t,e){return!0}}),x.commands.TodoDeleteWarn=C.models.Command.extend({defaults:{id:"todo.delete.warn"},execute:function(t){return!0},canExecute:function(t,e){return!0},getSubmenu:function(){return{title:"Delete?",items:new Backbone.Collection([{captionText:"Yes",commandId:"todo.delete"},{captionText:"No",commandId:"menu.ignore",css_class:"dropdown-detail-back"}])}}}),x.commands.TodoFocusPin=C.models.Command.extend({defaults:{id:"todo.focus.pin"},execute:function(t){C.trigger("focus:pin",t)},canExecute:function(t,e){return!t.get("done")}}),x.commands.TodoRetryConnection=C.models.Command.extend({defaults:{id:"todo.connection.retry"},execute:function(t){x.models.todoListManager&&(x.models.todoListManager.doFetchIfNeeded(!0),x.models.todoListManager.activeProvider.refreshTodoItems())}}),x.commands.EditTodo=C.models.Command.extend({defaults:{id:"todo.edit"},execute:function(t){t.trigger("todo:edit")}}),x.commands.CloseTodo=C.models.Command.extend({defaults:{id:"todo.close"},execute:function(t){t.trigger("todo:close")},canExecute:function(t,e){return!t.get("done")}}),x.commands.OpenTodo=C.models.Command.extend({defaults:{id:"todo.open"},execute:function(t){t.trigger("todo:open")},canExecute:function(t,e){return!!t.get("done")}}),x.commands.TodoListDefaultCommand=C.models.Command.extend({defaults:{id:"todo.list.defaultcommand"},execute:function(t,e){return e&&e.get("done")?{captionText:"Archive to Done",commandId:"todo.move.done"}:{captionText:"Move to Today",commandId:"todo.toggle.today",options:{}}}}),x.commands.TodoListArchiveAllDone=C.models.Command.extend({defaults:{id:"todo.list.archive"},execute:function(t,e){if(t&&!t.isDoneList()){var o=t.itemCollection.models;_.each(o,function(t){t.get("done")&&!t.get("archive")&&t.archive()}),C.trigger("globalEvent:closeDropdowns"),C.trigger("todolist:updateHeight")}},canExecute:function(t){if(t&&t.isDoneList())return!1;if(t)var e=t.itemCollection;return!!(e&&0<e.completedCount())}}),x.commands.TodoProviderChange=C.models.Command.extend({defaults:{id:"settings.todo.provider.change"},execute:function(t,e){e&&e.provider_id&&x.models.todoListManager.changeProvider(e.provider_id)},canExecute:function(t,e){return e.provider_id!=x.models.todoListManager.activeProvider.id}}),x.commands.TodoSwitchParentProject=C.models.Command.extend({defaults:{id:"todo.switch.parent.project"},execute:function(t,e){x.models.todoListManager.switchProject(e.projectId)},canExecute:function(t,e){return!0}}),x.commands.TodoListCheckStateAutofocus=C.models.Command.extend({defaults:{id:"todo.list.check.state.autofocus"},execute:function(){return C.models.customization.get("autoFocus")}}),x.commands.TodoListCheckStateAssigned=C.models.Command.extend({defaults:{id:"todo.list.check.state.assigned"},execute:function(t,e,o){if(t){var i=t.get("id");return!!C.models.customization.get("assigned-"+i)}}}),x.commands.TodoListCheckToggleAssigned=C.models.Command.extend({defaults:{id:"todo.list.toggle.assigned"},execute:function(t,e){var o=t.get("id"),i=C.models.customization.get("assigned-"+o);return C.models.customization.set("assigned-"+o,!i),!1}}),x.commands.TodoListCheckStateSubtasks=C.models.Command.extend({defaults:{id:"todo.list.check.state.subtasks"},execute:function(t,e,o){if(t){var i=t.get("id");return 1==C.models.customization.get("subtask-"+i)}}}),x.commands.TodoListToggleSubtasks=C.models.Command.extend({defaults:{id:"todo.list.toggle.subtasks"},execute:function(t,e){var o=t.get("id"),i=C.models.customization.get("subtask-"+o);return C.models.customization.set("subtask-"+o,!i),!1}}),x.commands.TodoListShowOldTasks=C.models.Command.extend({defaults:{id:"todo.list.show.old.todos"},execute:function(t,e,o){var i=t.get("id"),s=C.models.customization.get("showOld-"+i);return C.models.customization.set("showOld-"+i,!s),!1}}),x.commands.TodoListCheckStateOldTodos=C.models.Command.extend({defaults:{id:"todo.list.check.state.old.todos"},execute:function(t,e,o){if(t){var i=t.get("id");return 1==C.models.customization.get("showOld-"+i)}}}),x.commands.TodoShowArchivedProjects=C.models.Command.extend({defaults:{id:"todo.show.archived.projects"},execute:function(t,e,o){var i="archived-"+o.id,s=C.models.customization.get(i);(C.models.customization.save(i,!s),o.get("supportProjects"))?(o.allProjectsCollectionSynced=!1,o.refreshAllProjects(!0)):o.selectedProject().doFetchIfNeeded(!0);return!1}}),x.commands.TodoCheckStateArchivedProjects=C.models.Command.extend({defaults:{id:"todo.check.state.archived.projects"},execute:function(t,e,o){return 1==C.models.customization.get("archived-"+o.id)}}),x.commands.TodoTrelloAuxData=C.models.Command.extend({defaults:{id:"todo.trello.aux"},execute:function(t,e){var o={};return t.collection&&t.collection.parentList&&(o.showAssignedOnly=C.models.customization.get("assigned-"+t.collection.parentList.id)),o}}),x.commands.TodoTrelloOpenConfig=C.models.Command.extend({defaults:{id:"todo.trello.config"},execute:function(){C.commandManager.execute("settings.display",null,{section:"trello"})}}),x.styles.style(),C.widgetManager.handover("todo",null,{region:"top-left",order:"prepend",bootstrap:function(t,e){C.conditionalFeatures.featureEnabled("enhancedtodo")?C.conditionalFeatures.checkFeatureAndMigrateData("servertodos",null,"momentum-todo",function(){x.views.todoPane=new x.views.TodoPane({region:"bottom-right",el:t,order:"append"}),e(x.views.todoPane)},function(){x.collect.legacy.todos=new x.collect.legacy.TodosLegacy,x.views.legacy.todos=new x.views.legacy.Todos({collection:x.collect.legacy.todos,region:"bottom-right",el:t,order:"append"}),e(x.views.legacy.todos)}):C.conditionalFeatures.checkFeatureAndMigrateData("servertodos",null,"momentum-todo",function(){x.collect.legacy.todos=new x.collect.legacy.Todos,x.views.legacy.todos=new x.views.legacy.Todos({collection:x.collect.legacy.todos,region:"bottom-right",el:t,order:"append"}),e(x.views.legacy.todos)},function(){x.collect.legacy.todos=new x.collect.legacy.TodosLegacy,x.views.legacy.todos=new x.views.legacy.Todos({collection:x.collect.legacy.todos,region:"bottom-right",el:t,order:"append"}),e(x.views.legacy.todos)})}}),x};m.addinManager&&m.addinManager.registerAddinFn("51152d18-25db-4040-a8c9-1d1b0b8a4d5b",fn_addin);