/*! Momentum Dashboard - app.min.js
Copyright (c) 2013-2018 Momentum Dashboard Corp. All rights reserved.

All portions of this file are the confidential and proprietary
intellectual property of Momentum Dashboard Corp.

*/
function initializeBookmarksPlaceHolder(){"true"==localStorage.getItem("bookmarksEnabled")&&(document.getElementsByClassName("bookmarks-placeholder")[0].style.display="block",document.body.classList.add("has-bookmarks"))}initializeBookmarksPlaceHolder(),window.m=_.extend({$window:$(window),appView:"",globals:{},models:{},collect:{},views:{},addins:{},utils:{},bootstrappers:{},commands:{},templates:{},widgets:[],appsReady:!1,appsLoaded:!1,startTime:Date.now(),elapsed:function(){return Date.now()-m.startTime}},Backbone.Events),Backbone.View=function(t){return t.extend({constructor:function(e){this.options=e||{},t.apply(this,arguments)}})}(Backbone.View);var backboneSync=Backbone.sync;Backbone.sync=function(e,t,i){(i=i||{}).beforeSend=function(e){setMomentumAuthHeader(e),e.overrideMimeType("application/json")},backboneSync(e,t,i)},m.log="",m.console={},m.console.log=function(e){m.log+=e+"\n"},m.templates=m.templates||{},m.templates.background=m.templates.background||{},m.templates.background["background-info"]=Handlebars.template({1:function(e,t,i,n){return' <i class="icon icon-angle-right"></i> '},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,a,s=t.helperMissing,r="function",l=this.escapeExpression;return'<span class="background-info-title">'+(null!=(o=typeof(a=null!=(a=t.title||(null!=e?e.title:e))?a:s)===r?a.call(e,{name:"title",hash:{},data:n}):a)?o:"")+(null!=(o=t.if.call(e,null!=e?e.hasDetailUrl:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+'</span>\n<span class="background-info-source">\n\t<span class="background-info-source-link" data-url="'+l(typeof(a=null!=(a=t.sourceUrl||(null!=e?e.sourceUrl:e))?a:s)===r?a.call(e,{name:"sourceUrl",hash:{},data:n}):a)+'">'+l(typeof(a=null!=(a=t.attribution||(null!=e?e.attribution:e))?a:s)===r?a.call(e,{name:"attribution",hash:{},data:n}):a)+'</span><span class="control control-heart '+l(typeof(a=null!=(a=t.fav_class||(null!=e?e.fav_class:e))?a:s)===r?a.call(e,{name:"fav_class",hash:{},data:n}):a)+'"><img src="data:image/png;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" data-src="img/icon-heart-empty.svg" class="icon icon-heart-empty"><img src="data:image/png;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" data-src="img/icon-heart.svg" class="icon icon-heart"></span><span class="control control-refresh" title="Next Background"><img src="data:image/png;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" data-src="img/icon-refresh.svg" class="icon icon-refresh"></span>\n</span>\n'},useData:!0}),m.templates.background["background-template-1"]=Handlebars.template({1:function(e,t,i,n){return' <i class="icon icon-angle-right"></i> '},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,a,s=t.helperMissing,r="function",l=this.escapeExpression;return'<span class="background-info-title">'+(null!=(o=typeof(a=null!=(a=t.title||(null!=e?e.title:e))?a:s)===r?a.call(e,{name:"title",hash:{},data:n}):a)?o:"")+(null!=(o=t.if.call(e,null!=e?e.hasDetailUrl:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+'</span>\n<span class="background-info-source">\n\t<span class="background-info-source-link" data-url="'+l(typeof(a=null!=(a=t.sourceUrl||(null!=e?e.sourceUrl:e))?a:s)===r?a.call(e,{name:"sourceUrl",hash:{},data:n}):a)+'">\n\t\t<span>Shot on a </span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 42 24"><path class="a" d="M16.78,13,19.9,0h6.85L23.19,14.75c-.68,2.84-2.82,3.53-4.79,3.53H2.62c-1.73,0-3.19-.74-2.4-4L1.64,8.37A4.44,4.44,0,0,1,6.22,4.71h11l-.89,3.68H10.72c-.83,0-1.28.17-1.51,1.13L8.3,13.28c-.32,1.34.15,1.43,1.15,1.43H14.6C15.54,14.71,16.37,14.66,16.78,13ZM35.35,4.67,32.13,18.23h6.65L42,4.67ZM24.53,15.86a4.31,4.31,0,0,1-4.16,3.54c-.17,0-5.13,0-5.13,0L14.12,24h9.33c2.44,0,6.05-1.24,7.34-6.58l3.1-12.75H27.24Z"/></svg><span class="dji mavic" style="font-weight: 600;"> MAVIC </span><span class="dji air" style="font-weight: 100;">AIR</span>\n\t</span><span class="control control-heart '+l(typeof(a=null!=(a=t.fav_class||(null!=e?e.fav_class:e))?a:s)===r?a.call(e,{name:"fav_class",hash:{},data:n}):a)+'"><img src="img/icon-heart-empty.svg" class="icon icon-heart-empty"><img src="img/icon-heart.svg" class="icon icon-heart"></span><span class="control control-refresh" title="Next Background"><img src="img/icon-refresh.svg" class="icon icon-refresh"></span>\n</span>\n'},useData:!0}),m.templates=m.templates||{},m.templates.centerclock=m.templates.centerclock||{},m.templates.centerclock.clock=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,a=t.helperMissing,s="function",r=this.escapeExpression;return'<div class="time">'+r(typeof(o=null!=(o=t.time||(null!=e?e.time:e))?o:a)===s?o.call(e,{name:"time",hash:{},data:n}):o)+'</div>\n<span class="format">'+r(typeof(o=null!=(o=t.format||(null!=e?e.format:e))?o:a)===s?o.call(e,{name:"format",hash:{},data:n}):o)+"</span>\n"},useData:!0}),m.templates=m.templates||{},m.templates.greeting=m.templates.greeting||{},m.templates.greeting["greeting-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,a=t.helperMissing,s="function",r=this.escapeExpression;return'Good <span class="period">'+r(typeof(o=null!=(o=t.period||(null!=e?e.period:e))?o:a)===s?o.call(e,{name:"period",hash:{},data:n}):o)+'</span>, <span class="name" spellcheck="false">'+r(typeof(o=null!=(o=t.name||(null!=e?e.name:e))?o:a)===s?o.call(e,{name:"name",hash:{},data:n}):o)+"</span>.\n"},useData:!0}),m.templates=m.templates||{},m.templates.metric=m.templates.metric||{},m.templates.metric.widget=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,a=t.helperMissing,s="function",r=this.escapeExpression;return'<div><span class="metric-stat">'+r(typeof(o=null!=(o=t.statvalue||(null!=e?e.statvalue:e))?o:a)===s?o.call(e,{name:"statvalue",hash:{},data:n}):o)+'</span></div><span class="metric-label">'+r(typeof(o=null!=(o=t.statlabel||(null!=e?e.statlabel:e))?o:a)===s?o.call(e,{name:"statlabel",hash:{},data:n}):o)+"</span>"},useData:!0}),m.templates=m.templates||{},m.templates.notification=m.templates.notification||{},m.templates.notification.notification=Handlebars.template({1:function(e,t,i,n){var o,a;return'<div class="notification-title">'+(null!=(o=t.if.call(e,null!=e?e.icon_url:e,{name:"if",hash:{},fn:this.program(2,n,0),inverse:this.noop,data:n}))?o:"")+this.escapeExpression("function"==typeof(a=null!=(a=t.title||(null!=e?e.title:e))?a:t.helperMissing)?a.call(e,{name:"title",hash:{},data:n}):a)+"</div>"},2:function(e,t,i,n){var o;return'<img class="notification-icon" src="'+this.escapeExpression("function"==typeof(o=null!=(o=t.icon_url||(null!=e?e.icon_url:e))?o:t.helperMissing)?o.call(e,{name:"icon_url",hash:{},data:n}):o)+'">'},4:function(e,t,i,n){var o;return'<button class="notification-button">'+this.escapeExpression("function"==typeof(o=null!=(o=t.cta_text||(null!=e?e.cta_text:e))?o:t.helperMissing)?o.call(e,{name:"cta_text",hash:{},data:n}):o)+"</button>"},6:function(e,t,i,n){var o;return'<span class="button-text secondary-text">'+this.escapeExpression("function"==typeof(o=null!=(o=t.secondary_text||(null!=e?e.secondary_text:e))?o:t.helperMissing)?o.call(e,{name:"secondary_text",hash:{},data:n}):o)+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,a;return'<div class="app-wrapper nipple-bottom-left">\n\t<div class="app notification-app">\n\t\t<div class="icon-wrapper notification-hide"><i class="icon">✕</i></div>\n\t\t'+(null!=(o=t.if.call(e,null!=e?e.title:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+'\n\t\t<div class="notification-description">'+this.escapeExpression("function"==typeof(a=null!=(a=t.message||(null!=e?e.message:e))?a:t.helperMissing)?a.call(e,{name:"message",hash:{},data:n}):a)+"</div>\n\t\t"+(null!=(o=t.if.call(e,null!=e?e.cta_cmd:e,{name:"if",hash:{},fn:this.program(4,n,0),inverse:this.noop,data:n}))?o:"")+(null!=(o=t.if.call(e,null!=e?e.secondary_cmd:e,{name:"if",hash:{},fn:this.program(6,n,0),inverse:this.noop,data:n}))?o:"")+"\n\t</div>\n</div>\n"},useData:!0}),m.templates=m.templates||{},m.templates.quote=m.templates.quote||{},m.templates.quote.quote=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,a=t.helperMissing,s="function",r=this.escapeExpression;return'<p class="quote-body">\n\t<span class="quote-body-text">&ldquo;'+r(typeof(o=null!=(o=t.body||(null!=e?e.body:e))?o:a)===s?o.call(e,{name:"body",hash:{},data:n}):o)+'&rdquo;</span><i class="icon-angle-right"></i>\n\t<span class="quote-source"><span class="quote-source-text">'+r(typeof(o=null!=(o=t.source||(null!=e?e.source:e))?o:a)===s?o.call(e,{name:"source",hash:{},data:n}):o)+'</span><span class="control control-heart '+r(typeof(o=null!=(o=t.fav_class||(null!=e?e.fav_class:e))?o:a)===s?o.call(e,{name:"fav_class",hash:{},data:n}):o)+'"><img src="data:image/png;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" data-src="img/icon-heart-empty.svg" class="icon icon-heart-empty"><img src="data:image/png;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" data-src="img/icon-heart.svg" class="icon icon-heart"></span><span class="control control-refresh"><img src="data:image/png;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" data-src="img/icon-refresh.svg" class="icon icon-refresh"></span><span data-url="'+r(typeof(o=null!=(o=t.twitterIntentUrl||(null!=e?e.twitterIntentUrl:e))?o:a)===s?o.call(e,{name:"twitterIntentUrl",hash:{},data:n}):o)+'" class="control control-twitter"><i class="icon icon-twitter"></i></span></span>\n</p>\n'},useData:!0}),m.templates=m.templates||{},m.templates.upsell=m.templates.upsell||{},m.templates.upsell.appupsell=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,a=t.helperMissing,s="function",r=this.escapeExpression;return'<span class="icon-wrapper hide"><i class="icon">✕</i></span>\n<div class="available">Available on Plus</div>\n<div class="title">'+r(typeof(o=null!=(o=t.title||(null!=e?e.title:e))?o:a)===s?o.call(e,{name:"title",hash:{},data:n}):o)+'</div>\n<div class="description">'+r(typeof(o=null!=(o=t.description||(null!=e?e.description:e))?o:a)===s?o.call(e,{name:"description",hash:{},data:n}):o)+'</div>\n<a href="" class="button upsell-action">'+r(typeof(o=null!=(o=t.buttonText||(null!=e?e.buttonText:e))?o:a)===s?o.call(e,{name:"buttonText",hash:{},data:n}):o)+"</a>\n"},useData:!0}),m.templates=m.templates||{},m.templates.widgetmanager=m.templates.widgetmanager||{},m.templates.widgetmanager.metric=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,a=t.helperMissing,s="function",r=this.escapeExpression;return'<div class="view">\n\t<div class="primary">\n\t\t<div class="metric-stat">\n\t\t\t<span class="metric-stat-number">'+r(typeof(o=null!=(o=t.metricValue||(null!=e?e.metricValue:e))?o:a)===s?o.call(e,{name:"metricValue",hash:{},data:n}):o)+'</span><span class="metric-stat-unit">'+r(typeof(o=null!=(o=t.metricUnit||(null!=e?e.metricUnit:e))?o:a)===s?o.call(e,{name:"metricUnit",hash:{},data:n}):o)+'</span>\n\t\t</div>\n\t\t<span class="metric-label">'+r(typeof(o=null!=(o=t.metricLabel||(null!=e?e.metricLabel:e))?o:a)===s?o.call(e,{name:"metricLabel",hash:{},data:n}):o)+'</span>\n\t</div>\n\t<span class="metric-message"></span>\n</div>'},useData:!0}),m.templates.widgetmanager.pane=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,a=t.helperMissing,s="function",r=this.escapeExpression;return'<div class="app-wrapper app-placeholder">\n\t<div class="app '+r(typeof(o=null!=(o=t.appClass||(null!=e?e.appClass:e))?o:a)===s?o.call(e,{name:"appClass",hash:{},data:n}):o)+'" style="height:'+r(typeof(o=null!=(o=t.height||(null!=e?e.height:e))?o:a)===s?o.call(e,{name:"height",hash:{},data:n}):o)+"; width:"+r(typeof(o=null!=(o=t.width||(null!=e?e.width:e))?o:a)===s?o.call(e,{name:"width",hash:{},data:n}):o)+'">\n\t\t<div class="app-placeholder-loading">\n\t\t\t<i class="loading-icon"></i>Loading...\n\t\t</div>\n\t</div>\n</div>\n<span class="app-dash toggle '+r(typeof(o=null!=(o=t.label||(null!=e?e.label:e))?o:a)===s?o.call(e,{name:"label",hash:{},data:n}):o)+'-toggle">'+r(typeof(o=null!=(o=t.label||(null!=e?e.label:e))?o:a)===s?o.call(e,{name:"label",hash:{},data:n}):o)+"</span>\n"},useData:!0});var momoConstants={classInputLengthError:"invalid-length",dateHoursPerDay:24,dateMinsPerDay:1440,dateMinsPerHour:60,dateMsPerDay:864e5,dateMsPerHour:36e5,dateMsPerMin:6e4,dateMsPerSec:1e3,dateRolloverHour:4,dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],keyEscape:27,keyReturn:13,minMarginSmoothScroll:50,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],monthNamesShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],timeContentItemAnimation:200,timeSettingsFade:150,timeSmoothScroll:500,timeToggleClassTwice:100},endPunctChars=[33,34,39,40,41,46,63,91,93,96,123,125,8216,8217,8220,8221,8230];function mConst(e){var t=momoConstants[e];return void 0===t&&console.warn("constant not found:",e),t}function momoInit(){return!0}function validateEmail(e){return/[^@]+@[^@]+\.[^@]+/.test(e)}function getQueryParameter(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))}function toggleLocalStorageBool(e){localStorage[e]="true"===localStorage[e]?"false":"true"}function getLocalStorageBool(e){return"true"===localStorage[e]}function getActiveDateString(){return activeDateStringForDate(new Date)}function activeDateStringForDate(e){var t=new Date(e);return t.getHours()<mConst("dateRolloverHour")&&(t=new Date(t.getTime()-mConst("dateMsPerDay"))),t.getFullYear().toString()+"-"+m.utils.twoDigit(t.getMonth()+1)+"-"+m.utils.twoDigit(t.getDate())}function getActiveLocalDateTimeString(){return activeLocalDateTimeStringForDate(new Date)}function activeLocalDateTimeStringForDate(e){var t=new Date(e);return t.getFullYear().toString()+"-"+m.utils.twoDigit(t.getMonth()+1)+"-"+m.utils.twoDigit(t.getDate())+"T"+m.utils.twoDigit(t.getHours())+":"+m.utils.twoDigit(t.getMinutes())+":"+m.utils.twoDigit(t.getSeconds())}function getDayName(e,t){return mConst("dayNames"+(t?"Short":""))[e.getDay()]}function getMonthName(e,t){return mConst("monthNames"+(t?"Short":""))[e.getMonth()]}function getDaysInMonth(e,t){return new Date(e,parseInt(t)+1,0).getDate()}function dateDiffIntegerDays(e,t){var i=new Date(e.valueOf());return(new Date(t.valueOf()).setHours(0,0,0,0)-i.setHours(0,0,0,0))/mConst("dateMsPerDay")}function dateIsYesterday(e){return-1===m.utils.dateDiffIntegerDays(new Date,e)}function dateIsToday(e){return 0===m.utils.dateDiffIntegerDays(new Date,e)}function dateIsTomorrow(e){return 1===m.utils.dateDiffIntegerDays(new Date,e)}function dateIsInLast7d(e){var t=m.utils.dateDiffIntegerDays(new Date,e);return-7<t&&t<=0}function getFriendlyDate(e){var t,i,n=new Date;return i=(t=e instanceof Date?e:parseIsoDatetime(e)).getFullYear()===n.getFullYear()?"":", "+t.getFullYear(),mConst("monthNamesShort")[t.getMonth()]+" "+t.getDate()+i}function formatYearRelative(e){var t=new Date,i=e.getFullYear();return i===t.getFullYear()?"":", "+i}function formatMonthDayRelative(e,t){return m.utils.dateIsTomorrow(e)?"Tomorrow":m.utils.dateIsToday(e)?"Today":m.utils.dateIsYesterday(e)?"Yesterday":m.utils.getMonthName(e,t)+" "+e.getDate()}function getHoursMinsStr(e,t){void 0===t&&(t=m.models.customization.get("hour12clock"));var i,n=e.getHours();return(t?(i=" "+(n<12?"AM":"PM"),12<n&&(n-=12),0===n&&(n=12),n):(i="",m.utils.twoDigit(n)))+":"+m.utils.twoDigit(e.getMinutes())+i}function parseIsoDatetime(e){var t=e.split(/[: T-]/).map(parseFloat);return new Date(t[0],t[1]-1,t[2],t[3]||0,t[4]||0,t[5]||0,0)}function toUTC(e){return new Date(e.getTime()-e.getTimezoneOffset()*mConst("dateMsPerMin"))}function toLocalTime(e){var t=new Date(e);return new Date(t.getTime()+t.getTimezoneOffset()*mConst("dateMsPerMin"))}function nightsBetween(e,t,i){var n=e,o=t,a=e.valueOf()>=t.valueOf();a&&(n=t,o=e);var s=o.valueOf()-n.valueOf(),r=calcDayMs(n,i)+s,l=Math.floor(r/mConst("dateMsPerDay"));return 0!==l&&a&&(l*=-1),l}function calcDayMs(e,t){var i=e-new Date(e).setHours(0,0,0,0)-t*mConst("dateMsPerHour");return i<0&&(i+=mConst("dateMsPerDay")),i}function dateAdd(e,t,i){var n=new Date(e),o=function(){n.getDate()!==e.getDate()&&n.setDate(0)};switch(t.toLowerCase()){case"year":n.setFullYear(n.getFullYear()+i),o();break;case"quarter":n.setMonth(n.getMonth()+3*i),o();break;case"month":n.setMonth(n.getMonth()+i),o();break;case"week":n.setDate(n.getDate()+7*i);break;case"day":n.setDate(n.getDate()+i);break;case"hour":n.setTime(n.getTime()+36e5*i);break;case"minute":n.setTime(n.getTime()+6e4*i);break;case"second":n.setTime(n.getTime()+1e3*i);break;default:n=void 0}return n}function replaceLastOccurrence(e,t,i){var n=e.lastIndexOf(t);return n?e.slice(0,n)+e.slice(n).replace(t,i):e}function endsWithEndPunct(e){return _.contains(endPunctChars,e.charCodeAt(e.length-1))}function capitalizeFirstLetter(e){return e.slice(0,1).toUpperCase()+e.slice(1)}function twoDigit(e){var t=parseInt(e);return(10<=t?t:"0"+t.toString()).toString()}function getRandomBool(){return getRandomBoolByFrequency(.5)}function getRandomBoolByFrequency(e){return Math.random()<e}function getNextIndex(e,t){return t===e.length-1?0:t+1}function getPrevIndex(e,t){return 0===t?e.length-1:t-1}function getRandomIntInclusive(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function getRandomItem(e){return e[Math.floor(Math.random()*e.length)]}function betweenInclusive(e,t,i){return t<=e&&e<=i}function topPosition(e){return e.offset().top}function rightPosition(e){return e.offset().left+e.outerWidth()}function bottomPosition(e){return e.offset().top+e.outerHeight()}function leftPosition(e){return e.offset().left}function distanceBelow(e,t,i){var n=bottomPosition(e)-bottomPosition(t);return i&&(n+=i),n}function smoothScrollToElement(e,t,i,n,o,a,s){void 0===a&&(a=mConst("timeSmoothScroll")),void 0===s&&(s=mConst("minMarginSmoothScroll")),void 0===n&&(n=0);var r=distanceBelow(e,t,s);setTimeout(function(){0<r?t.animate({scrollTop:r},{duration:a,complete:function(){smoothScrollHelper(e,i,o)}}):smoothScrollHelper(e,i,o)},n)}function smoothScrollHelper(e,t,i){t&&e.addClass("pulse"),i&&i()}function removePulseClass(e){"pulse"!==e.originalEvent.animationName&&"pulselight"!==e.originalEvent.animationName||$(e.target).removeClass("pulse")}function scrollToBottom(e){var t=e[0];t.scrollTop=t.scrollHeight}function toggleClassTwice(e,t){e.toggleClass(t),setTimeout(function(){e.toggleClass(t)},mConst("timeToggleClassTwice"))}function isChrome(){return"chrome"===m.globals.platform}function getBrowserName(){return isChrome()?"Chrome":"Firefox"}function getBrowserVersion(){return parseInt(navigator.userAgent.match(new RegExp("rv:([0-9]+)"))[1])}function getBrowser(){return isChrome()?chrome:browser}function getFavIcon(e){var t=document.createElement("a");t.href=e;var i=t.hostname;if(!i.startsWith("www.")){var n=i.split(".");(n.length<3||3==n.length&&n[1].length<4)&&(i="www."+i)}return"https://icons.duckduckgo.com/ip2/"+i+".ico"}function uuidv4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}function capitalizeWords(e){var i=e.split(" ");return i.forEach(function(e,t){i[t]=e.charAt(0).toUpperCase()+e.slice(1)}),i.join(" ")}function submitStats(e){}function setMomentumAuthHeader(e){if(localStorage.token&&e.setRequestHeader("Authorization","Bearer "+localStorage.token),localStorage.client_uuid&&e.setRequestHeader("X-Momentum-ClientId",localStorage.client_uuid),e.setRequestHeader("X-Momentum-Version",m.globals.version),e.setRequestHeader("X-Momentum-ClientDate",getActiveLocalDateTimeString()),m.conditionalFeatures.featureEnabled("allowoptions")){var t=localStorage.getItem("X-Momentum-Options");t&&e.setRequestHeader("X-Momentum-Options",t)}localStorage.activeTags&&e.setRequestHeader("X-Momentum-Tags",localStorage.activeTags)}function handleDblclickFromDashboard(e){e.manager.dblclickFromDashboard&&(e.manager.dblclickFromDashboard=!1,setTimeout(function(){e.dblclickFromDashboardCb()},0))}function flashInputLengthError(e){toggleClassTwice(e,mConst("classInputLengthError"))}function checkForInputMaxLengthError(e){e.is("input")&&e.val().length>=e.attr("maxlength")&&flashInputLengthError(e)}function updateCharCount(e,t,i,n){var o=$(e.currentTarget.form);n=n||o.find("input");var a=o.find(".char-count"),s=n.val().length,r=t.inputLengthMaxDatabase-s;a.text(r).removeClass("warn over"),a.toggle(s>=t.inputLengthShow),n.removeClass("over"),s>t.inputLengthMaxDatabase?(a.addClass("over"),n.addClass("over")):s>=t.inputLengthWarn&&a.addClass("warn"),i&&i(o,s,r)}function updateListAddFormBorder(e,t){e.toggleClass("no-top-border",t)}function moveCursorToEndOfInput(e){var t=e[0];t.selectionStart=t.selectionEnd=t.value.length}function scrollToEndOfInput(e,t){void 0===t&&(t=0);var i=e[0];i.scrollWidth>i.clientWidth&&(0!==e.scrollLeft()&&e.scrollLeft(0),e.animate({scrollLeft:i.scrollWidth-i.clientWidth},t))}function toggleAdvanced(e){var t=e.$(".button-advanced"),i=e.$(".wrapper-advanced");t.toggleClass("active"),i.is(":visible")?(i.slideUp(300,function(){handleStickySubnav(e)}),setTimeout(function(){i.css("opacity",0)},100)):(i.css("opacity",0).slideDown(300,function(){handleStickySubnav(e)}),setTimeout(function(){i.css("opacity",1)},100))}function sendEventToggleFeed(e,t,i){m.sendEvent(e,t,"turned "+(i?"on":"off"))}function getInitialFeedSettings(e){var t=!0,i=!1;return"false"===localStorage.getItem(e.feedMomentumName)&&(t=!1),"true"===localStorage.getItem(e.feedCustomName)&&(i=!0),{feedMomentumClass:t?"on":"",feedCustomClass:i?"on":""}}function setFeedVars(e){e.$feedMomentumSlider=e.$("#feed-momentum-slider"),e.$feedCustomSlider=e.$("#feed-custom-slider")}function updateFeedSettings(e){var t=e.settings.get(e.manager.feedMomentumName),i=e.settings.get(e.manager.feedCustomName);e.$("#feed-momentum-slider").toggleClass("on",t),e.$("#feed-custom-slider").toggleClass("on",i),localStorage.setItem(e.manager.feedMomentumName,t),localStorage.setItem(e.manager.feedCustomName,i)}function handleStickySubnav(e){if(void 0!==e.subnav){var t=e.$(".settings-subnav"),i=e.$(".settings-subnav-placeholder"),n=(t.hasClass("sticky")?i.position().top:t.position().top)<0,o=m.models.customization.get("themeColour"),a={dark:"rgba(0,0,0,0.85)",light:"rgba(255,255,255,0.95)",custom:m.models.themeManager.getThemeColourRGBA()};i.outerHeight()!==t.outerHeight()&&i.css("height",t.outerHeight()),isChrome()||0===e.$(".subpanel-header").width()||t.css("width",e.$(".subpanel-header").width()),m.conditionalFeatures.featureEnabled("plus")&&t.css("background-color",n?a[o]:{dark:"rgba(0,0,0,0)",light:"rgba(255,255,255,1)",custom:"rgba(0,0,0,0)"}[o]),t.toggleClass("sticky",n),i.toggle(n)}}function scrollToTopStickySubnav(e){e.$(".settings-subnav").hasClass("sticky")&&e.$el.scrollTop(e.$(".settings-subnav-placeholder").position().top+e.$el.scrollTop())}function handleSelectStickySubnav(e){handleStickySubnav(e),scrollToTopStickySubnav(e)}function subnavAddAll(t,i,e,n,o){var a=t.main||t;_.each(t.subViews,function(e){e.destroy()}),t.subViews=[],t.collection.each(function(e){t.addOne(e,i)}),setTimeout(function(){handleStickySubnav(a)},0),t.$empty.removeClass("loading"),t.handleCollectionUpdate(),void 0!==n&&n(t),e.show(),void 0!==o&&o()}function subnavAddOne(e,t,i,n,o){var a=t.render().$el;e.subViews.push(t),n?i.prepend(a):i.append(a),o&&a.hide().slideDown(mConst("timeContentItemAnimation"))}function renderSubnav(e,t,i){e.$(".list-body").hide(),t.render(),e.$(".subnav-titles").find("h4").removeClass("active").siblings("."+i).addClass("active"),t.$el.show(),e.subnav=i}function updateEmptyState(e){e.$empty.toggle(0===e.collection.length)}function subnavHistoryLoadMore(e,t,i){e.stopPropagation(),i.LoadMoreHistory(),subnavHistoryUpdateLoadMore(t)}function subnavHistoryUpdateLoadMore(e){void 0===e&&(e=this),e.$(".load-more").toggle(!!e.collection.load_more)}function handleCollectionUpdateCustom(e,t,i){e.deletingFinalItem?setTimeout(function(){e.deletingFinalItem=!1,e.cancelListAdd(),displayEmptyStateAndAddForm(e,t,i)},mConst("timeContentItemAnimation")):displayEmptyStateAndAddForm(e,t,i)}function displayEmptyStateAndAddForm(e,t,i){t.toggle(i),updateListAddFormBorder(e.$listAddForm,i),handleStickySubnav(e)}function cancelListAdd(e){e.$listAddForm.is(":visible")&&(e.resetListAdd(!0),e.toggleListAddForm())}function changeToEditMode(e,t){triggerItemEditing(e),e.$el.addClass("editing"),t.focus(),moveCursorToEndOfInput(t),scrollToEndOfInput(t,mConst("timeSmoothScroll"))}function handleKeypressEnter(e,t,i){13===e.keyCode?(e.preventDefault(),e.shiftKey||e.ctrlKey||e.metaKey||e.altKey||t()):void 0!==i&&checkForInputMaxLengthError(i)}function handleKeyupEsc(e,t){27===e.keyCode&&(e.stopPropagation(),t())}function triggerItemEditing(e){e.main.itemEditingId=e.model.id,e.manager.trigger("item-editing")}function preventMultipleEdits(e){void 0===e&&(e=this),e.model.id!==e.main.itemEditingId&&returnToViewMode(e)}function getOutOfEditMode(e){e.$el.removeClass("editing"),e.updateTooltip&&e.updateTooltip()}function returnToViewMode(e){void 0===e&&(e=this),e.$el.hasClass("editing")&&e.processEditForm(),e.$(".delete-group").is(":visible")&&e.toggleDeleteConf()}function onDestroyModel(){1===this.main.collection.length&&(this.main.deletingFinalItem=!0),this.$el.slideUp(mConst("timeContentItemAnimation"),_.bind(this.destroy,this))}function toggleDeleteConf(e){var t=e.$(".controls"),i=e.$(".controls > .control"),n=e.$(".delete-group");n.css("display",n.is(":visible")?"none":"flex"),n.is(":visible")&&triggerItemEditing(e),t.toggleClass("delete-clicked"),i.toggle()}function processEditFormBasic(e){var t=e.$input.val().trim();betweenInclusive(t.length,1,e.main.inputLengthMaxDatabase)?(e.model.save({body:t},{wait:!0,success:function(){getOutOfEditMode(e),e.manager.handleItemEdit(e.model)},error:function(){console.error("edit content item error for view:",e)}}),m.sendEvent(e.main.gaTitle,"Edit")):flashInputLengthError(e.$input)}function abortEditBasic(e){e.$input.val(e.model.get("body")),getOutOfEditMode(e)}function deleteItemBasic(e){e.model.destroy({wait:!0,success:function(){e.manager.handleItemDelete(e.model,mConst("timeContentItemAnimation"))},error:function(){console.error("delete content item error for view:",e)}}),m.sendEvent(e.main.gaTitle,"Delete")}function isDateInFuture(e){return Date.parse(e)>Date.parse(new Date)}function setEndOfContenteditable(e){var t,i;document.createRange&&((t=document.createRange()).selectNodeContents(e),t.collapse(!1),(i=window.getSelection()).removeAllRanges(),i.addRange(t))}m.globals.version="1.2.8",m.globals.platform="chrome",m.globals.gaCode="UA-44319322-10",m.globals.gaCodePlus="UA-44319322-13",m.globals.urlRoot="https://api.momentumdash.com/",m.globals.urlRootApi="https://api.momentumdash.com/",m.globals.urlRootLogin="https://login.momentumdash.com/",m.globals.urlRootStats="https://stats.momentumdash.com/",m.globals.urlRootIntegration="https://integration.momentumdash.com/",Handlebars.registerHelper("lower",function(e){return e.toLowerCase()}),m.sendEvent=function(e,t,i,n){m.devTools&&m.devTools.getFeatureDebug("googleAnalytics")&&console.log("GA:",e,"•",t,"•",i,"•",n);var o=m.conditionalFeatures&&m.conditionalFeatures.featureEnabled("plus"),a=o?m.globals.gaCodePlus:m.globals.gaCode;n||(n="event");var s=100;if(isChrome()&&!o&&(s=1),!(100*Math.random()>s))try{var r=sessionStorage?sessionStorage.getItem("ga_sess"):uuidv4();r||(r=uuidv4(),sessionStorage.setItem("ga_sess",r));var l=window.navigator.userLanguage||window.navigator.language,c=window.screen.availWidth+"x"+window.screen.availHeight,d=window.screen.colorDepth,u=window.innerWidth+"x"+window.innerHeight,g=new XMLHttpRequest,h="v=1&tid="+a+"&cid="+r+"&t="+n+"&sf="+s+"&ul="+l+"&sr="+c+"&vp="+u+"&de="+document.characterSet+"&sd="+d+"&aip=1";e&&(h+="pageview"==n?"&dp="+e:"&ec="+e),t&&(h+="&ea="+t),i&&(h+="&el="+i),g.open("POST","https://www.google-analytics.com/collect",!0),g.send(h)}catch(e){}},m.models.Manager=Backbone.Model.extend({}),m.collect.Manager=Backbone.Collection.extend({}),m.models.Addin=Backbone.Model.extend({defaults:{evaluated:!1,processed:!1,processing:!1,lazy:!1}}),m.collect.AddinCollection=Backbone.Collection.extend({model:m.models.Addin}),m.models.AddinManager=Backbone.Model.extend({initialize:function(){var e=this;this.addinCollection=new m.collect.AddinCollection,this.loadDependencyMap(),this.listenTo(this.addinCollection,"add change",this.processPending),setTimeout(function(){e.loadFromAddinObject(!0)},50)},loadEvaluatedAddin:function(e,t){this.addinCollection.add({id:e,evaluated:!0,addInCode:t})},loadPersonalCss:function(){var e=document.createElement("link"),t=$(e);t.attr("rel","stylesheet"),t.attr("href","/css/personal.css"),document.head.appendChild(e)},loadAddin:function(e){this.addinCollection.add({rawCode:e})},loadFromAddinObject:function(e){var i=this,n=!1;_.each(m.addins,function(e,t){n=!0,i.addinCollection.findWhere({id:t})||i.loadEvaluatedAddin(t,e)}),n&&e&&this.processPending()},registerAddinLocalSource:function(e,t){this.addinCollection.findWhere({id:e})||this.addinCollection.add({id:e,path:t})},registerAddinFn:function(e,t){var i=this.addinCollection.findWhere({id:e});i?i.set({evaluated:!0,addInCode:t}):this.addinCollection.add({id:e,evaluated:!0,addInCode:t}),this.trigger("addin:loaded:"+e)},loadDependencyMap:function(){if(!this.localAddins&&!this.localLoadFailed){var e=[],t={},i={},n={};this.dependencies=n;for(var o=0;o<this.configInfo.length;o++){var a=this.configInfo[o],s=a.addin.toLowerCase();s||console.log("addin not found: "+s),e.push(s),t[s]=a.id,i[a.id]=s,a.dependencies&&0<a.dependencies.length&&(n[s]=a.dependencies)}this.localAddins={addins:e,map:t,mapNameToId:i}}},ensureAddinNameLoaded:function(e,t,i,n){if(this.localAddins){var o=e.toLowerCase(),a=this.localAddins.mapNameToId[o];a?this.ensureAddinLoaded(a,t,i,n):console.log("can't find id for addin name"+o)}else console.log("localAddins info not populated in ensureAddinNameLoaded")},ensureAddinLoaded:function(e,t,i,n){var o=this;e=e.toLowerCase();var a=this.addinCollection.get(e);if(!a||!a.get("loaded")&&!a.get("loading")){var s=null;if(this.localAddins){var r=e.toLowerCase();this.localAddins.map[r]&&(s="app/"+r+".js")}if(a&&a.get("loaded"))t&&t(a);else{if(i)try{i()}catch(e){}var l=null;if(!a&&this.dependencies[e]){var c=this.dependencies[e];l=[];for(var d=0;d<c.length;d++){var u=c[d];(h=this.localAddins.mapNameToId[u])&&l.push(h)}}if(a||(a=this.addinCollection.add({id:e,evaluated:!1,processed:!1,lazy:!1,dependencyIds:l})),a.get("loading"))t&&this.listenToOnce(this,"addin:loaded:"+e,function(){t()});else{var g=a.get("dependencyIds");if(g&&0<g.length)for(d=0;d<g.length;d++){var h=g[d],f=this.addinCollection.get(h);if(f&&!f.get("loaded")&&!f.get("loading"))return this.listenToOnce(this,"addin:loaded:"+h,function(){o.ensureAddinLoaded(e,t,i,n)}),void o.ensureAddinLoaded(h,function(){o.ensureAddinLoaded(e,t,i,n)},i,n)}a.set({loading:!0});var p=s||m.globals.urlRootApi+"scripts/"+e;if(m.console.log(m.elapsed()+": script added "+p),t&&this.listenToOnce(this,"addin:loaded:"+e,function(){t()}),!document.getElementById(e)){var v=document.createElement("script");v.type="text/javascript",v.async=!0,v.src=p,v.id=e,document.body.appendChild(v)}}}}},getWidgets:function(){return _.filter(this.configInfo,function(e){return!!e.widget})},getCommands:function(){var i=[];return _.map(this.configInfo,function(e){if(e.commands&&0<e.commands.length)for(var t=0;t<e.commands.length;t++)i.push({id:e.commands[t],addin:e.addin})}),i},getAddinCommands:function(e){return e&&this.addinCollection.get(e).instance.commands||{}},refresh:function(){this.loadFromAddinObject(!0)},processPending:function(){var r=this;this.evaluatePending(),_.each(this.addinCollection.where({evaluated:!0,processed:!1,processing:!1,lazy:!1}),function(e){try{if(e.get("processing")||e.get("processed"))return;var t=e.get("addInCode");if(t){var i={},n=e.get("dependencyIds");if(n&&0<n.length)for(var o=0;o<n.length;o++){var a=n[o],s=r.addinCollection.get(a);if(!s||!s.get("loaded"))return void r.ensureAddinLoaded(a);i[r.localAddins.map[a]]=s.instance}e.set({processing:!0}),e.instance=t(m,$,i),e.set({evaluated:!0,loading:!1,loaded:!0,processing:!0}),r.trigger("addin:loaded:"+e.id),r.trigger("addin:loaded",e.id)}}catch(e){console.log(e)}})},evaluatePending:function(){}}),m.models.AddinManager=m.models.AddinManager.extend({configInfo:[{id:"base_metric",addin:"4535ae4c-33bd-4d4e-b92f-f1193d5060e0"},{widget:!0,placeholderType:"metric",id:"bookmarks",region:"top-bar",order:"prepend",addin:"e80e5480-46a1-4329-a06c-fc90eecb820c",commands:["settings.enableBookmarks"],visibleSetting:"bookmarksVisible"},{widget:!0,placeholderType:"metric",id:"countdown",class:"app-container base-metric metric countdown",region:"top-right",order:"append",addin:"fb230b62-96ce-44b5-87c5-4a563553038b",requiredFeature:"countdown",visibleSetting:"countdownVisible",dependencies:["base_metric"]},{widget:!0,placeholderType:"none",id:"countdown_detail",addin:"f05694d5-c7a1-4e4f-9088-857e12cf03e2",dependencies:["countdown"]},{widget:!0,placeholderType:"metric",id:"dashlinks",class:"app-container links dashlinks",region:"top-left",order:"prepend",addin:"db430020-c088-4c07-8992-09ce22377120"},{widget:!0,placeholderType:"metric",id:"focuses",elementId:"focuses",region:"center-below",order:"append",class:"focuses app-container",addin:"fb230b62-96ce-44b5-87c5-4a563553038f",visibleSetting:"focusVisible"},{addin:"986F6801-CE61-46F7-B309-06DAA735DD7F",widget:!0,placeholderType:"none",immediateLoad:!0,id:"introduction"},{widget:!0,id:"quicklinks",class:"links",dependencies:["links_common"],label:"Links",appClass:"links-app",region:"top-left",order:"prepend",width:240,height:75,openState:"LinksOpen",keepOpenSetting:"linksKeepOpen",placeholderType:"pane",addin:"23c67761-9831-415e-b358-c6844eb6c248",requiredFeature:["!teamLinks"],toggleEvent:"globalEvent:key:L",closeOnEsc:"true",visibleSetting:"linksVisible"},{id:"links_common",class:"links",appClass:"links-app",region:"top-left",order:"prepend",width:240,height:75,addin:"3b23bf88-bde9-40df-bfca-bf20add886c9",toggleEvent:"globalEvent:key:L",closeOnEsc:"true",visibleSetting:"linksVisible"},{widget:!0,placeholderType:"metric",id:"metric",class:"generic-stats metric app-container app-dash add-shadow",region:"top-right",order:"append",addin:"04b1458c-d424-4361-a5fe-eda80ce5a7b2",requiredFeature:"randomWidget"},{widget:!0,placeholderType:"metric",id:"multiclock",class:"app-container base-metric metric multiclock",region:"top-right",order:"append",addin:"DD91D97E-FC83-4FCA-B5CB-D89EB2E1DD0D",requiredFeature:"countdown",visibleSetting:"multiClockVisible",dependencies:["base_metric"]},{widget:!0,placeholderType:"none",id:"multi_clock_detail",addin:"d5593aee-71a4-4844-890b-933d0ce0fdc6",dependencies:["multiclock"]},{widget:!0,id:"notes",label:"Notes",placeholderType:"pane",region:"bottom-right",order:"prepend",storedHeight:"notes-pane-height",openState:"showNotes",width:550,height:520,addin:"23c67761-9831-415e-b358-c6844eb6c244",requiredFeature:"notes",toggleEvent:"globalEvent:key:N",hideEvents:["globalEvent:toggle:bottom-left","globalEvent:toggle:bottom-right","globalEvent:toggle:top-right"],closeOnEsc:!0,visibleSetting:"notesVisible"},{widget:!0,id:"search",class:"app-container search",region:"top-left",order:"append",placeholderType:"metric",addin:"15ee3ec9-f912-485a-84be-a358e676d4a4",visibleSetting:"searchVisible"},{widget:!0,placeholderType:"none",id:"settings",dependencies:["settings_common"],addin:"71b7d6d0-b760-44a8-8417-5fb716e77181",commands:["settings.initialize","settings.display"],elementId:"settings",class:"app-container settings",label:"Settings",appClass:"settings-app",region:"bottom-left",order:"prepend",width:500,height:400,toggleEvent:"globalEvent:key:L",closeOnEsc:"true"},{addin:"D52F5584-5033-4A16-866F-E97C7D7AC826",id:"settings_backgrounds",dependencies:["settings"],commands:["background.custom.uploadfiles","settings.panels.backgrounds"]},{addin:"1E373FA7-A454-4652-8D77-1A4FCC88C069",id:"settings_balance",dependencies:["settings"],commands:["settings.panels.balance"]},{addin:"E464EB61-05CA-4A56-9C17-6A02673AA136",id:"settings_bookmarks",dependencies:["settings","bookmarks"],commands:["settings.panels.bookmarks"]},{addin:"a37f9671-6976-4576-a2c7-2d8c54b1fc99",id:"settings_common"},{addin:"b2b798a2-c7b4-432e-bb4c-432e1c36985e",dependencies:["settings","bookmarks"],commands:["settings.panels.general"],id:"settings_general"},{addin:"DB0B33AA-8ED6-4FFC-B0E0-732A9FF3391D",id:"settings_metrics",dependencies:["settings"],commands:["settings.panels.metrics"]},{addin:"DD106F35-669C-4079-A9E3-82DDC5244D0B",id:"settings_quotes",dependencies:["settings"],commands:["settings.panels.quotes"]},{addin:"270AAED6-337F-433F-9D02-A471B435EADA",id:"settings_todo",dependencies:["settings"],commands:["settings.panels.todo"]},{addin:"C61B7775-7AB8-443A-A6B7-C8C8DE6FC755",dependencies:["settings"],id:"settings_trello",commands:["settings.panels.trello.config"]},{widget:!0,placeholderType:"pane",label:"Todo",id:"todo",width:"320",region:"bottom-right",order:"append",addin:"51152d18-25db-4040-a8c9-1d1b0b8a4d5b",visibleSetting:"todoVisible",openState:"showTodoList",keepOpenSetting:"keepTodoState",toggleEvent:"globalEvent:key:T",appClass:"todo-app",storedHeight:"todo-pane-height",class:"todo",commands:["settings.panels.todo"]},{widget:!0,placeholderType:"metric",id:"weather",class:"app-container weather",region:"top-right",order:"prepend",addin:"ca27cf32-4c08-4e17-8efe-fe8bf27f3b8e",visibleSetting:"weatherVisible"}]}),m.models.Command=Backbone.Model.extend({defaults:{id:null},getId:function(){return this.id},execute:function(){},canExecute:function(){return!0}}),m.CommandManager=m.collect.Manager.extend({model:m.models.Command,initialize:function(){var i=this;this.commandSources=new Backbone.Collection,m.commands&&_.mapObject(m.commands,function(e){i.registerCommandModel(e,!1)});for(var e=m.addinManager.getCommands(),t=0;t<e.length;t++)this.registerCommandSource(e[t]);this.listenTo(m.addinManager,"addin:loaded",function(e){var t=m.addinManager.getAddinCommands(e);t&&_.mapObject(t,function(e){i.registerCommandModel(e,!1)})})},registerCommandModel:function(e,t){var i=new e;if(i&&i.id){if(t||!this.get(i.id)){var n=this.get(i.id);n&&this.remove(n),this.add(i)}this.trigger("command:loaded:"+i.id)}},registerCommandSources:function(e){e&&0<e.length&&_.each(e,this.registerCommandSource,this)},registerCommandSource:function(e){if(!e.id)throw new Error("An id property is required in cmdSrc");if(!e.addin)throw new Error("An addin property is required in cmdSrc");this.commandSources.findWhere({id:e.id})||this.commandSources.add({id:e.id,addin:e.addin})},registerCommand:function(e,t,i,n){var o={defaults:{id:e},execute:t};i&&(o.canExecute=i);var a=m.models.Command.extend(o);this.registerCommandModel(a,n)},getCommand:function(e){return e?this.get(e):null},ensureCommandLoaded:function(t,i,n,o){var a=this,s=this.get(t);if(s)i&&i(s);else{if(n)try{n()}catch(e){}var r=this.commandSources.get(t);if(r){var e=r.get("addin");r.get("loading")||(r.set("loading",!0),this.listenToOnce(this,"command:loaded:"+t,function(){r.set("loading",!1),r.set("loaded",!0),i&&i()}),m.addinManager.ensureAddinLoaded(e,function(){},n,function(e){r.set("loading",!1),o&&o(e)}))}else url=m.globals.urlRootApi+"commands/"+encodeURIComponent(t),$.ajax({url:url,beforeSend:m.utils.setMomentumAuthHeader,success:function(e){e&&(a.registerCommandSource(e),(r=a.commandSources.get(t))?r.get("loading")||(r.set("loading",!0),m.addinManager.ensureAddinLoaded(r.get("addin"),function(){r.set("loading",!1),r.set("loaded",!0),i&&i(s)},n,function(e){r.set("loading",!1),o&&o(e)})):o&&o("no command with that id is registered"))},error:function(e){o&&o("no command with that id is registered")}})}},execute:function(e){var t=this.getCommand(e);if(t)return t.execute.apply(t,[].slice.call(arguments,1))},executeAsync:function(n){var o=this,a=[].slice.call(arguments,1);return new Promise(function(t,i){o.ensureCommandLoaded(n,function(){var e=o.getCommand(n);e?t(e.execute.apply(e,a)):i()})})},getCommandAsync:function(n){var o=this;[].slice.call(arguments,1);return new Promise(function(t,i){o.ensureCommandLoaded(n,function(){var e=o.getCommand(n);e?t(e):i()})})},canExecute:function(e){var t=this.getCommand(e);return!t||t.canExecute.apply(t,[].slice.call(arguments,1))},getProperties:function(e){var t=this.getCommand(e);return!t||!t.getProperties||t.getProperties.apply(t,[].slice.call(arguments,1))}}),m.models.ThemeManager=Backbone.Model.extend({initialize:function(){},defaultFontFamily:'-apple-system, BlinkMacSystemFont, "Neue Haas Grotesk Text Pro", "Helvetica Neue", Helvetica, Arial, sans-serif',initializeThemes:function(){this.listenTo(m.models.customization,"change:themeColour",this.setThemeColour),this.listenTo(m.models.customization,"change:themeFont",this.setThemeFont),this.listenTo(m,"user:successfulLogin user:successfulLogout",this.onLoginEvent),this.loadAllThemeValues()},loadAllThemeValues:function(){this.loadThemeColour(),this.setThemeColour(),this.setThemeFont()},setColorValues:function(e,t){this.colors=t,this.setThemeColour()},saveThemeColour:function(){this.colors&&m.models.customization.set("themeColourCustom",this.toRgbA(this.colors))},loadThemeColour:function(){try{if(m.models.customization.has("themeColourCustom")){var e=m.models.customization.get("themeColourCustom");e&&(this.colors=new Colors({color:e}).colors)}}catch(e){}},getThemeColour:function(){return this.colors},getThemeColourRGBA:function(){return this.colors?this.toRgbA(this.colors):null},setThemeColour:function(){var e,t=$("body"),i=$("head");if(t.removeClass("light"),m.conditionalFeatures.featureEnabled("plus")){var n=m.models.customization.get("themeColour");if("light"==n)t.addClass("light"),e=".dropdown, .u--bg { background-color: #ededed; }";else if("dark"==n)e=".dropdown, .u--bg { background-color: #333; }";else if("custom"==n&&this.colors){var o=.5<this.colors.RGBLuminance,a=this.toRgbA(this.composite(this.colors,o));e=(e=(e=(e=(e=".app, .dropdown.dash-dropdown { background-color: "+this.toRgbA(this.colors)+" !important; }")+".dropdown, .u--bg { background-color: "+a+" !important; }")+".nipple-bottom-left:after, .nipple-bottom-right:after { border-top-color: "+this.toRgbA(this.colors)+" !important}")+".nipple-top-left:after, .nipple-top-right:after { border-bottom-color: "+this.toRgbA(this.colors)+" !important}")+'[class*="nipple-"].u--bg:after { border-bottom-color: '+a+" !important; border-top-color: "+a+" !important;}",t.toggleClass("light",o)}this.$themeColourCustom?this.$themeColourCustom.html(e):(i.append('<style type="text/css" id="themeColourCustom">'+e+"</style>"),this.$themeColourCustom=i.find("#themeColourCustom").first())}else this.$themeColourCustom&&(this.$themeColourCustom.remove(),this.$themeColourCustom=null)},toRgbA:function(e){return"rgba("+Math.round(255*e.rgb.r)+","+Math.round(255*e.rgb.g)+","+Math.round(255*e.rgb.b)+","+e.alpha+")"},composite:function(e,t){var i,n,o,a=t?0:1;return i=.8*e.rgb.r+.2*a,n=.8*e.rgb.g+.2*a,o=.8*e.rgb.b+.2*a,new Colors({color:"rgb("+Math.round(255*i)+","+Math.round(255*n)+","+Math.round(255*o)+")"}).colors},getAvailableFonts:function(){return[{label:"Classic",value:"default"},{label:"Modern",value:"modern"},{label:"Startup",value:"startup",breakafter:!0},{label:"Retro",value:"retro"},{label:"Warehouse",value:"warehouse"},{label:"Quirky",value:"quirky"}]},setThemeFont:function(){var t=this,i=m.models.customization.get("themeFont")||"default";if(m.conditionalFeatures.featureEnabled("plus")){var n=this.defaultFontFamily;if(i&&"default"!=i){var e=null,o=localStorage.getItem("font-"+i);if(o)e=JSON.parse(o),n=this.setFontFromInfo(e)||this.defaultFontFamily,this.setActiveFont(n,i);else try{$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"fonts/"+i}).done(function(e){e&&(localStorage.setItem("font-"+i,JSON.stringify(e)),n=t.setFontFromInfo(e)||t.defaultFontFamily)}).fail(function(e,t){}).always(function(){t.setActiveFont(n,i)})}catch(e){}}else this.setActiveFont(n,i)}else this.setActiveFont(this.defaultFontFamily,i)},setFontFromInfo:function(e){var t=null;if(e){if(!e.builtin){var i=$("head"),n=i.find("#font-"+e.font).first();if(!n||0==n.length){var o=null;e.fontInline?(o=$('<style type="text/css"></style>')).html(e.fontInline):e.fontUrl&&(o=$('<link rel="stylesheet" type="text/css">')).attr("href",e.fontUrl),o&&(o.attr("id","font-"+e.font),i.append(o))}}t=e.exclude_default?e.fontFamily:e.fontFamily+","+this.defaultFontFamily}return t},setActiveFont:function(e,t){var i="body, input, select, textarea, button {font-family: "+e+"; !important}",n=document.createElement("style"),o=$(n);o.attr("type","text/css"),document.head.appendChild(n),n.sheet.insertRule(i,0),o.attr("id","font-override");var a=$("body");_.each(this.getAvailableFonts(),function(e){e.value==t?a.addClass("f--"+e.value):a.removeClass("f--"+e.value)}),$user=$(".user"),$user.hasClass("open")||$user.css("transform","translateY("+$("user-hidden").height()+"px)")},onLoginEvent:function(){this.listenToOnce(m,"sync:settings:complete",this.loadAllThemeValues)}}),m.models.SyncCoordinator=Backbone.Model.extend({initialize:function(){this.downloading={},this.syncSettingsInProgress=!1,this.listenTo(m,"sync:download",this.doDownload),this.listenTo(m,"client:id_created",this.onClientIdCreated),this.listenTo(m,"user:successfulLogin",this.onUserLogin),this.listenTo(m,"user:successfulLogout",this.syncSettings),this.listenTo(m,"sync:downloadIfNeeded",this.doDownloadIfNeeded),this.listenTo(m.models.customization,"change",this.customizationChange),this.listenTo(m,"sync:customization",this.customizationChange),m.models.customization.get("etag")||this.customizationChange()},onUserLogin:function(e){this.doDownload(),this.syncSettings(e)},doDownload:function(e){this.downloading={};try{var o=this,t="";if(m.collect.backgrounds.get(getActiveDateString())&&(t+="b"),m.collect.quotes.get(getActiveDateString())&&(t+="q"),!localStorage.client_uuid)return;var i=m.globals.urlRootApi+"feed/bulk?syncTypes=";if(e){var n=[];-1<e.indexOf("quote")&&(n[n.length]="quote",localStorage.removeItem(o.ddlQuoteString()),this.downloading.quote=!0),-1<e.indexOf("background")&&(this.downloading.background=!0,n[n.length]="background",localStorage.removeItem(o.ddlBackgroundString())),0<n.length?i+=n.join(","):(this.downloading.background=!0,this.downloading.quote=!0,i+="all")}else this.downloading.background=!0,this.downloading.quote=!0,i+="all",localStorage.removeItem(o.ddlBackgroundString()),localStorage.removeItem(o.ddlQuoteString());if(i=i+"&localDate="+getActiveDateString(),0<t.length&&(i+="&has="+t),!localStorage.firstSynchronized){var a=m.models.activeBackground.activeBackgroundUuid();if(!a){var s=m.collect.legacyBackgrounds.getCurrentLocalBackground();s&&(a=s.backgroundUuid())}a&&(i=i+"&legacyBackground="+a)}var r=this;$.ajax({type:"GET",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:i}).done(function(e){r.downloading={},e.quotes&&(0<e.quotes.length&&(m.collect.quotes.reset(e.quotes),m.collect.quotes.invoke("save"),localStorage.shortquote&&localStorage.removeItem("shortquote")),e.ts_quotes&&localStorage.setItem("ts_quotes",JSON.stringify(e.ts_quotes)),localStorage.setItem(o.ddlQuoteString(),Date.now())),e.backgrounds&&(0<e.backgrounds.length&&(m.collect.backgrounds.reset(e.backgrounds),m.collect.backgrounds.invoke("save"),localStorage.background&&(localStorage.removeItem("background"),localStorage.removeItem("backgrounds"))),e.ts_backgrounds&&localStorage.setItem("ts_backgrounds",JSON.stringify(e.ts_backgrounds)),localStorage.setItem(o.ddlBackgroundString(),Date.now())),localStorage.setItem("firstSynchronized",Date.now())}).fail(function(e,t){if(r.downloading={},0<e.status){var i=m.models.backgroundManager.latestBackgroundDate();i&&i>Date.parse(getActiveDateString())&&localStorage.setItem(o.ddlBackgroundString(),Date.now());var n=m.models.quoteManager.latestQuoteDate();n&&n>Date.parse(getActiveDateString())&&localStorage.setItem(o.ddlQuoteString(),Date.now())}else m.trigger("sync:error")})}catch(e){r.downloading={}}},doDownloadIfNeeded:function(e){var t=!1,i=!1;if(e){if(e.ts_backgrounds){var n=localStorage.getItem("ts_backgrounds");n?e.ts_backgrounds>JSON.parse(n)&&(t=!0):t=!0}if(e.ts_quotes){var o=localStorage.getItem("ts_quotes");o?e.ts_quotes>JSON.parse(o)&&(i=!0):i=!0}}t||localStorage[this.ddlBackgroundString()]||(t=!0),i||localStorage[this.ddlQuoteString()]||(i=!0),this.downloading.quote&&(i=!1),this.downloading.background&&(t=!1),t&&i?this.doDownload():t?this.doDownload("background"):i&&this.doDownload("quote")},pingApi:function(t,i){$.ajax({type:"GET",contentType:"application/json",url:m.globals.urlRootApi}).done(function(e){t&&t()}).fail(function(e,t){i&&i()})},ddlBackgroundString:function(){return"ddl-bg-"+getActiveDateString()},ddlQuoteString:function(){return"ddl-qt-"+getActiveDateString()},onClientIdCreated:function(){this.doDownload(),this.syncSettings()},setSyncSettingsHeaders:function(e){m.utils.setMomentumAuthHeader(e);var t=m.models.customization.get("etag");t&&e.setRequestHeader("X-Momentum-Settings-ETag",t)},customizationChange:function(e){if(!this.syncSettingsInProgress&&!m.models.customization.fetching&&m.conditionalFeatures.featureEnabled("serversettings")){if(e){var t=e.changedAttributes();if(1===Object.keys(t).length&&_.contains(Object.keys(t),"etag"))return}else if(m.models.customization.get("etag"))return;$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(m.models.customization.getPersistentSettings()),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"settings"}).done(function(e){e.etag&&m.models.customization.save({etag:e.etag})}).fail(function(e,t){}).always(function(){})}},submitFeatureAccessRequest:function(e,t,i){var n={feature:e};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(n),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"user/featurerequest"}).done(function(e){t&&t()}).fail(function(e,t){i&&i()})},syncSettings:function(e){if(localStorage.client_uuid){this.syncSettingsInProgress=!0;var t=this,i=!1;$.ajax({type:"GET",contentType:"application/json",beforeSend:this.setSyncSettingsHeaders,url:m.globals.urlRootApi+"settings"}).done(function(e){if(e){if(e.token_invalid)return e.token_invalid_reason?m.commandManager.execute("logout",e.token_invalid_reason,!0):m.commandManager.execute("logout",null,!0),void(i=!0);e.greetings&&(localStorage.greetings=e.greetings),e.features&&m.conditionalFeatures.setFeatures(e.features,!0),e.customization&&m.models.customization.save(e.customization),e.team&&m.models.teamInfo.save("team",e.team),m.commandManager.execute("addins.load",e.addIns),m.commandManager.registerCommandSources(e.cmd),e.nav,e.download&&m.trigger("sync:download",e.download),e.ts_notifications&&m.trigger("notifications:timestamp",e.ts_notifications);var t=null;e.ts_backgrounds&&((t=t||{}).ts_backgrounds=e.ts_backgrounds),e.ts_quotes&&((t=t||{}).ts_quotes=e.ts_quotes),t&&m.trigger("sync:downloadIfNeeded",t)}}).fail(function(e,t){}).always(function(){i||(t.syncSettingsInProgress=!1,m.trigger("sync:settings:complete"),e&&e())})}}}),m.models.ConditionalFeatures=Backbone.Model.extend({initialize:function(e){this.customization=e.customization||m.models.customization;try{localStorage.f3t6b23d?this.featureList=JSON.parse(atob(localStorage.f3t6b23d)):this.featureList=[]}catch(e){this.featureList=[]}},featureEnabled:function(e){var t=!0;return"!"===e[0]&&(e=e.substr(1),t=!1),t===_.contains(this.featureList,e)},setFeatures:function(e,t){var i=_.contains(this.featureList,"servertodos");localStorage.f3t6b23d!==e&&(localStorage.f3t6b23d=e,this.featureList=JSON.parse(atob(e)),t&&!i&&_.contains(this.featureList,"servertodos")?window.location.reload():m.trigger("feature:changed"))},clearFeatures:function(){this.featureList=[],localStorage.removeItem("f3t6b23d")},checkFeatureAndMigrateData:function(e,o,a,s,i,t){var n=null,r=this;if(this.featureEnabled(e)){for(var l=!1,c=0;c<localStorage.length;c++)if(keyName=localStorage.key(c),0===keyName.indexOf(a+"-")){l=!0;break}if(l)try{var d=new Date,u=d.getFullYear().toString()+"-"+twoDigit(d.getMonth()+1)+"-"+twoDigit(d.getDate())+"-"+twoDigit(d.getHours())+":"+twoDigit(d.getMinutes())+":"+twoDigit(d.getSeconds()),g="migrated-"+a+"-"+u,h=[],f=[];for(c=0;c<localStorage.length;c++)if(keyName=localStorage.key(c),0===keyName.indexOf(a+"-")){f.push(keyName);var p=localStorage.getItem(keyName);if(p){var v=JSON.parse(p);v.id||(v.id=v.csid),h.push(v)}}var b={items:h},k=JSON.stringify(b);$.ajax({type:"POST",contentType:"application/json",data:k,beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"migrate/"+a}).done(function(e,t,i){for(var n in localStorage.setItem(g,k),f)localStorage.removeItem(f[n]);localStorage.removeItem(a),m.trigger("sync:customization"),o&&!r.customization.getComputedSetting(o)||s()}).fail(function(e,t){o&&!r.customization.getComputedSetting(o)||i()})}catch(e){console.log(e)}else n=s}else n=i;n&&(!o||this.customization.getComputedSetting(o)?n():t?t(n):this.setPreferenceChangeListener(o,n))},setPreferenceChangeListener:function(e,t){var i=this;m.listenToOnce(this.customization,"change:"+e,function(){i.customization.getComputedSetting(e)?t():i.setPreferenceChangeListener(e,t)})},checkPreferenceForRender:function(e,t,i){t&&(!e||this.customization.getComputedSetting(e)?t():i&&i(t))}}),m.models.Widget=Backbone.Model.extend({shouldShowPane:function(){var e=!0;if(this.has("keepOpenSetting")&&(e=m.models.customization.get(this.get("keepOpenSetting"))),this.has("openState")){var t=localStorage[this.get("openState")];if(t)return JSON.parse(t)&&e}return!1}}),m.collect.Widgets=Backbone.Collection.extend({model:m.models.Widget}),m.views.BasePlaceholder=Backbone.View.extend({initialize:function(){this.render()},render:function(){var e=this.model.get("region"),t=(this.model.get("order")||"append")+"To";return this.$el[t]("."+e).mFadeIn().html(this.template(model.toJSON())),this},attributes:function(){return{id:this.model.get("elementId")||this.model.get("id"),class:this.model.get("class")}},detach:function(){this.unbind(),this.stopListening(),this.undelegateEvents()}}),m.views.PanePlaceholder=m.views.BasePlaceholder.extend({template:m.templates.widgetmanager.pane,open:!1,events:{"click .toggle":"toggleShow"},initialize:function(){var t=this;this.region=this.model.get("region"),this.openStateKey=this.model.get("openState"),this.render(),this.model.get("closeOnEsc")&&this.listenTo(m,"globalEvent:esc",this.handleGlobalEsc),this.model.get("toggleEvent")&&this.listenTo(m,this.model.get("toggleEvent"),this.toggleShow),this.model.get("hideEvents")&&_.each(this.model.get("hideEvents"),function(e){t.listenTo(m,e,t.onHideEvent)});var e=this.model.get("visibleSetting");e&&this.listenTo(m.models.customization,"change:"+e,this.visibleChanged),this.model.shouldShowPane()&&this.showPane()},attributes:function(){return{id:this.model.get("id"),class:"app-container "+this.model.get("id")}},render:function(){var e=this.model.get("label"),t=(this.model.get("order")||"append")+"To";if(!this.renderedOnce){var i=this.model.get("width")+"px",n="70px";if(this.model.has("height"))n=this.model.get("height")+"px";else{var o=this.storedPaneHeight();o&&(n=o+"px")}this.$el.html(this.template({label:e,appClass:this.model.get("appClass")||"",isTodo:"todo"===this.model.get("id"),height:n,width:i})),this.$app=this.$(".app"),this.$dash=this.$(".app-dash"),this.$el.addClass(this.model.get("class")||""),0===this.region.indexOf("top")&&(this.$dash.remove(),this.$el.prepend(this.$dash)),this.$(".app-wrapper").addClass("nipple-"+this.region);var a=this;setTimeout(function(){a.$el[t]("."+a.region).mFadeIn(),a.renderedOnce=!0})}return this},storedPaneHeight:function(){if(this.model.has("storedHeight")){var e=this.model.get("storedHeight"),t=localStorage[e];if(t)return JSON.parse(t)}return null},toggleShow:function(e){if(this.realView&&this.realView.toggleHandler)return this.realView.toggleHandler(e),!0;e&&e.stopPropagation&&e.stopPropagation(),e&&e.preventDefault&&e.preventDefault(),this.open?this.hidePane():this.showPane()},showPane:function(){if(!this.open){if(this.open=!0,localStorage.setItem(this.openStateKey,this.open),this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in"),this.realView)this.realView.onShowPane&&this.realView.onShowPane();else{if(this.loading)return;if(!this.model.has("addin"))return;this.loading=!0,m.addinManager.ensureAddinLoaded(this.model.get("addin"))}m.trigger("globalEvent:toggle:"+this.region,this),m.trigger("globalEvent:toggle",this),this.triggerLoaded()}},hidePane:function(){var t=this;this.open&&(this.open=!1,localStorage.setItem(this.openStateKey,this.open),this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show")}),this.realView&&this.realView.onHidePane&&this.realView.onHidePane())},triggerLoaded:function(){this.loadTriggered||(m.trigger(this.model.get("id")+":loaded"),this.loadTriggered=!0)},addRealView:function(e){this.realView=e,this.open&&this.realView.onShowPane&&this.realView.onShowPane()},handleGlobalEsc:function(e){!this.open||this.realView&&this.realView.preventCloseOnEsc&&this.realView.preventCloseOnEsc()||this.toggleShow(e)},onHideEvent:function(e){e!=this&&this.hidePane()},visibleChanged:function(e){var t=this.model.get("visibleSetting"),i=m.models.customization.getComputedSetting(t),n=this;i?this.renderedOnce?(this.$el.stop(),setTimeout(function(){n.$el.mFadeIn()},1)):this.render():(this.realView&&this.realView.tearDown&&this.realView.tearDown(),this.$el.stop(),setTimeout(function(){n.$el.mFadeOut()},1))}}),m.views.MetricPlaceholder=m.views.BasePlaceholder.extend({template:m.templates.widgetmanager.metric,initialize:function(){var e=this;this.render(),setTimeout(function(){m.addinManager.ensureAddinLoaded(e.model.get("addin"))},25)},render:function(){if(!this.renderedOnce){this.renderedOnce=!0;var e={},t=this.model.get("cachedKey");t&&(e=JSON.parse(localStorage.getItem(t)));var i=this.model.get("region"),n=(this.model.get("order")||"append")+"To";this.$el[n]("."+i).html(this.template(e)),m.appsLoaded&&this.$el.mFadeIn()}return this},addRealView:function(e){this.realView=e}}),m.models.WidgetManager=m.models.Manager.extend({skippedWidgets:[],initialize:function(){this.regions={};var e=this;this.regions["top-right"]={widgets:[{el:"app-metric",view:"metric"},{el:"weather-app",view:"weather"}],overlappingRegion:"bottom-right"},this.regions["bottom-right"]={widgets:[{el:"todo-app",view:"todoPane"},{el:"notes-app",view:"notes"}],overlappingRegion:"top-right"},this.regions.bottom={widgets:[{el:"quote",view:"quote"}],overlappingRegion:"top-right"},this.waitingFor=["background"],e.listenTo(m,"background:loaded",function(){e.appReady("background")}),m.console.log(m.elapsed()+": initialized widgetManager")},setupWhenReady:function(){var e=this;m.models.customization.initialized?e.setup():this.listenToOnce(m.models.customization,"initialized",function(){e.setup()})},setup:function(){this.widgets&&this.widgets.each(function(e){e.placeholder&&e.placeholder.remove()}),this.widgets=m.collect.widgets=new m.collect.Widgets,this.listenTo(this.widgets,"add",this.onAdd),this.listenTo(m,"readyForWidgets",this.onSuccessfulLogin),this.populateWidgets()},populateWidgets:function(){m.console.log(m.elapsed()+": populating widgets");var t=this;_.forEach(m.addinManager.getWidgets(),function(e){t.widgets.add(e)})},onAdd:function(e){this.addWidget(e)},onSuccessfulLogin:function(){var t=this,e=this.skippedWidgets;this.skippedWidgets=[],_.each(e,function(e){t.addWidget(e)})},addWidget:function(t,e){var i=this;if(e=e||!1,m.readyForWidgets||t.get("immediateLoad")){if(t.has("requiredFeature")){var n=t.get("requiredFeature");Array.isArray(n)||(n=[n]);for(var o=0;o<n.length;o++){var a=n[o];if(!m.conditionalFeatures.featureEnabled(a))return void this.skippedWidgets.push(t)}}if(!e&&t.has("visibleSetting")){var s=t.get("visibleSetting");if(!m.models.customization.getComputedSetting(s))return void this.listenToOnce(m.models.customization,"change:"+s,function(){var e=!!m.models.customization.getComputedSetting(s);i.addWidget(t,e)})}i.listenTo(m,t.id+":loaded",function(){i.appReady(t.id)});var r=null;"metric"===t.get("placeholderType")?(r=new m.views.MetricPlaceholder({model:t}),this.waitFor(t)):"pane"===t.get("placeholderType")&&(t.shouldShowPane()&&this.waitFor(t),r=new m.views.PanePlaceholder({model:t})),t.placeholder=r}else this.skippedWidgets.push(t)},waitFor:function(e){this.waitingFor.push(e.id)},loadWidget:function(e){var n=this.widgets.find({id:e});if(n)return new Promise(function(t,i){m.addinManager.ensureAddinLoaded(n.get("addin"),function(e){t(e)},null,function(e){i(e)})})},showWidget:function(e){var t=this.widgets.find({id:e});t.realview?t.realview.render():t.shouldRender=!0},getWidget:function(e){return this.widgets.find({id:e}).realview},getWidgetAsync:function(n){var o=this;return new Promise(function(e,t){var i=o.widgets.find({id:n});i.realview?e(i.realview):o.loadWidget(n).then(function(){e(i.realview)})})},handover:function(e,t,i){i=i||{};var n=this.widgets.find({id:e});if(n){var o=n.placeholder;if(o){var a=n.get("placeholderType");"pane"===a?i.el=o.$app:"metric"===a&&(i.el=o.el)}var s,r=this;if(t)return s=new t(i),n.realview=s,n.shouldRender&&s.render(),r.updatePlaceHolder(n.placeholder,s,i.el),s;i.bootstrap&&(n.bootstrap=i.bootstrap,n.bootstrap&&m.readyForWidgets&&n.bootstrap(i.el,function(e){n.realview=e,n.shouldRender&&e.render(),r.updatePlaceHolder(n.placeholder,e,i.el)}))}},updatePlaceHolder:function(e,t,i){$(i&&i[0]).closest(".app-placeholder").removeClass("app-placeholder"),e&&e.addRealView(t)},refocusOverlap:function(e){$("."+this.regions[e].overlappingRegion).removeClass("unfocus")},unfocusOverlap:function(e,t){var i=this.regions[e].overlappingRegion,n=this.regions[i],o=$("."+i),a=[];n.widgets.forEach(function(e){var t=0,i=m.views[e.view];if(!i&&window.addin&&(i=addin.views[e.view]),i&&i.getCurrentHeight)t=i.getCurrentHeight();else{var n=$("."+e.el);t=0<n.length&&n.is(":visible")?n.height():0}a.push(t)});var s=$("."+e).outerHeight(!0)+o.outerHeight(!0)+Math.max.apply(null,a),r=$(".bookmarks-wrapper"),l=0;r.css("transform")&&(l=parseInt(r.css("height"))-parseInt(r.css("transform").split(",")[5])),$("body").height()-(s+l+4)<t&&o.addClass("unfocus")},hideAppsExcept:function(e,t){var i=$(".app-container"),n=$(".apps");this.timeout&&clearTimeout(this.timeout),$.each(i,function(){$(this).css({opacity:""})}),e&&!e.includes("background-info")&&n.addClass("bg-info-fullscreen");var o=$(e);o.length&&$.each(o,function(){$(this).addClass("show-anyway")}),n.addClass("hide-apps"),t?(n.addClass("hide-apps-visibility"),this.appsHidden=!0):this.timeout=setTimeout(function(){n.addClass("hide-apps-visibility")},550)},appReady:function(e){m.console.log(m.elapsed()+": "+e+" is ready"),this[e+"IsReady"]=!0;var t=this.waitingFor.indexOf(e);0<=t&&(this.waitingFor.splice(t,1),this.firstShow())},firstShow:function(){var e=this;0!==this.waitingFor.length&&m.readyForWidgets||(document.body.style.display="block",setTimeout(function(){$(".apps").addClass("show-apps"),m.appsReady=!0,m.trigger("appsReady")},1),setTimeout(function(){m.appsLoaded=!0,e.loadImages(),m.models.activeBackground.preCacheFutureBackgroundImages()},500))},showApps:function(e){if(e||this.backgroundIsReady){this.timeout&&clearTimeout(this.timeout);var t=$(".apps");e&&(t.addClass("u--no-transition"),t.removeClass("show-apps"),setTimeout(function(){t.removeClass("u--no-transition"),t.addClass("show-apps")},10)),t.removeClass("hide-apps hide-apps-visibility");var i=$(".apps .show-anyway");i.length&&$.each(i,function(){$(this).removeClass("show-anyway")}),this.timeout=setTimeout(function(){t.removeClass("bg-info-fullscreen")},500)}},loadImages:function(){for(var e=document.getElementsByTagName("img"),t=0;t<e.length;t++)e[t].getAttribute("data-src")&&e[t].setAttribute("src",e[t].getAttribute("data-src"))}}),window.m.usageDB=function(){var i=null,c={READY:"ready",UPLOADING:"uploading",UPLOADED:"uploaded"};function n(){try{window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,dbVersion=1;var t=indexedDB.open("momo-db",1);t.onsuccess=function(){i=t.result},t.onerror=function(e){},t.onupgradeneeded=function(e){!function(e,t){try{e.oncomplete=function(e){i=t},t.createObjectStore("usage",{keyPath:"key"}).createIndex("ready",["forDate","itemUuid","status"])}catch(e){}}(e.target.transaction,t.result)}}catch(e){}}function d(){return new Promise(function(t,e){try{i?t(i):(n(),setTimeout(function(){d().then(function(e){t(e)})},10))}catch(e){}})}return{status:c,increment:function(o,a,s,r){var l=null;d().then(function(e){try{var t=e.transaction(["usage"],"readwrite");t.oncomplete=function(){},t.onerror=function(e){};var i=getActiveDateString(),n=t.objectStore("usage").index("ready").get([i,o,c.READY]);n.onsuccess=function(e){try{l=void 0===e.target.result?m.usage.create(o,a):e.target.result,Array.isArray(s)||(s=[s]),s.forEach(function(e){l[e]++}),t.objectStore("usage").put(l),r&&r(e.target.result)}catch(e){}},n.onerror=function(e){}}catch(e){}})},saveEntity:function(e){var o={};return Object.assign(o,e),o.key=uuidv4(),o.status=c.READY,o.type||(o.type=m.usage.types.STATS),new Promise(function(i,n){d().then(function(e){try{var t=e.transaction(["usage"],"readwrite");t.oncomplete=function(e){i(e)},t.onerror=function(e){n(e)},t.objectStore("usage").put(o)}catch(e){n(e)}})})},prepareUnsynced:function(){return new Promise(function(s,r){d().then(function(e){try{var t=e.transaction(["usage"],"readwrite");t.oncomplete=function(){s(a)};var n=(new Date).getTime(),o=n-6e4,i=t.objectStore("usage"),a=[];i.openCursor().onsuccess=function(e){try{var t=e.target.result;if(t){if(t.value.status===c.READY||t.value.uploadDate<o){var i=t.value;i.status=c.UPLOADING,i.uploadDate=n,t.update(i).onsuccess=function(){a.push(i)}}t.continue()}}catch(e){r()}}}catch(e){r()}}).catch(function(){r()})})},cleanSynced:function(o){return new Promise(function(i,n){d().then(function(e){try{var t=e.transaction(["usage"],"readwrite");t.oncomplete=function(){i()},t.objectStore("usage").openCursor().onsuccess=function(e){try{var t=e.target.result;t&&(o.map(function(e){t.value.key===e&&t.delete()}),t.continue())}catch(e){n()}}}catch(e){n()}}).catch(function(){n()})})}}}(),window.m.usage=function(){try{var t={PHOTO:1,QUOTE:2,MANTRA:3,ERROR:4,SEARCH:5,STATS:6,TIMING:7},i={IMPRESSION_COUNT:"impressionCount",HOVER_COUNT:"hoverCount",LOAD_COUNT:"loadCount",CLICK_COUNT:"clickCount",SECONDARY_CLICK_COUNT:"secondaryClickCount",ADMIRE_COUNT:"admireCount",STICKY_CLICK_COUNT:"stickyClickCount",STICKY_SECONDARY_CLICK_COUNT:"stickySecondaryClickCount",STICKY_HOVER_COUNT:"stickyHoverCount"},n={};n[t.PHOTO]=[i.IMPRESSION_COUNT,i.HOVER_COUNT,i.LOAD_COUNT,i.ADMIRE_COUNT,i.CLICK_COUNT,i.STICKY_CLICK_COUNT,i.SECONDARY_CLICK_COUNT,i.STICKY_SECONDARY_CLICK_COUNT,i.STICKY_HOVER_COUNT],n[t.QUOTE]=[i.IMPRESSION_COUNT,i.HOVER_COUNT,i.LOAD_COUNT,i.CLICK_COUNT];var o="usage-retry-after",a={timeThreshold:1e3,timeThresholdPassed:!1,tabLoadThreshold:3e3};function s(e){return e&&e.get?e.get("_id")||e.get("id"):null}return a["loaded"+t.PHOTO]=null,a["loaded"+t.QUOTE]=null,a["trackedLoaded"+t.PHOTO]=null,a["trackedLoaded"+t.QUOTE]=null,setTimeout(function(){a.timeThresholdPassed=!0},a.timeThreshold),setTimeout(function(){document.addEventListener("visibilitychange",function(){!document.hidden&&a.timeThresholdPassed&&Object.values(t).forEach(function(e){var t=a["loaded"+e];t&&(a["trackedLoaded"+e]===t?m.usage.recordImpression(t,e):(a["trackedLoaded"+e]=t,m.usage.recordLoadAndImpression(t,e)))})})},300),setTimeout(function(){localStorage.getItem("syncOnTabLoad")&&m.usage.sendStats()},a.tabLoadThreshold),{properties:i,types:t,create:function(e,t){var i={itemUuid:e,forDate:getActiveDateString(),status:m.usageDB.status.READY,uploadDate:0,type:t,key:uuidv4()};return n[t].forEach(function(e){i[e]=0}),i},itemLoaded:function(e,t){try{function i(e,t){document.hidden||(a["trackedLoaded"+t]=e,m.usage.recordLoadAndImpression(e,t))}a["loaded"+t]=e,a["trackedLoaded"+t]=null,a.timeThresholdPassed&&!document.hidden?i(e,t):setTimeout(function(){document.hidden||i(e,t)},a.timeThreshold)}catch(e){}},savePhotoError:function(e){e.type=m.usage.types.ERROR,e.itemType="Photo",navigator.connection&&(e.rtt=navigator.connection.rtt,e.down=navigator.connection.downlink),this.save(e,!0,!0)},savePhotoLoadTime:function(e){e.type=m.usage.types.TIMING,e.itemType="Photo",this.save(e,!0,!0)},save:function(e,t,i){var n=this;e.date=(new Date).getTime();try{m.usageDB.saveEntity(e).then(function(){t&&(i?localStorage.setItem("syncOnTabLoad",!0):n.sendStats())})}catch(e){}},increment:function(e,t,i,n){var o=this;try{m.usageDB.increment(e,t,i,function(){n&&o.sendStats()})}catch(e){}},recordLoadAndImpression:function(e,t){try{this.increment(s(e),t,[i.LOAD_COUNT,i.IMPRESSION_COUNT],this.shouldSendNow(e))}catch(e){}},recordStickyHover:function(e,t){try{this.increment(s(e),t,[i.HOVER_COUNT,i.STICKY_HOVER_COUNT])}catch(e){}},recordHover:function(e,t){try{this.increment(s(e),t,i.HOVER_COUNT)}catch(e){}},recordClick:function(e,t){try{this.increment(s(e),t,i.CLICK_COUNT,this.shouldSendNow(e))}catch(e){}},recordStickyClick:function(e,t){try{this.increment(s(e),t,[i.CLICK_COUNT,i.STICKY_CLICK_COUNT],this.shouldSendNow(e))}catch(e){}},recordSecondaryClick:function(e,t){try{this.increment(s(e),t,i.SECONDARY_CLICK_COUNT,this.shouldSendNow(e))}catch(e){}},recordStickySecondaryClick:function(e,t){try{this.increment(s(e),t,[i.SECONDARY_CLICK_COUNT,i.STICKY_SECONDARY_CLICK_COUNT],this.shouldSendNow(e))}catch(e){}},recordImpression:function(e,t){try{this.increment(s(e),t,i.IMPRESSION_COUNT)}catch(e){}},recordAdmire:function(e){try{this.increment(s(e),t.PHOTO,i.ADMIRE_COUNT)}catch(e){}},shouldSendNow:function(e){return e&&(e.get("sticky")||e.get("now"))},sendStats:function(){var e=this;function t(e){try{if(!e||0===e.length||!localStorage.getItem("client_uuid")||!navigator.onLine)return void(a.sending=!1);var t=localStorage.getItem(o);if(t){if((new Date).getTime()<parseInt(t))return void(a.sending=!1);localStorage.removeItem(t)}e.forEach(function(t){n[t.type]&&n[t.type].forEach(function(e){0===t[e]&&delete t[e]}),isNaN(t.type)&&(t.type=t.type===m.usage.types.PHOTO?1:2),delete t.status,delete t.uploadDate}),$.ajax({type:"post",contentType:"application/json",beforeSend:m.utils.setMomentumAuthHeader,url:m.globals.urlRootStats+"collect",data:JSON.stringify(e)}).done(function(e){localStorage.removeItem("syncOnTabLoad"),e&&m.usageDB.cleanSynced(e).finally(function(){a.sending=!1})}).error(function(e){if(503===e.status){var t=e.getResponseHeader("Retry-After");t&&(t=parseInt(t),localStorage.setItem(o,(new Date).getTime()+1e3*t))}a.sending=!1})}catch(e){a.sending=!1}}a.sending?setTimeout(function(){e.sendStats()},5e3):(a.sending=!0,setTimeout(function(){m.usageDB.prepareUnsynced().then(t).catch(function(){a.sending=!1})},1e3))}}}catch(e){}}(),m.models.Image=Backbone.Model.extend({loadCompleted:!1,loading:!1,success:!1,failed:!1,timeoutId:null,initialize:function(){},load:function(e){var o=this,a=this.get("url"),s=this.get("uuid");if(this.success)setTimeout(function(){m.trigger("image:loaded",s,a)},5);else if(!this.loading&&!this.loadCompleted){this.loading=!0;var t=document.createElement("img");t.addEventListener("load",function e(){o._onLoad=e,this.success=!0,o.cleanup();var t=!1,i=o.get("height"),n=o.get("width");i&&n?this.height==i&&this.width==n||(t=!0):o.get("skip_check")||(this.height<750||this.width<1e3)&&(t=!0);if(t)return o.failed=!0,localStorage.setItem("failed:"+a,"true"),m.usage.savePhotoError({errorType:"loadError",itemUuid:s,errorMessage:"size mismatch"}),o.loadCompleted=!0,void m.trigger("image:error",s);o.loadCompleted=!0,o.loading=!1,m.trigger("image:loaded",s,a),setTimeout(function(){for(var e=performance.getEntriesByType("resource"),t=0;t<e.length;t++){var i=e[t];if(i.name===a){var n={itemUuid:s,duration:i.duration};0<i.duration&&navigator.connection&&(n.rtt=navigator.connection.rtt,n.down=navigator.connection.downlink),m.usage.savePhotoLoadTime(n)}}},25)}),t.addEventListener("error",function e(t){o._onError=e,o.failed=!0,o.loading=!1,o.cleanup(),m.usage.savePhotoError({errorType:"loadError",itemUuid:s,errorMessage:null}),o.isBackgroundLoaded&&m.trigger("image:error",s)}),e&&(o.timeoutId=setTimeout(function(){this.success||m.trigger("image:timeout",s)},e)),t.setAttribute("src",a)}},cleanup:function(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),this.img&&(this.img.removeEventListener("load",this._onLoad),this.img.removeEventListener("error",this._onError),this.img=null)}}),m.models.ImageManager=Backbone.Model.extend({images:{},initialize:function(){},loadImage:function(e,t){var i=null,n=e.uuid;this.images.hasOwnProperty(n)?i=this.images[n]:(i=new m.models.Image(e),this.images[n]=i),i.load(t)}}),m.models.BackgroundBase=Backbone.Model.extend({backgroundUuid:function(){var e=this.get("_id");if(e)return e;var t,i=this.get("filename");return 0===i.indexOf("http")?null:2==(t=i.split("/")).length&&2==(t=t[1].split(".")).length?t[0]:null}}),m.models.Background=m.models.BackgroundBase.extend({idAttribute:"forDate"}),m.models.ActiveBackground=Backbone.Model.extend({initialize:function(e,t){this.displayLogged=!1,this.backgrounds=t.backgrounds,this.legacyBackgrounds=t.legacyBackgrounds,this.listenTo(this.backgrounds,"reset",this.collectionReady),this.listenTo(this.legacyBackgrounds,"reset",this.legacyCollectionReady),this.listenTo(m,"newDay",this.handleNewDay,this),this.listenTo(m,"waitForPhotoActivation",this.waitForPhotoActivation,this),this.listenTo(this,"background:fallback",this.handleFallback,this)},handleNewDay:function(){var e=this;try{m.usage.sendStats()}catch(e){}e.intervalId=setInterval(function(){0<e.backgrounds.length&&(e.checkActiveBackground(),clearInterval(e.intervalId))},50)},handleFallback:function(){var t=this.fallbackKey(),e=localStorage.getItem(t),i=null,n=this;e?this.legacyBackgrounds.getBackground(e,function(e){e||(e=n.legacyBackgrounds.getCurrentLocalBackground())&&localStorage.setItem(t,e.backgroundUuid()),e&&(n.usingFallback=!0,n.setActiveBackground(e,!0))}):i||(i=n.legacyBackgrounds.getCurrentLocalBackground())&&(localStorage.setItem(t,i.backgroundUuid()),n.usingFallback=!0,n.setActiveBackground(i,!0))},waitForPhotoActivation:function(e){this.isWaitingForPhotoActivation=e},collectionReady:function(){this.usingFallback&&!this.isWaitingForPhotoActivation||(this.checkActiveBackground(),this.isWaitingForPhotoActivation=!1)},fallbackKey:function(){return"fallback-"+getActiveDateString()},legacyCollectionReady:function(){0<this.backgrounds.length?this.backgrounds.get(getActiveDateString())||this.checkActiveBackground():this.checkActiveBackground()},activeBackgroundUuid:function(){return this.backgroundItem?this.backgroundItem.backgroundUuid():null},checkActiveBackground:function(){var e=null;this.backgrounds&&0<this.backgrounds.length&&(e=this.backgrounds.getActiveBackground())?this.setActiveBackground(e):this.trigger("background:fallback")},successfullyLoaded:function(e){this.backgroundItem.backgroundUuid()==e&&this.trigger("background:successfullyLoaded",this.backgroundItem)},setActiveBackground:function(e,t){e&&(e.has("_id")&&this.lastBgId==e.get("_id")||(this.lastBgId=e.get("_id"),this.backgroundItem&&this.backgroundItem.cid==e.cid||(this.displayLogged=!1,this.backgroundItem=e,this.trigger("background:activechanged",e,!!t))))},generateUUID:function(){var i=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(i+16*Math.random())%16|0;return i=Math.floor(i/16),("x"==e?t:3&t|8).toString(16)})},preCacheFutureBackgroundImages:function(){var i=this,n=Date.parse(getActiveDateString());this.backgrounds&&0<this.backgrounds.length&&this.backgrounds.map(function(e){var t=Date.parse(e.get("forDate"));n<t&&i.preCacheBackgroundImage(e)})},preCacheBackgroundImage:function(e){if(e){var t={uuid:e.backgroundUuid(),url:e.get("filename")};t.height=e.get("height"),t.width=e.get("width"),t.skip_check=e.get("skip_check"),m.models.imageManager.loadImage(t)}}}),m.models.LegacyBackground=m.models.BackgroundBase.extend({parse:function(e){var t,i=e.id;i||2==(t=e.filename.split("/")).length&&2==(t=t[1].split(".")).length&&(i=t[0]);this.set({id:i,filename:e.filename,title:e.title,source:e.source,sourceUrl:e.sourceUrl})}}),m.collect.Fallbacks=Backbone.Collection.extend({model:Backbone.Model,beforeDate:function(t){return filtered=this.filter(function(e){return e.get("fallbackDate")<t}),new m.collect.Fallbacks(filtered)}}),m.collect.Backgrounds=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-background"),model:m.models.Background,getActiveBackground:function(){if(0<this.length){var e=getActiveDateString();return this.get(e)}}}),m.collect.LegacyBackgrounds=Backbone.Collection.extend({model:m.models.LegacyBackground,url:"app/backgrounds.json",parse:function(e){return e.backgrounds},initialize:function(){this.initialized=!1,this.listenTo(this,"reset",function(){this.initialized=!0}),localStorage.firstSynchronized||this.listenTo(this,"reset",this.initializeBackground)},initializeBackground:function(){this.getCurrentLocalBackground(),m.trigger("sync:downloadIfNeeded")},getBackground:function(e,t){if(this.initialized)t(this.get(e));else{var i=this;setTimeout(function(){i.getBackground(e,t)},10)}},getCurrentLocalBackground:function(){if(0===this.models.length)return null;var e=null,t=m.models.activeBackground.fallbackKey(),i=localStorage.getItem(t);if(i&&(e=this.get(i)),!e){if(!this.parseRecentFallbacks())return null;var n=Math.floor(.75*this.models.length),o=this.fallbacks.sortBy(function(e){return-e.get("fallbackDate")}),a=_.first(o,n),s=_.map(a,function(e){return e.get("backgroundGuid")}),r=this.pluck("id");if(m.collect.backgrounds){var l=m.collect.backgrounds.sortBy(function(e){return-Date.parse(e.get("forDate"))});n=Math.floor(.25*this.models.length);var c=_.first(l,n),d=_.map(c,function(e){return e.get("_id")});s=_.union(s,d)}var u=_.difference(r,s);if(0<u.length){var g=_.sample(u);e=this.get(g)}else e=this.sample()}return e},parseRecentFallbacks:function(){if(this.fallbacks)return!0;this.fallbacks=new m.collect.Fallbacks;var a=this;return $.each(localStorage,function(e,t){if(0===e.indexOf("fallback-")){var i=e.slice(9),n=Date.parse(i),o=new Backbone.Model({fallbackDate:n,backgroundGuid:t});a.fallbacks.add(o)}}),!0}}),m.models.BackgroundManager=Backbone.Model.extend({initialize:function(e,t){m.models.imageManager=new m.models.ImageManager,m.collect.backgrounds=new m.collect.Backgrounds,m.collect.legacyBackgrounds=new m.collect.LegacyBackgrounds,m.models.activeBackground=new m.models.ActiveBackground({},{backgrounds:m.collect.backgrounds,legacyBackgrounds:m.collect.legacyBackgrounds})},firstFetch:function(){m.collect.backgrounds.fetch({reset:!0}),setTimeout(function(){m.collect.legacyBackgrounds.fetch({reset:!0})},500)},skipErrorMessage:{message:"Oops! We weren't able to get a new background. Please check your connection and try again.",viewLimit:1},favouriteErrorMessage:{message:"Oops! We weren't able to save the favorite. Please check your connection and try again.",viewLimit:1},skipBackground:function(i){var n=this,e=m.globals.urlRootApi+"backgrounds",t={operation:"skip",active_uuid:m.models.activeBackground.activeBackgroundUuid()};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(t),url:e}).done(function(e){if(e&&e.success&&m.trigger("sync:download","background"),e&&e.notification){if("max_skips"==e.notification.type){if(localStorage.displayedMaxSkips)return;localStorage.displayedMaxSkips=!0}e.notification.display_time||(e.notification.display_time=5e3),m.commandManager.execute("notification.show.enhanced",e.notification)}}).fail(function(e,t){m.commandManager.execute("notification.show.enhanced",n.skipErrorMessage),i&&i()})}catch(e){m.commandManager.execute("notification.show.enhanced",n.skipErrorMessage),i&&i()}},toggleFavorite:function(e,i,t){var n=this,o=m.globals.urlRootApi+"backgrounds/favorites",a={operation:"favorite",active_uuid:m.models.activeBackground.activeBackgroundUuid(),is_favorite:e};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(a),url:o}).done(function(e){e&&e.success&&(m.trigger("sync:download","background"),m.trigger("background:favorite",{id:a.active_uuid,is_favorite:a.is_favorite}),t&&t())}).fail(function(e,t){m.commandManager.execute("notification.show.enhanced",n.favouriteErrorMessage),i&&i()})}catch(e){m.commandManager.execute("notification.show.enhanced",n.favouriteErrorMessage),i&&i()}},latestBackgroundDate:function(){var i=null;return m.collect.backgrounds.models.forEach(function(e){var t=Date.parse(e.id);(!i||i<t)&&(i=t)}),i}}),m.views.Background=Backbone.View.extend({tagName:"li",attributes:{},isBackgroundLoaded:!1,initialize:function(){this.initialFade=!0,this.model=m.models.backgroundManager,this.listenTo(m.models.activeBackground,"background:activechanged",this.setBackground),this.listenTo(m,"appsReady",this.fadeBackgroundIn)},render:function(){this.model&&this.model.backgroundItem&&this.setBackground(this.model.backgroundItem)},setBackground:function(a){var s=this,e=!1;s.isBackgroundLoaded&&(e=!0);var r=a.get("filename"),l=a.get("variant"),c=a.backgroundUuid(),d=(this.options.order||"append")+"To";$(".background").css("background-image",$(".background").find("li").css("background-image")),this.lastId=c,this.loadCompleted=!1,"true"==localStorage.getItem("failed:"+r)&&(s.loadCompleted=!0,m.models.activeBackground.trigger("background:fallback"));var t=$("<img/>");t.on("load",function(){var o=c;setTimeout(function(){for(var e=performance.getEntriesByType("resource"),t=0;t<e.length;t++){var i=e[t];if(i.name===r){var n={itemUuid:o,duration:i.duration};l&&(n.variant=l),0<i.duration&&navigator.connection&&(n.rtt=navigator.connection.rtt,n.down=navigator.connection.downlink),m.usage.savePhotoLoadTime(n)}}},25);var e=!1,t=a.get("height"),i=a.get("width");t&&i?this.height==t&&this.width==i||(e=!0):a.get("skip_check")||(this.height<750||this.width<1e3)&&(e=!0);if(e){m.models.activeBackground.trigger("background:fallback"),localStorage.setItem("failed:"+r,"true");var n={errorType:"loadError",itemUuid:o,errorMessage:"size mismatch"};return l&&(n.variant=l),m.usage.savePhotoError(n),void(s.loadCompleted=!0)}s.loadCompleted=!0,m.models.activeBackground.successfullyLoaded(c);try{m.usage.itemLoaded(a,m.usage.types.PHOTO)}catch(e){}s.isBackgroundLoaded=!0,c===s.lastId&&(s.$el[d]("."+s.options.region).css("background-image","url("+r+")"),$(this).remove(),m.appsLoaded&&s.fadeBackgroundIn()),m.trigger("background:loaded"),setTimeout(function(){m.trigger("background:loadSuccessful",c)},200)}).on("error",function(e){var t={errorType:"loadError",itemUuid:c};l&&(t.variant=l),m.usage.savePhotoError(t),s.loadCompleted=!0,s.isBackgroundLoaded?m.trigger("background:error",c):m.models.activeBackground.trigger("background:fallback")}),e||window.setTimeout(function(){if(!s.loadCompleted){var e={errorType:"timeout",itemUuid:c};l&&(e.variant=l),m.usage.savePhotoError(e),s.loadCompleted=!0,m.models.activeBackground.trigger("background:fallback")}},4e3),t.attr("src",r)},fadeBackgroundIn:function(){var e=this.initialFade?"fadein":"fadein-slow";this.initialFade=!1,this.$el.addClass(e),setTimeout(function(){$(".background-overlay").addClass("show")},5)}}),m.views.BackgroundInfo=Backbone.View.extend({tagName:"div",attributes:{class:"app-container background-info"},template:m.templates.background["background-info"],timeAdmireDelay:4e3,timeoutIdAdmire:null,events:{mouseenter:"handleHoverOn",mouseleave:"handleHoverOff","mouseenter .control":"controlHoverOn","mouseleave .control":"controlHoverOff","click .background-info-title":"clickTitle","click .background-info-source-link":"clickSource","click .source-url":"trackClick","click .control-heart":"toggleFavorite","click .control-refresh":"skipBackground"},initialize:function(){this.listenTo(m.models.activeBackground,"background:successfullyLoaded",this.activeBackgroundReady),this.listenTo(m.models.activeBackground,"background:error",this.skipFailed),this.listenTo(m,"sync:error",this.skipFailed),this.listenTo(m,"globalEvent:windowBlur",this.unfocusBg)},parentReady:function(e){this.isParentReady=!0,(this.isBackgroundReady||e)&&this.render()},activeBackgroundReady:function(){this.isBackgroundReady=!0,this.isParentReady&&this.render()},render:function(){m.models.activeBackground&&m.models.activeBackground.backgroundItem&&this.setBackground(m.models.activeBackground.backgroundItem),this.$bgOverlay=$(".background-overlay"),this.$apps=$(".apps").first(),!document.hidden&&this.activeBackground.get("sticky")&&this.stick()},setBackground:function(e){var t=this,i="",n=null,o="",a="",s="",r="",l=!1,c=!1,d=null;if(e){if(i=e.get("title"),a=e.get("sourceUrl"),s=e.get("detailUrl"),n=e.get("attribution"),o=e.get("source"),d=e.get("templateId")){var u=m.templates.background["background-template-"+d];u&&(this.template=u)}n||(n="Photo by "+o),e.get("is_favorite")&&(l=!0,r="active")}this.activeBackground?this.activeBackground.backgroundUuid()!=e.backgroundUuid()?c=!0:i==this.activeBackground.get("title")&&n==this.activeBackground.get("attribution")||(c=!0):c=!0,c&&(this.activeBackground=e),s&&0<s.length?(this.detailUrl=s,this.$el.addClass("has-link")):(this.detailUrl=null,this.$el.removeClass("has-link"));var g={title:i,source:o,sourceUrl:a,attribution:n,fav_class:r,hasDetailUrl:Boolean(this.detailUrl),sticky:this.activeBackground.get("sticky")};if(this.renderedOnce)c&&(this.$el.addClass("u--no-opacity"),setTimeout(function(){t.$background_info_title.html(i+'<i class="icon-angle-right"></i>'),t.$background_info_source_link.text(n),t.$el.removeClass("u--no-opacity")},500));else{var h=(this.options.order||"append")+"To";this.$el[h]("."+this.options.region).html(this.template(g)),this.$background_info_source_link=this.$el.find(".background-info-source-link").first(),this.$background_info_title=this.$el.find(".background-info-title").first(),this.$control_heart=this.$el.find(".control-heart").first(),this.$control_refresh=this.$el.find(".control-refresh").first(),this.renderedOnce=!0}return a&&0<a.length?(this.$background_info_source_link.data("url",a),this.$background_info_source_link.removeClass("no-link")):(this.$background_info_source_link.data("url",null),this.$background_info_source_link.addClass("no-link")),this.skipInProgress&&(this.$control_refresh.removeClass("active"),this.skipInProgress=!1),m.conditionalFeatures.featureEnabled("skip-bg")?this.$control_refresh.show():this.$control_refresh.hide(),this.$control_heart.show(),l?this.$control_heart.addClass("active"):this.$control_heart.removeClass("active"),this},stick:function(){var e=this.activeBackground.get("_id")||this.activeBackground.get("id"),t=this.activeBackground.get("sticky"),i="triggered-"+this.activeBackground.get("forDate")+"-"+e,n=localStorage.getItem(i);(n=n?Number.parseInt(n):0)<t&&(localStorage.setItem(i,n+1),this.$el.addClass("sticky"),this.stickySession=!0)},handleHoverOn:function(){var e=this;e.hover=!0,setTimeout(function(){if($(e.$el).find(".background-info-title").css({"z-index":1}),e.hover)try{e.stickySession?m.usage.recordStickyHover(e.activeBackground,m.usage.types.PHOTO):m.usage.recordHover(e.activeBackground,m.usage.types.PHOTO)}catch(e){}},300),this.clearTimeoutAdmire(),this.timeoutIdAdmire=setTimeout(function(){e.focusOnBg()},this.timeAdmireDelay)},clearTimeoutAdmire:function(){null!==this.timeoutIdAdmire&&(clearTimeout(this.timeoutIdAdmire),this.timeoutIdAdmire=null)},handleHoverOff:function(){this.clearTimeoutAdmire(),this.$el.removeClass("sticky"),this.hover=!1;var e=this;setTimeout(function(){$(e.$el).find(".background-info-title").css({"z-index":""}),e.unfocusBg()},300)},focusOnBg:function(){if(!$(".apps").hasClass("hide-apps")&&!(this.focusing||this.unfocusing||this.focused)){try{m.usage.recordAdmire(this.activeBackground)}catch(e){}this.focusing=!0,this.focused=!0;var e=this;setTimeout(function(){e.focusing=!1},1e3),m.widgetManager.hideAppsExcept(".apps .background-info"),$(this.$el).addClass("add-shadow show-shadow"),this.$bgOverlay.addClass("slow"),setTimeout(function(){e.$bgOverlay.removeClass("show")},5)}},unfocusBg:function(){if(this.focused){this.unfocusing=!0,this.focused=!1;var e=this;$(e.$el).removeClass("show-shadow"),m.widgetManager.showApps(),this.$bgOverlay.addClass("show"),setTimeout(function(){$(this.$el).removeClass("add-shadow"),e.$bgOverlay.removeClass("slow"),e.unfocusing=!1},1e3)}},controlHoverOn:function(){$(this.$el).removeClass("has-link")},controlHoverOff:function(){this.detailUrl&&0<this.detailUrl.length&&$(this.$el).addClass("has-link")},clickTitle:function(e){e.stopPropagation(),e.preventDefault(),this.detailUrl&&0<this.detailUrl.length&&this.trackClickAndGo(this.detailUrl)},clickSource:function(e){e.stopPropagation(),e.preventDefault();var t=$(e.currentTarget).data("url");this.trackClickAndGo(t,!0)},trackClickAndGo:function(e,t){try{this.stickySession?m.usage[t?"recordStickySecondaryClick":"recordStickyClick"](this.activeBackground,m.usage.types.PHOTO):m.usage[t?"recordSecondaryClick":"recordClick"](this.activeBackground,m.usage.types.PHOTO)}catch(e){}e&&(this.clearTimeoutAdmire(),this.hover=!1,window.open(e,"_blank"))},toggleFavorite:function(e){e.stopPropagation(),$(e.currentTarget).toggleClass("active");var t=$(e.currentTarget).hasClass("active");m.models.backgroundManager.toggleFavorite(t,function(){$(e.currentTarget).toggleClass("active")}),m.sendEvent("Background",t?"Favourite":"Unfavourite")},skipFailed:function(){this.skipInProgress&&(this.$control_refresh.removeClass("active"),this.skipInProgress=!1)},skipBackground:function(e){var t=this;e.stopPropagation(),this.skipInProgress||(this.skipInProgress=!0,$(e.currentTarget).addClass("active"),m.models.backgroundManager.skipBackground(function(){t.skipFailed()}),m.sendEvent("Background","Skip"))}}),m.collect.SyncedCollection=Backbone.Collection.extend({initialize:function(e){this.model=e.model,this.idAttribute="csid",this.version=2,this.name=e.name,localStorage.getItem("syncedCollectionVersion-"+this.name)||(this.migrate(),localStorage.setItem("syncedCollectionVersion-"+this.name,this.version)),this.serverIdAttribute=e.serverIdAttribute||"id",this.localStorage=new Backbone.LocalStorage(e.name),this.apiUrl=e.apiUrl||m.globals.urlRootApi+e.name,this.listenTo(this,"add",this.onAdd),this.listenTo(this,"remove",this.onRemove),this.listenTo(this,"change",this.onChange),this.listenTo(this,"reset",this.onReset),this.includeArchived=!1,this.transientProps=e.transientProps||[],this.sorted=e.sorted},create:function(e,t){t=t||{},e[this.idAttribute]||(e[this.idAttribute]=uuidv4()),e.serverSetId||(e.serverSetId=!1);var i=this.add(e,t);return i.id=i.get(this.idAttribute),i.save(),i},migrate:function(){var n=this,e=localStorage.getItem(this.name);e&&0!==(e=e.split(",")).length&&e.map(function(e){var t=n.name+"-"+e,i=localStorage.getItem(t);i&&((i=JSON.parse(i))[n.idAttribute]||(i[n.idAttribute]=i.id,i=JSON.stringify(i),localStorage.setItem(t,i)))})},activeItems:function(){return this.filter(function(e){return!e.get("deleted")})},archivedItems:function(){return this.filter(function(e){return!e.get("deleted")&&e.get("archived")})},onRemove:function(i,e){if(!e||!e.ignoreSave){var n=this;$.ajax({url:this.apiUrl+"/"+i.get(this.serverIdAttribute),contentType:"application/json",type:"DELETE",beforeSend:m.utils.setMomentumAuthHeader}).done(function(){}).fail(function(e,t){n.add(i,{silent:!0})})}},onReset:function(){this.fetchedOnce=!0;var e=this;this.models.forEach(function(t){e.transientProps&&e.transientProps.forEach(function(e){t.attributes[e]=!1}),t.serverSetId||(t.serverSetId=!1)}),this.syncToServer(function(){e.fetchFromServer()})},findHavingAttribute:function(t){return this.filter(function(e){return e.has(t)})},hasAttribute:function(t){return!!this.find(function(e){return e.has(t)})},onAdd:function(t,e,i,n){if(!i||!i.ignoreSave){var o=t.toJSON();this.transientProps&&this.transientProps.forEach(function(e){delete o[e]});var a=this;this.syncInProgress=!0,delete o[a.idAttribute],$.ajax({url:this.apiUrl,contentType:"application/json",type:"POST",beforeSend:m.utils.setMomentumAuthHeader,data:JSON.stringify(o)}).done(function(e){e&&e[a.serverIdAttribute]&&((o=t.toJSON()).changed_props=null,o.serverSetId=!0,o[a.serverIdAttribute]=e[a.serverIdAttribute],t.save(o,{silent:!0}))}).fail(function(e,t){}).always(function(){a.syncInProgress=!1,a.missedSync&&(a.missedSync=!1,a.syncToServer()),n&&n()})}},onChange:function(e,t){var i=this;if(!t.ignoreSave){var n=e.changedAttributes();if(n&&!n[this.idAttribute]&&!t.createdNow){var o,a=null,s=!1;for(o in this.transientProps&&this.transientProps.forEach(function(e){delete n[e]}),n)n.hasOwnProperty(o)&&"changed_props"!==o&&(a||(a=e.get("changed_props")||[]),_.contains(a,o)||(o!==i.idAttribute&&e.get("serverSetId")&&a.push(o),s=!0));s&&a&&e.save({changed_props:a},{silent:!0,ignoreSave:!0,ignoreRender:!0,success:function(){setTimeout(function(){i.syncToServer()},50)}})}}},syncToServer:function(e){if(this.syncInProgress)this.missedSync=!0;else{this.syncInProgress=!0;var a=this,t=0,i=this.findHavingAttribute("changed_props"),n=this.where({serverSetId:!1});if(n?Array.isArray(n)||(n=[n]):n=[],n.forEach(function(e){a.onAdd(e,null,null,function(){s()})}),!i||0==i.length)return e&&e(),void(0===n.length&&(this.syncInProgress=!1));nimble.each(i,function(t){var e=t.get("changed_props"),i=e.toString();if(e&&0!==e.length){t.syncing=!0;var n={};_.each(e,function(e){"changed_props"!==e&&e!==a.idAttribute&&(n[e]=t.get(e))});var o=a.apiUrl+"/"+encodeURIComponent(t.get(a.serverIdAttribute));$.ajax({url:o,contentType:"application/json",type:"PATCH",beforeSend:m.utils.setMomentumAuthHeader,data:JSON.stringify(n)}).done(function(e){e&&e.success&&(t.get("deleted")?t.destroy({silent:!0}):t.get("changed_props")&&t.get("changed_props").toString()===i&&t.collection&&t.save({changed_props:null},{silent:!0}))}).fail(function(e,t){}).always(function(){s()})}else s()})}function s(){++t===i.length+n.length&&(a.syncInProgress=!1,t=0,a.missedSync&&(a.missedSync=!1,a.syncToServer()),e&&e())}},fetchFromServer:function(e,t){var a=this;$.ajax({url:this.apiUrl+(this.includeArchived?"?includeArchived=true":""),contentType:"application/json",type:"GET",beforeSend:m.utils.setMomentumAuthHeader}).done(function(e){var n=!1;if(e&&Array.isArray(e)){var o=[];_.each(e,function(e){o.push(e[a.serverIdAttribute]);var t={};t[a.serverIdAttribute]=e[a.serverIdAttribute]+"";var i=a.findWhere(t);e.serverSetId=!0,i?(e[a.idAttribute]||(e[a.idAttribute]=i.get(a.idAttribute)),i.save(e,{ignoreSave:!0,ignoreRender:!0})):(e[a.idAttribute]||(e[a.idAttribute]=e[a.serverIdAttribute]),a.create(e,{ignoreSave:!0,ignoreRender:!0}),e.archived||(n=!0))}),a.trigger("change",null,{ignoreSave:!0}),a.models.slice().forEach(function(e){if(o.indexOf(e.get(a.serverIdAttribute))<0){var t={};t[a.idAttribute]=e.get([a.idAttribute])+"";var i=a.findWhere(t);i.id=i.get(i.idAttribute),i.destroy({silent:!0}),n=!0}}),n&&a.trigger("refresh")}}).fail(function(){t&&t()}).always(function(){e&&e()})}}),m.models.GenericMetric=Backbone.Model.extend({defaults:{id:null,label:"",value:"",link:null},initialize:function(){this.listenTo(this,"change:metric",this.metricChanged),this.loadData()},loadData:function(){var d=this;this.set("label","");var e=m.globals.urlRootIntegration+"services/random";try{$.ajax({type:"GET",contentType:"application/json",beforeSend:m.utils.setMomentumAuthHeader,url:e}).done(function(e,t,i){if(e.metricInfo)d.set("id",e.metricInfo.metricId),d.set("value",e.metricInfo.metricValue),d.set("label",e.metricInfo.metricLabel),e.metricInfo.metricLink?d.set("link",e.metricInfo.metricLink):d.set("link",null);else if(e.status&&"authRequired"==e.status&&e.authorizationUrl&&d.authAttempts<2){d.authAttempts++;var n=e.winWidth?e.winWidth:600,o=e.winHeight?e.winHeight:510,a=e.windowFeatures?e.windowFeatures:"titlebar,resizable,toolbar,status",s=window.screen.width/2-n/2,r=window.screen.height/2-o/2,l=window.open(e.authorizationUrl,"MomentumAuthWindow",a+",left="+s+",top="+r+",width="+n+",height="+o),c=setInterval(function(){l.closed&&(clearInterval(c),d.metricChanged())},250)}}).fail(function(e,t){console.log("failed")})}catch(e){}},clickMetric:function(){this.get("link")}}),m.views.GenericMetric=Backbone.View.extend({attributes:{id:"generic-stats",class:"generic-stats metric metric-item app-container app-dash add-shadow"},template:m.templates.metric.widget,events:{click:"clickMetric",mouseenter:"mouseEnter",mouseleave:"mouseLeave"},initialize:function(){this.renderedOnce=!1,this.render(),this.listenTo(this.model,"change:value",this.render),this.listenTo(this.model,"change:label",this.render)},render:function(){var e=this.model.get("label"),t=this.model.get("value");if(t){var i={statvalue:t,statlabel:e};if(this.renderedOnce)this.$el.html(this.template(i)),this.$time=this.$(".time"),this.$format=this.$(".format");else{var n=(this.options.order||"append")+"To";this.$el[n]("."+this.options.region).mFadeIn().html(this.template(i)),this.$time=this.$(".time"),this.$format=this.$(".format"),this.renderedOnce=!0}}},clickMetric:function(e){this.model.clickMetric()}}),m.models.Quote=Backbone.Model.extend({idAttribute:"forDate"}),m.models.TeamInfo=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("team-info"),defaults:{team:null,id:1},initialize:function(){this.fetch()}}),m.collect.Quotes=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-quote"),model:m.models.Quote,getActiveQuote:function(){if(0<this.length){var e=getActiveDateString();return this.get(e)}}}),m.models.QuoteManager=Backbone.Model.extend({initialize:function(e,t){m.collect.quotes=new m.collect.Quotes},firstFetch:function(){m.collect.quotes.fetch({reset:!0})},skipErrorMessage:{message:"Oops! We weren't able to get a new quote. Please check your connection and try again.",viewLimit:1},favouriteErrorMessage:{message:"Oops! We weren't able to save the favorite. Please check your connection and try again.",viewLimit:1},getActiveQuote:function(){var e=this;if(m.collect.quotes){var t=m.collect.quotes.getActiveQuote();if(!t)return null;var i=!1;if(this.currentQuote&&this.currentQuote.get("_id")==t.get("_id")){var n=this.currentQuote;n.get("body")==t.get("body")&&n.get("source")==t.get("source")&&n.get("twitter")==t.get("twitter")&&n.get("twitterIntentUrl")==t.get("twitterIntentUrl")||(this.currentQuote=t,i=!0)}else this.currentQuote=t,i=!0;return i&&setTimeout(function(){m.trigger("quote:active_changed",e.currentQuote.get("_id"))},50),t}return null},skipQuote:function(i){var n=this,e=m.globals.urlRootApi+"quotes",t=this.getActiveQuote(),o={operation:"skip",active_uuid:t.get("_id"),is_custom:t.get("is_custom")};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(o),url:e}).done(function(e){if(e&&e.success&&m.trigger("sync:download","quote"),e&&e.notification){if("max_skips"==e.notification.type){if(localStorage.getItem("maxQuoteSkips"))return;localStorage.setItem("maxQuoteSkips",!0)}e.notification.display_time||(e.notification.display_time=5e3),m.commandManager.execute("notification.show.enhanced",e.notification)}}).fail(function(e,t){m.commandManager.execute("notification.show.enhanced",n.skipErrorMessage),i&&i()})}catch(e){m.commandManager.execute("notification.show.enhanced",n.skipErrorMessage),i&&i()}},toggleFavorite:function(e,i){var n=this,t=m.globals.urlRootApi+"quotes/favorites",o=this.getActiveQuote(),a={operation:"favorite",active_uuid:o.get("_id"),is_favorite:e,is_custom:o.get("is_custom")};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(a),url:t}).done(function(e){e&&e.success&&(m.trigger("sync:download","quote"),m.trigger("quote:favorite",{id:a.active_uuid,is_favorite:a.is_favorite}))}).fail(function(e,t){m.commandManager.execute("notification.show.enhanced",n.favouriteErrorMessage),i&&i()})}catch(e){m.commandManager.execute("notification.show.enhanced",n.favouriteErrorMessage),i&&i()}},latestQuoteDate:function(){var i=null;return m.collect.quotes.models.forEach(function(e){var t=Date.parse(e.id);(!i||i<t)&&(i=t)}),i}}),m.views.Quote=Backbone.View.extend({attributes:{class:"app-container quote"},template:m.templates.quote.quote,events:{click:"handleClick","mouseenter .control":"controlHoverOn","mouseleave .control":"controlHoverOff",mouseenter:"hoverOn",mouseleave:"hoverOff","click .control-twitter":"shareTwitter","click .control-heart":"toggleFavorite","click .control-refresh":"skipQuote"},currentlyActiveQuote:null,initialize:function(){this.renderedOnce=!1;var o=this;this.listenTo(m,"newDay",this.handleNewDay,this),this.listenTo(this.collection,"reset",this.collectionReady),this.listenTo(m.models.customization,"change:quoteVisible",this.visibleChanged),$(window).on("resize",function(){if(o.$quoteBody){var e=o.$quoteBody.css("lineHeight"),t=parseInt(e.substring(0,e.length-2)),i=o.$quoteBody.clone();i.html("&ldquo;"+m.models.quoteManager.getActiveQuote().get("body")+"&rdquo;"),i.css("position","absolute"),i.css("width","100%"),i.css("top","0"),i.css("left","0"),i.css("margin","0"),i.css("padding","0"),i.appendTo(o.$quoteBody);var n=i.height();(n<1.75*t||2.75*t<n)&&o.$quoteBody.html("&ldquo;"+m.models.quoteManager.getActiveQuote().get("body")+"&rdquo;"),o.render(),i.remove()}})},handleNewDay:function(){var e=this;e.intervalId=setInterval(function(){0<e.collection.length&&(e.render(),clearInterval(e.intervalId))},50)},parentReady:function(e){if(this.isParentReady=!0,this.isCollectionReady||e){this.render();try{m.usage.itemLoaded(m.models.quoteManager.getActiveQuote(),m.usage.types.QUOTE)}catch(e){}}},collectionReady:function(){if(m.trigger("quote:downloaded"),this.isCollectionReady=!0,this.isParentReady){this.render();try{m.usage.itemLoaded(m.models.quoteManager.getActiveQuote(),m.usage.types.QUOTE)}catch(e){}}},visibleChanged:function(e){m.models.customization.get("quoteVisible")?this.renderedOnce?this.$el.mFadeIn():this.render():this.$el.mFadeOut()},render:function(){if(0!==this.collection.length){var e=m.models.quoteManager.getActiveQuote();if(e){var t=!1;if(this.currentlyActiveQuote&&this.currentlyActiveQuote.get("_id")==e.get("_id")){var i=this.currentlyActiveQuote;i.get("body")==e.get("body")&&i.get("source")==e.get("source")&&i.get("twitter")==e.get("twitter")&&i.get("twitterIntentUrl")==e.get("twitterIntentUrl")||(this.currentlyActiveQuote=e,t=!0)}else this.currentlyActiveQuote=e,t=!0;var r=this,l=e.get("body"),n=e.get("source"),o=e.get("detail_url"),a=e.get("twitter"),s=e.get("twitterIntentUrl"),c=!1,d="";if(e.get("is_favorite")&&(c=!0,d="active"),!s){var u="";u=a?'"'+l+'" —@'+a:'"'+l+'" —'+n,s="https://twitter.com/intent/tweet?text="+encodeURIComponent(u)+"&via=momentumdash&related=momentumdash,levibucsis,jaywaterman"}var g=0;if(t&&this.renderedOnce&&(g=650),this.renderedOnce)t&&(this.$el.addClass("u--no-opacity"),setTimeout(function(){r.$quoteBody.html("&ldquo;"+l+"&rdquo;"),r.$quoteSource.html(n),r.$control_twitter.data("url",s),r.$el.removeClass("u--no-opacity")},500));else{var h={body:l,source:n,twitterIntentUrl:s,fav_class:d},f=(this.options.order||"append")+"To";this.$el[f]("."+r.options.region).html(r.template(h)),m.appsLoaded&&this.$el.mFadeIn(),this.$quoteBody=this.$(".quote-body-text").first(),this.$quoteSource=this.$el.find(".quote-source-text").first(),this.$control_heart=this.$el.find(".control-heart").first(),this.$control_refresh=this.$el.find(".control-refresh").first(),this.$control_twitter=this.$el.find(".control-twitter").first(),this.renderedOnce=!0}o&&0<o.length?(this.detail_url=o,this.$el.addClass("has-link")):(this.detail_url=null,this.$el.removeClass("has-link")),this.$control_refresh.removeClass("active"),m.conditionalFeatures.featureEnabled("skip-qt")?this.$el.find(".control-refresh").show():this.$el.find(".control-refresh").hide(),this.$control_heart.show(),c?this.$control_heart.addClass("active"):this.$control_heart.removeClass("active"),m.appsReady?p():this.listenTo(m,"appsReady",p)}else m.trigger("sync:downloadIfNeeded")}else m.trigger("sync:downloadIfNeeded");function p(){setTimeout(function(){var e=r.$quoteBody.css("lineHeight"),t=parseInt(e.substring(0,e.length-2)),i=r.$quoteBody.height(),n=!1;if(1.75*t<i&&i<2.75*t){var o,a="",s=l.split(" ");for(o=0;o<s.length;o++)a+=s[o],!n&&a.length>(l.length+5)/2?(a+="<br>",n=!0):o!=s.length-1&&(a+=" ");r.$quoteBody.html("&ldquo;"+a+"&rdquo;"),2.75*t<(i=r.$quoteBody.height())&&r.$quoteBody.html("&ldquo;"+l+"&rdquo;")}},g)}},handleClick:function(e){this.detail_url&&0<this.detail_url.length&&(e.preventDefault(),e.stopPropagation(),window.open(this.detail_url,"_blank"))},hoverOn:function(){try{var e=this;e.hover=!0,setTimeout(function(){e.hover&&m.usage.recordHover(m.models.quoteManager.getActiveQuote(),m.usage.types.QUOTE)},500)}catch(e){}},hoverOff:function(){this.hover=!1},controlHoverOn:function(){$(this.$el).removeClass("has-link")},controlHoverOff:function(){this.detail_url&&0<this.detail_url.length&&$(this.$el).addClass("has-link")},shareTwitter:function(e){e.stopPropagation();var t=screen.width/2-272.5,i=screen.height/2-210;window.open($(e.currentTarget).data("url"),"share","left="+t+",top="+i+",width=545,height=420,resizeable=0")},toggleFavorite:function(e){e.stopPropagation(),$(e.currentTarget).toggleClass("active");var t=$(e.currentTarget).hasClass("active");m.models.quoteManager.toggleFavorite(t,function(){$(e.currentTarget).toggleClass("active")}),m.sendEvent("Quote",t?"Favourite":"Unfavourite")},skipQuote:function(e){e.stopPropagation(),this.$control_refresh.hasClass("active")||($(e.currentTarget).addClass("active"),m.models.quoteManager.skipQuote(function(){$(e.currentTarget).removeClass("active")}),m.sendEvent("Quote","Skip"))}}),m.bootstrappers.InitializeQuote=function(e,t){e.models.quoteManager=new e.models.QuoteManager},m.bootstrappers.RenderQuote=function(t,e,i){t.conditionalFeatures.checkPreferenceForRender("quoteVisible",function(){t.models.customization.get("quoteVisible")&&(t.views.quote=new t.views.Quote({collection:t.collect.quotes,model:t.models.date,region:"bottom"}),t.models.quoteManager.firstFetch(),t.views.quote.parentReady(i),t.widgets.push(t.views.quote),t.stopListening(t.models.customization,"change:quoteVisible"))},function(e){t.listenTo(t.models.customization,"change:quoteVisible",e)})},m.models.Message=Backbone.Model.extend({defaults:function(){return{title:null,message:"",priority:5,views:0,viewLimit:3,deleted:!1,createdDate:Date.now(),visible:!1,loginOnClick:!1,fromServer:!1}},showMessage:function(e,t,i,n){m.commandManager.execute("notification.show.enhanced",{title:e,message:t,views:0,viewLimit:i,visible:!0,loginOnClick:n})},showMessageNow:function(e,t,i,n){m.commandManager.execute("notification.show.enhanced",{title:e,message:t,views:0,viewLimit:i,visible:!0,loginOnClick:n})},dismissMessage:function(){m.commandManager.execute("notification.dismiss")},save:function(e,t){if(t||(t={}),e||(e=_.clone(this.attributes)),e.hasOwnProperty("dismissed")&&e.dismissed&&(e.deleted=!0),!t.download_save&&this.get("fromServer"))try{var i=null;for(prop in e)e.hasOwnProperty(prop)&&"changed_props"!=prop&&"sync_success"!=prop&&(i||(i=this.get("changed_props")||[]),_.contains(i,prop)||i.push(prop));i&&(e.changed_props=i,e.sync_success=!1,t.silent=!1)}catch(e){}return Backbone.Model.prototype.save.call(this,e,t)}}),m.collect.Messages=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-messages"),model:m.models.Message,cleaned:!1,initialize:function(){this.listenTo(this,"reset",this.cleanupMessagesIfRequired)},cleanupMessagesIfRequired:function(){if(!this.cleaned){this.cleaned=!0;var i=[];this.each(function(e){if(e.get("deleted"))e.get("fromServer")&&e.get("sync_success")&&!e.get("changed_props")&&i.push(e);else{var t=e.get("filter");t&&m.conditionalFeatures.featureEnabled(t)?e.save({deleted:!0,filtered:!0}):5==e.get("priority")?e.get("fromServer")?e.save({deleted:!0}):i.push(e):e.get("visible")||e.save({deleted:!0})}}),0<i.length&&_.each(i,function(e){e.destroy()})}}}),m.models.NotificationSync=Backbone.Model.extend({baseUrl:m.globals.urlRootApi+"notifications",initialize:function(e){this.collection=e.collection,this.listenTo(this.collection,"change:changed_props",this.onChange),this.listenTo(this.collection,"reset",this.onReset)},findHavingAttribute:function(e,t){return e.filter(function(e){return e.has(t)})},hasAttribute:function(e,t){return!!e.find(function(e){return e.has(t)})},onReset:function(){this.syncToServer()},onChange:function(e,t){if(!t.ignoreSave){var i=e.changedAttributes();i&&i.hasOwnProperty("changed_props")&&i.changed_props&&this.syncToServer()}},syncToServer:function(e){var a=this,t=this.findHavingAttribute(this.collection,"changed_props");t&&0!=t.length?nimble.each(t,function(i,e){if(i.get("fromServer")){var t=i.get("changed_props");if(t&&0!=t.length){var n={};if(_.each(t,function(e){"changed_props"!=e&&"sync_success"!=e&&(n[e]=i.get(e))}),1==Object.keys(n).length&&n.hasOwnProperty("views"))e();else{var o=a.baseUrl+"/"+encodeURIComponent(i.id);$.ajax({url:o,contentType:"application/json",type:"PATCH",beforeSend:m.utils.setMomentumAuthHeader,data:JSON.stringify(n)}).done(function(e){e&&e.success&&i.save({changed_props:null,sync_success:!0},{silent:!0})}).fail(function(e,t){i.save({sync_success:!1},{silent:!0})}).always(function(){e()})}}else e()}},function(){e&&e()}):e&&e()}}),m.models.NotificationManager=Backbone.Model.extend({backgroundLoaded:!1,_notificationView:null,_parent:null,settingsVisible:!1,initialize:function(){this.displayed=[],this.collection=new m.collect.Messages,m.models.message=new m.models.Message,this.listenTo(this.collection,"add reset",this.displayPendingMessages),this.listenToOnce(m,"background:loadSuccessful",this.onBackgroundLoaded),this.listenTo(m,"settings:hidden",this.settingsHidden),this.listenTo(m,"settings:visible",this.onSettingsVisible),this.listenTo(m,"notifications:timestamp",this.onAvailableTimestamp),m.conditionalFeatures.featureEnabled("notifySyncOff")||(this.notifySync=new m.models.NotificationSync({collection:this.collection})),this.collection.fetch({reset:!0})},onBackgroundLoaded:function(){this.backgroundLoaded||(this.backgroundLoaded=!0,this.displayPendingMessages(),m.commandManager.execute("clean.localstorage"))},displayPendingMessages:function(){var i=this;if(this.collection.cleanupMessagesIfRequired(),this._parent&&this.backgroundLoaded&&!this.settingsVisible){var e=this.notificationView();if(e&&!e.notifying){var t=_.chain(this.collection.where({deleted:!1,visible:!0})).reject(function(e){var t=e.get("filter");return!(!t||!m.conditionalFeatures.featureEnabled(t))||_.contains(i.displayed,e)}).sortBy("priority").sortBy("createdDate").value();if(t&&0!=t.length){var n=t[0];this.displayed.push(n),e.showMessage(n)}}}},setParent:function(e){e&&(this._parent=e,this.displayPendingMessages())},onAvailableTimestamp:function(e){if(e){var t=localStorage.getItem("ts_notifications");(!t||t<e)&&this.downloadNotifications()}},downloadNotifications:function(){var t=this,e=localStorage.getItem("ts_notifications"),i=m.globals.urlRootApi+"notifications";e&&(e=parseInt(e,10),Number.isInteger(e)&&(i=i+"?ts="+e));try{$.ajax({type:"GET",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:i}).done(function(e){e&&e.timestamp&&(e.notifications&&0<e.notifications.length&&(t.collection.reset(e.notifications),t.collection.invoke("save",null,{download_save:!0})),localStorage.setItem("ts_notifications",e.timestamp))}).fail(function(e,t){})}catch(e){}},showMessage:function(e,t,i,n){var o={title:e,message:t,visible:!0};null!=i&&(o.viewLimit=i),null!=n&&(o.loginOnClick=n),this.collection.create(o)},showMessageEnhanced:function(e,t,i){e.hasOwnProperty("visible")||(e.visible=!0);var n={};t&&(n.success=t),i&&(n.silent=!0),this.collection.create(e,n)},dismissMessage:function(){this._notificationView&&this.notificationView().hideNotification()},settingsHidden:function(){this.settingsVisible=!1,this.displayPendingMessages()},onSettingsVisible:function(){this.settingsVisible=!0},notificationView:function(){return this._notificationView||(this._notificationView=new m.views.Notification({_parent:this._parent})),this._notificationView}}),m.views.Notification=Backbone.View.extend({attributes:{class:"notification"},template:m.templates.notification.notification,notifying:!1,timeoutId:null,events:{"click .notification-hide":"hideNotificationClicked","click .notification-button":"ctaButtonClicked","click .secondary-text":"secondaryTextClicked"},initialize:function(e){this._parent=e._parent,this.renderedOnce=!1,this.listenTo(m,"settings:visible",this.settingsVisible)},showMessage:function(e){this.model&&this.model.cid==e.cid||(this.model=e,this.render())},render:function(){var e=this;this.notifying=!0,this.incrementViews(),this.$el.html(this.template(this.model.toJSON())),this.$el.toggleClass("no-title",null===this.model.get("title")),this._parent.$el.prepend(this.$el),this.showNotification(),this.$message=this.$(".notification-description"),this.model.has("message_html")&&this.$message.html(this.model.get("message_html"));var t=this.model.get("display_time");!t||null==t||void 0===t||t<=0||(this.timeoutId=setTimeout(function(){e.hideNotification()},t))},incrementViews:function(){var e=this.model.get("views")+1;e>=this.model.get("viewLimit")?this.model.save({visible:!1,views:e}):this.model.save({views:e},{silent:!0})},settingsVisible:function(){this.hideNotification(!0,!0)},showNotification:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in")},hideNotification:function(t,e){clearTimeout(this.timeoutId);var i=this;this.$el.hasClass("show")&&this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){i.$el.removeClass("show"),t||m.models.notificationManager.displayPendingMessages()}),this.notifying&&(this.notifying=!1)},hideNotificationClicked:function(e){e.stopPropagation(),this.hideNotification(),this.model.save({dismissed:!0,visible:!1},{silent:!0})},ctaButtonClicked:function(e){e.stopPropagation(),this.hideNotification(!0,!0),this.notifying=!1;var t=this.model.get("cta_cmd"),i=this.model.get("cta_options");t&&0<t.length&&(this.model.save({ctaClicked:Date.now(),visible:!1},{silent:!0}),m.commandManager.execute(t,null,i))},secondaryTextClicked:function(e){e.stopPropagation(),this.model.get("secondary_hide")&&(this.hideNotification(!0,!0),this.notifying=!1);var t=this.model.get("secondary_cmd"),i=this.model.get("secondary_options");t&&0<t.length&&(this.model.save({secondaryClicked:Date.now()},{silent:!0}),m.commandManager.execute(t,null,i))}}),m.commands.NotificationShow=m.models.Command.extend({defaults:{id:"notification.show"},execute:function(e,t){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessage(e,t)},10)}}),m.commands.NotificationShowEnhanced=m.models.Command.extend({defaults:{id:"notification.show.enhanced"},execute:function(e,t,i){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessageEnhanced(e,t,i)},10)}}),m.commands.NotificationDismiss=m.models.Command.extend({defaults:{id:"notification.dismiss"},execute:function(){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.dismissMessage()},5)}}),m.models.PersistentSettings=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("momentum-customization"),defaultIfNotSet:{bookmarksVisible:!1,linksVisible:!0,focusVisible:!0,todoVisible:!0,weatherVisible:!0,quoteVisible:!0,searchVisible:!0,requestSync:!1,keepTodoState:!0,countdownVisible:!1,notesVisible:!1,percentClock:!1,multiClockVisible:!0,linksKeepOpen:!1,themeColour:"dark",autoFocus:!1,balanceModeStr:"",bookmarksSettingsStr:""},initialize:function(){var t=this;t.fetching=!1,window.addEventListener("storage",function(e){e.key&&0===e.key.indexOf("momentum-customization-1")&&(t.fetching=!0,t.fetch({success:function(){t.fetching=!1},error:function(){t.fetching=!1},reset:!0}))})},get:function(e){var t=this.constructor.__super__.get.apply(this,arguments);return void 0===t&&this.defaultIfNotSet.hasOwnProperty(e)&&(t=this.defaultIfNotSet[e]),t}}),m.models.BalanceMode=Backbone.Model.extend({defaults:{enabled:!1,active:!1,balanceClock:!1,balanceTodo:!1,balanceFocus:!0,balanceNotes:!1,customTime:!1,customDays:!1,start:{hour:9,minute:"00",noon:"AM"},end:{hour:5,minute:"00",noon:"PM"},startCustom:{hour:9,minute:"00",noon:"AM"},endCustom:{hour:5,minute:"00",noon:"PM"},days:[!1,!0,!0,!0,!0,!0,!1],daysCustom:[!1,!0,!0,!0,!0,!0,!1]},initialize:function(e,t){this.customization=t.customization||m.models.customization,this.listenTo(this.customization,"change:balanceModeStr",this.customizationChanged),this.listenTo(this,"change:enabled",this.balanceChanged),this.listenTo(m.models.date,"change:date",this.checkBalance)},checkBalance:function(){var e=new Date,t=this.getStart(),i=this.getEnd(),n=this.getDays(),o=t.hour+":"+t.minute+t.noon,a=i.hour+":"+i.minute+i.noon,s=this.get("active"),r=m.utils.toTodaysTime(a),l=m.utils.toTodaysTime(o),c=new Date(l.getTime());c.setDate(l.getDate()-1);var d=new Date(r.getTime());d.setDate(r.getDate()+1),this.set("active",this.get("enabled")&&(!n[e.getDay()]||r.getTime()>l.getTime()&&(l.getTime()>e.getTime()||e.getTime()>r.getTime())||r.getTime()<l.getTime()&&!(c.getTime()<e.getTime()&&e.getTime()<r.getTime()||l.getTime()<e.getTime()&&e.getTime()<d.getTime()))),s!=this.get("active")&&this.balanceChanged()},customizationChanged:function(e,t){var i=this.customization.get("balanceModeStr");i&&i!=this.balanceModeStr&&0<i.length&&this.resetBalanceMode()},resetBalanceMode:function(){if(this.balanceModeStr=this.customization.get("balanceModeStr"),this.balanceModeStr&&0<this.balanceModeStr.length){var e=JSON.parse(this.balanceModeStr);this.set("enabled",void 0===e.enabled?this.defaults.enabled:e.enabled),this.set("start",e.start||this.defaults.start),this.set("end",e.end||this.defaults.end),this.set("days",e.days||this.defaults.days),this.set("customDays",void 0===e.customDays?this.defaults.customDays:e.customDays),this.set("customTime",void 0===e.customTime?this.defaults.customTime:e.customTime),this.set("startCustom",e.startCustom||this.defaults.startCustom),this.set("endCustom",e.endCustom||this.defaults.endCustom),this.set("daysCustom",e.daysCustom||this.defaults.daysCustom),this.set("balanceClock",void 0===e.balanceClock?this.defaults.balanceClock:e.balanceClock),this.set("balanceFocus",void 0===e.balanceFocus?this.defaults.balanceFocus:e.balanceFocus),this.set("balanceTodo",void 0===e.balanceTodo?this.defaults.balanceTodo:e.balanceTodo),this.set("balanceNotes",void 0===e.balanceNotes?this.defaults.balanceNotes:e.balanceNotes),this.initCompleted=!0,this.checkBalance()}},getDays:function(){return this.get("customDays")?this.get("daysCustom"):this.get("days")},getStart:function(){return this.get("customTime")?this.get("startCustom"):this.get("start")},getEnd:function(){return this.get("customTime")?this.get("endCustom"):this.get("end")},get:function(e){return!!("customDays"!=e&&"customTime"!=e||m.conditionalFeatures.featureEnabled("plus"))&&Backbone.Model.prototype.get.call(this,e)},balanceChanged:function(){this.initCompleted&&this.customization.save({balanceModeStr:JSON.stringify(this.attributes)})}}),m.models.BookmarksSettings=Backbone.Model.extend({defaults:{guided:!1,iconsOnly:!1,openInNewTab:!1,appsLocation:"links",includeBookmarks:!1,includeOtherBookmarks:!1,defaultMostVisited:!1,includeMostVisited:!0,chromeTabLocation:"links"},initialize:function(){this.listenTo(m.models.customization,"change:bookmarksSettingsStr",this.customizationChanged),this.permissions={permissions:["bookmarks","topSites"]},isChrome()&&(this.permissions.origins=["chrome://favicon/"])},customizationChanged:function(e,t){var i=m.models.customization.get("bookmarksSettingsStr");i&&i!=this.bookmarksSettingsStr&&0<i.length&&this.reset()},reset:function(){this.bookmarksSettingsStr=m.models.customization.get("bookmarksSettingsStr");if(this.bookmarksSettingsStr&&0<this.bookmarksSettingsStr.length){var t=JSON.parse(this.bookmarksSettingsStr),i=this;["iconsOnly","openInNewTab","appsLocation","includeBookmarks","includeOtherBookmarks","defaultMostVisited","includeMostVisited","chromeTabLocation","guided"].forEach(function(e){i.set(e,null==t[e]?i.defaults[e]:t[e])}),localStorage.setItem("bookmarksEnabled",m.models.customization.get("bookmarksVisible")),setTimeout(function(){initializeBookmarksPlaceHolder()},500)}},optionsChanged:function(){m.models.customization.save({bookmarksSettingsStr:JSON.stringify(this.attributes)})}}),m.models.ComputedSettings=Backbone.Model.extend({defaults:{todoVisible:!1,focusVisible:!1,autoFocus:!1,clockVisible:!1,notesVisible:!1},initializeSettings:function(e){var t=this;this.persistentSettings=new m.models.PersistentSettings({id:1}),this.listenTo(this.persistentSettings,"change",this.computeProperties),this.listenTo(this.persistentSettings,"sync",function(){var e=t.persistentSettings.get("balanceModeStr");e&&0<e.length&&(m.models.balanceMode.resetBalanceMode(),t.computeProperties()),t.initialized||(t.initialized=!0,t.trigger("initialized"))}),m.conditionalFeatures=new m.models.ConditionalFeatures({customization:this}),m.models.balanceMode=this.balanceMode=new m.models.BalanceMode({id:1},{customization:this}),m.models.bookmarksSettings=new m.models.BookmarksSettings({id:1}),this.persistentSettings.fetch({error:function(e,t,i){"Record Not Found"==t&&e.save()}})},checkBalanceMode:function(e,t,i){var n=this.attributes[e],o=!!i||(!this.persistentSettings.has(e)||this.persistentSettings.get(e));this.attributes[e]=o&&!(m.models.balanceMode.get("active")&&m.models.balanceMode.get(t)),n!=this.attributes[e]&&this.trigger("change:"+e)},checkAutoFocus:function(){var e="autoFocus",t=this.attributes[e];return this.attributes[e]=this.persistentSettings.get(e)&&this.persistentSettings.get("todoVisible")&&m.conditionalFeatures.featureEnabled("plus"),this.attributes[e]=this.persistentSettings.get(e)&&this.persistentSettings.get("todoVisible")&&m.conditionalFeatures.featureEnabled("plus"),t!=this.attributes[e]},computeProperties:function(t,i,n){var o=this;this.checkBalanceMode("todoVisible","balanceTodo"),this.checkBalanceMode("clockVisible","balanceClock",!0),this.checkBalanceMode("focusVisible","balanceFocus"),this.checkBalanceMode("notesVisible","balanceNotes");var e=this.persistentSettings.changedAttributes();e||(e={}),this.checkAutoFocus()&&!e.autoFocus&&(e.autoFocus=this.attributes.autoFocus),_.keys(e).forEach(function(e){o.trigger("change:"+e,t,i,n)}),this.trigger("change",t,i,n)},get:function(e){return this.persistentSettings.get(e)},getPersistentSettings:function(){return this.persistentSettings},getComputedSetting:function(e){return null!=this.attributes[e]?Backbone.Model.prototype.get.call(this,e):this.persistentSettings.get(e)},set:function(){arguments[0].id?Backbone.Model.prototype.set.apply(this,arguments):this.persistentSettings.set.apply(this.persistentSettings,arguments)},save:function(){this.persistentSettings.save.apply(this.persistentSettings,arguments)},fetch:function(){this.persistentSettings.fetch.apply(this.persistentSettings,arguments)},toggle:function(e){if(e){var t=!this.get(e),i={};i[e]=t,this.save(i)}}}),m.views.settings=m.views.settings||{},m.views.settings.SettingsPane=Backbone.View.extend({attributes:{id:"settings",class:"app-container settings"},renderedOnce:!1,events:{"click .toggle":"toggleShow"},libraryLoadStarted:!1,initialize:function(){this.subViews=[],this.render(),this.listenTo(m,"globalEvent:esc globalEvent:click globalEvent:toggle",this.hideSettings),this.listenTo(m,"globalEvent:toggleSettings",this.toggleShow),this.listenTo(m,"settings:visible",this.settingsVisible),this.listenTo(m,"settings:hidden",this.settingsHidden),this.visible=!1},render:function(){if(!this.renderedOnce){var e=(this.options.order||"append")+"To";this.$el[e]("."+this.options.region).html('<span class="app-dash toggle"><svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 340.274 340.274"><path d="M293.629 127.806l-5.795-13.739c19.846-44.856 18.53-46.189 14.676-50.08l-25.353-24.77-2.516-2.12h-2.937c-1.549 0-6.173 0-44.712 17.48l-14.184-5.719c-18.332-45.444-20.212-45.444-25.58-45.444h-35.765c-5.362 0-7.446-.006-24.448 45.606l-14.123 5.734C86.848 43.757 71.574 38.19 67.452 38.19l-3.381.105-27.27 26.737c-4.138 3.891-5.582 5.263 15.402 49.425l-5.774 13.691C0 146.097 0 147.838 0 153.33v35.068c0 5.501 0 7.44 46.585 24.127l5.773 13.667c-19.843 44.832-18.51 46.178-14.655 50.032l25.353 24.8 2.522 2.168h2.951c1.525 0 6.092 0 44.685-17.516l14.159 5.758c18.335 45.438 20.218 45.427 25.598 45.427h35.771c5.47 0 7.41 0 24.463-45.589l14.195-5.74c26.014 11 41.253 16.585 45.349 16.585l3.404-.096 27.479-26.901c3.909-3.945 5.278-5.309-15.589-49.288l5.734-13.702c46.496-17.967 46.496-19.853 46.496-25.221V151.88c-.005-5.519-.005-7.446-46.644-24.074zM170.128 228.474c-32.798 0-59.504-26.187-59.504-58.364 0-32.153 26.707-58.315 59.504-58.315 32.78 0 59.43 26.168 59.43 58.315-.006 32.177-26.656 58.364-59.43 58.364z" fill="#FFF"/></svg></span>'),this.renderedOnce=!0}return this},toggleShow:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.trigger("globalEvent:click",this),this.visible?m.commandManager.execute("settings.toggle"):this.initializeSettings().then(function(){m.commandManager.execute("settings.toggle")})},initializeSettings:function(){var i=this;return new Promise(function(e,t){i.initialized?e():(this.initialized=!0,m.commandManager.ensureCommandLoaded("settings.initialize",function(){i.mainSettings=m.commandManager.execute("settings.initialize",i.$el),setTimeout(function(){e()},50)}))})},hideSettings:function(e){e!=this&&(e.originalEvent&&"click"==e.type&&e.target&&this.mainSettings&&$.contains(this.mainSettings.el,e.target)||(m.commandManager.execute("settings.hide"),this.visible=!1))},settingsVisible:function(){this.$el.addClass("show").outerWidth(),this.$el.addClass("show-fade-in"),this.visible=!0},settingsHidden:function(e){if(e&&e.preventDefault(),this.$el.hasClass("show")){this.visible=!1;var t=this;this.$el.removeClass("show-fade-in").one("transitionend webkitTransitionEnd",function(e){t.$el.removeClass("show")})}}}),m.views.upsell=m.views.upsell||{},m.views.upsell.message=Backbone.View.extend({showing:!1,events:{"click .hide":"hideUpsell","click .upsell-action":"clickButton"},initialize:function(e){this.template=e.template,this.options=e,this.listenTo(m,"globalEvent:click",this.handleClick)},render:function(){return this.options.class=(this.options.class?this.options.class+" ":"")+this.options.targetRegion+"-upsell",this.$el.html(this.template(this.options)),this.$el.addClass("overlay upsell"),this.$el.addClass(this.options.class),this},show:function(){var e=this,t=e.$el.height();e.$el.addClass("show"),this.showing=!0,setTimeout(function(){e.parentMinHeight=e.$el.parent().css("min-height"),e.parentMinHeight&&(e.parentMinHeight=parseInt(e.parentMinHeight.substring(0,e.parentMinHeight.length-2))),e.$el.parent().css("min-height",Math.max(t,e.parentMinHeight)),e.$el.addClass("show-fade-in")},10)},hideUpsell:function(e){e&&e.stopPropagation(),this.$el.removeClass("show-fade-in"),this.showing=!1;var t=this;t.$el.parent().css("min-height",t.parentMinHeight?t.parentMinHeight:0),setTimeout(function(){t.$el.removeClass("show")},300)},handleClick:function(e){this.$el[0]===e.target||$.contains(this.$el[0],e.target)||1!=this.$el.css("opacity")||this.hideUpsell()},clickButton:function(e){e.stopPropagation(),m.commandManager.execute("upsell.website",null,{source:this.options.sourceEvent})}}),m.commands.UpsellMessage=m.models.Command.extend({defaults:{id:"upsell.message"},execute:function(e){m.widgetManager.getWidget(e.targetRegion).showUpsell(e)}}),m.commands.UpsellWebsite=m.models.Command.extend({defaults:{id:"upsell.website"},execute:function(e,t){var i="https://momentumdash.com/plus?utm_source=extension&utm_medium=organic";t&&t.source?i+="&utm_campaign="+encodeURIComponent(t.source):!t&&e&&e.source&&(i+="&utm_campaign="+encodeURIComponent(e.source)),m.commandManager.execute("window.open",null,{url:i})}}),m.views.Greeting=Backbone.View.extend({attributes:{id:"greeting",class:"app-container greeting"},template:m.templates.greeting["greeting-template"],events:{"dblclick .name":"editName","keypress .name":"onKeypress","keydown .name":"onKeydown","blur .name":"saveName","webkitAnimationEnd .name":"onAnimationEnd"},initialize:function(){this.render(),this.listenTo(this.model,"change:time",this.updatePeriod,this),this.listenTo(m.models.customization,"change:displayname",this.onUpdateName)},render:function(){var e={period:this.getPeriod(),name:m.models.customization.get("displayname")},t=(this.options.order||"append")+"To";this.$el[t]("."+this.options.region).html(this.template(e)),m.appsLoaded&&this.$el.mFadeIn(),this.$period=this.$(".period"),this.$name=this.$(".name");var i=this;m.models.customization.getComputedSetting("clockVisible")?i.$el.addClass("transition"):setTimeout(function(){i.moveToCenter(),setTimeout(function(){i.$el.addClass("transition")},1e3)},10),setTimeout(function(){i.renderedOnce=!0},1e3)},getPeriod:function(){var e,t=this.model.get("date").getHours();return 3<=t&&t<12&&(e="morning"),12<=t&&t<17&&(e="afternoon"),(17<=t||t<3)&&(e="evening"),e},updatePeriod:function(){this.$period.html(this.getPeriod())},editName:function(){this.$name.hasClass("editing")||(this.$name.attr("contenteditable",!0).addClass("editing pulse").focus(),setEndOfContenteditable(this.$name.get(0)))},onUpdateName:function(){this.$name.html(m.models.customization.get("displayname")),this.$name.attr("contenteditable",!1),this.renderedOnce&&this.$name.addClass("pulse")},onAnimationEnd:function(e){"pulse"===e.originalEvent.animationName&&this.$name.removeClass("pulse")},onKeypress:function(e){13==e.keyCode&&(e.preventDefault(),this.saveName())},onKeydown:function(e){27===e.keyCode&&(this.$name.html(m.models.customization.get("displayname")),this.doneEditingName())},saveName:function(){var e=this.$name.text();""===e?this.$name.html(m.models.customization.get("displayname")):m.models.customization.save({displayname:e}),this.doneEditingName()},doneEditingName:function(){this.$name.attr("contenteditable",!1).removeClass("editing").addClass("pulse")},moveToCenter:function(){if(!this.isCenter){var e=(document.body.getBoundingClientRect().height-this.$el.outerHeight(!0))/2-this.$el[0].getBoundingClientRect().top;this.$el.css("transform","translateY("+e+"px)"),this.isCenter=!0}},moveOffCenter:function(){this.isCenter&&(this.$el.css("transform","translateY(0)"),this.isCenter=!1)}}),m.views.CenterClock=Backbone.View.extend({attributes:{class:"app-container clock"},events:{dblclick:"toggleMode"},initialize:function(){var e=localStorage.getItem("percentClockActive");e&&(m.models.customization.save("percentClockActive",e),localStorage.removeItem("percentClockActive")),this.listenTo(m.models.customization,"change:percentClock",this.percentClockToggled),this.listenTo(m.models.customization,"change:percentClockActive",this.percentClockToggled),this.listenTo(m.models.customization,"change:clockVisible",this.balanceChanged),this.listenTo(m.models.customization,"change:balanceModeStr",this.balanceChanged),this.renderedOnce=!1,this.render()},render:function(){var e=m.models.customization.getComputedSetting("clockVisible");if(e||!this.renderedOnce){var t=(this.options.order||"append")+"To";m.models.customization.get("percentClock")&&m.models.customization.get("percentClockActive")&&m.models.balanceMode.getDays()[(new Date).getDay()]?m.views.percentClock=m.views.clockView=new m.views.PercentClock({model:this.model,parent:this}):m.views.clockView=new m.views.DefaultClock({model:this.model,parent:this,renderedOnce:this.renderedOnce});var i=this;return this.$el[t]("."+this.options.region).html(""),this.$el.append(m.views.clockView.render().$el),e&&this.$el.mFadeIn(),setTimeout(function(){i.renderedOnce=!0},1e3),this}},balanceChanged:function(){var e=m.models.customization.getComputedSetting("clockVisible");if(this.oldVisibility!==e){var t=this;this.oldVisibility=e;var i=!1,n=!1;e?(this.renderedOnce?i=!0:(setTimeout(function(){t.render()},5),n=!0),setTimeout(function(){i&&t.$el.mFadeIn(),m.views.greeting.moveOffCenter()},n?10:0)):(t.$el.mFadeOut(500,!0),m.views.greeting.moveToCenter())}},percentClockToggled:function(e){e&&e.changed&&1==Object.keys(e.changed).length&&e.changed.percentClock&&m.models.customization.get("percentClock")&&m.models.customization.save("percentClockActive",!0),this.render()},toggleMode:function(){m.models.customization.get("percentClock")&&(m.models.customization.save("percentClockActive",!m.models.customization.get("percentClockActive")),this.render())}}),m.views.DefaultClock=Backbone.View.extend({attributes:{class:"default-clock"},template:m.templates.centerclock.clock,events:{dblclick:"toggleFormat"},initialize:function(e){this.type="default",this.renderedOnce=e.renderedOnce,this.render(),this.listenTo(this.model,"change:time",this.update,this),this.listenTo(m.models.customization,"change:hour12clock",this.timeFormatSettingChanged)},render:function(){var e={time:this.model.getTimeString(),format:this.model.getTimePeriod()};this.$el.html(this.template(e)),this.$time=this.$(".time"),this.$format=this.$(".format"),this.update();var t=this;return this.renderedOnce?this.setTimeFormat(m.models.customization.get("hour12clock")):setTimeout(function(){t.renderedOnce=!0},1e3),this},update:function(){this.$time.html(this.formatOnes(this.model.getTimeString()))},formatOnes:function(e){return e.replace(/1/g,'<span class="clock-one">1</span>')},toggleFormat:function(){if(!m.models.customization.get("percentClock")){var e=m.models.customization.get("hour12clock");e=!e,m.models.customization.save({hour12clock:e}),this.setTimeFormat(e,!0)}},timeFormatSettingChanged:function(){var e=m.models.customization.get("hour12clock");this.setTimeFormat(e,!0),this.update()},setTimeFormat:function(e,t){e&&this.renderedOnce?(t&&setTimeout(function(){$(".format").addClass("show")},40),this.$format.html(this.model.getTimePeriod())):$(".format").removeClass("show")}}),m.views.PercentClock=Backbone.View.extend({attributes:{class:"percent-clock"},template:m.templates.centerclock.clock,events:{},initialize:function(){this.type="percent",this.render(),this.listenTo(this.model,"change:time",this.update,this),this.listenTo(m.models.balanceMode,"change",this.update,this)},render:function(){return this.$el.html(this.template({time:this.getPercent(),format:"%"})),this.$time=this.$(".time"),this.$format=this.$(".format"),this.$format.css({opacity:1,"font-size":"250%",left:"106%",bottom:"7%"}),this},getPercent:function(){var e=m.models.balanceMode.getStart(),t=m.models.balanceMode.getEnd(),i=parseInt(e.hour);12===i&&(i=0);var n=parseInt(t.hour);12===n&&(n=0);var o=i+("PM"===e.noon?12:0),a=parseInt(e.minute),s=n+("PM"===t.noon?12:0),r=parseInt(t.minute)-1;24<s-o&&(s-=24);var l=new Date,c=new Date;c.setHours(o,a,0,0);var d=new Date;d.setHours(s,r,0,0),c.getTime()>d.getTime()&&(l.getTime()<=d.getTime()?o-=24:s+=24),c.setHours(o,a,0,0),d.setHours(s,r,0,0);var u=60*(s+r/60-(o+a/60))*60,g=(l.getTime()-c.getTime())/1e3,h=Math.floor(g/u*100);return 100<h&&(h="+"+(h-100)),h},update:function(){this.$time.html(this.getPercent())}}),m.commands.AuthConnect=m.models.Command.extend({defaults:{id:"auth.connect"},execute:function(e){m.commandManager.execute("auth.connect.provider",e.actionParameter,function(){m.trigger("todoListManager:fetch")})}}),m.commands.AuthConnectProvider=m.models.Command.extend({defaults:{id:"auth.connect.provider"},execute:function(e,t,i){if(e&&e.status&&"authRequired"===e.status&&e.authorizationUrl){var n=e.winWidth?e.winWidth:600,o=e.winHeight?e.winHeight:510,a=e.windowFeatures?e.windowFeatures:"titlebar,resizable,status",s=window.screen.width/2-n/2,r=window.screen.height/2-o/2,l=window.open(e.authorizationUrl,"MomentumAuthWindow",a+",left="+s+",top="+r+",width="+n+",height="+o),c=function(){l.closed||setTimeout(function(){l.closed||l.close()},1e3),t&&t()},d=e.authorizationUrl.split("/"),u="";1<d.length&&(u=d[d.length-1]);var g=m.globals.urlRootApi+"user/auth/status/"+u,h=0,f=1e3,p=function(){l.closed?c():100<++h||(h%30&&(f+=1e3),$.ajax({type:"GET",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:g}).done(function(e){e&&e.token_obtained?c():setTimeout(function(){p()},f)}).fail(function(e,t){setTimeout(function(){p()},f)}))};p()}else i&&i()}}),m.commands.CleanLocalStorage=m.models.Command.extend({defaults:{id:"clean.localstorage"},initialize:function(){this.twoDaysAgo=Date.now()-1728e5},execute:function(){var o=this;if(!(localStorage.getItem("last_cleanup")>this.twoDaysAgo))var a=setTimeout(function(){try{if(!m||!m.collect||!m.collect.backgrounds)return;clearTimeout(a);for(var e=[],t=!1,i=null,n=0;n<localStorage.length;n++)t=!1,"archived-"==(i=localStorage.key(n)).substring(0,9)&&(t=!0),"fallback-"==i.substring(0,9)&&(t=!0),"image_displayed-"==i.substring(0,16)&&(t=!0),"weather-loc-"==i.substring(0,12)?t=!0:"ddl-bg-"==i.substring(0,7)?localStorage.getItem(i)<o.twoDaysAgo&&(t=!0):"ddl-qt-"==i.substring(0,7)&&localStorage.getItem(i)<o.twoDaysAgo&&(t=!0),t&&e.push(i);for(n=0;n<e.length;n++)localStorage.removeItem(e[n]);e.length,o.collectionCleaner(m.collect.backgrounds),o.collectionCleaner(m.collect.quotes),o.collectionCleaner(m.collect.shortquotes),m.commandManager.execute("clean.localstorage.addin"),localStorage.setItem("last_cleanup",Date.now())}catch(e){}},500)},collectionCleaner:function(e,i){var n=this;if(e){i=i||"forDate",entriesToClean=[],e.each(function(e){var t=e.get(i);Date.parse(t)<n.twoDaysAgo&&entriesToClean.push(t)});for(var t=0;t<entriesToClean.length;t++){e.get(entriesToClean[t]).destroy()}return entriesToClean.length}return 0}}),m.commands.CleanupUserData=m.models.Command.extend({defaults:{id:"user.cleanup"},execute:function(e,t){e&&e.type&&("notifications"==e.type?this.cleanNotifications():"all"==e.type&&(this.cleanUserData(),this.managerCleanup(m),this.managerCleanup(m.models))),t&&t()},managerCleanup:function(e){var t=Object.keys(e);for(i in t){var n=t[i];if(m.hasOwnProperty(n)){var o=m[n];(o instanceof m.models.Manager||o instanceof m.collect.Manager)&&o.cleanup&&o.cleanup()}}},cleanNotifications:function(){for(var e=[],t=!1,i=null,n=0;n<localStorage.length;n++)t=!1,(i=localStorage.key(n)).startsWith("momentum-messages")?t=!0:"ts_notifications"==i&&(t=!0),t&&e.push(i);for(n=0;n<e.length;n++)localStorage.removeItem(e[n])},cleanUserData:function(){for(var e=[],t=!1,i=null,n=0;n<localStorage.length;n++)t=!1,"notes"==(i=localStorage.key(n))?t=!0:i.startsWith("quicklinks")?t=!0:i.startsWith("teamlinks")?t=!0:i.startsWith("countdown")?t=!0:i.startsWith("clock")?t=!0:i.startsWith("momentum-messages")?t=!0:"notes-"==i.substring(0,6)?t=!0:"cachedTodoProviders"==i?t=!0:"cachedFocus"==i?t=!0:"f3t6b23d"==i?t=!0:"current-countdown"==i?t=!0:"clocks"==i?t=!0:"clocks-"==i.substring(0,7)?t=!0:"activeTodoProvider"==i?t=!0:"activeTodoListId-"==i.substring(0,17)?t=!0:"font-"==i.substring(0,5)?t=!0:"listCache-"==i.substring(0,10)?t=!0:"projectCache-"==i.substring(0,13)?t=!0:"activeTodo"==i.substring(0,10)?t=!0:"tsCachedTodoProviders"==i?t=!0:"ts_notifications"==i?t=!0:"todos-updated"==i&&(t=!0),t&&e.push(i);var o=JSON.parse(localStorage.getItem("momentum-customization-1"));delete o.etag,localStorage.setItem("momentum-customization-1",JSON.stringify(o));for(n=0;n<e.length;n++)localStorage.removeItem(e[n])}}),m.commands.LoadAddins=m.models.Command.extend({defaults:{id:"addins.load"},execute:function(e){if(e){if(!this.addInsLoaded)for(this.addInsLoaded=!0,i=0;i<e.length;i++){var t=e[i];t&&m.addinManager.loadAddin(t)}m.trigger("processAddIns")}}}),m.commands.AccountLogin=m.models.Command.extend({defaults:{id:"account.login"},execute:function(e,t,i){localStorage.token?m.commandManager.execute("notification.show.enhanced",{message:"You are already logged in.",display_time:5e3,viewLimit:1,priority:2}):(m.commandManager.execute("user.cleanup",{type:"notifications"}),localStorage.doLoginOnNextLoad=!0,window.location.reload())}}),m.commands.Logout=m.models.Command.extend({defaults:{id:"logout"},execute:function(i,e){var n=this;if(e){var t=localStorage.getItem("momentum-customization"),o=localStorage.getItem("momentum-customization-1");return localStorage.clear(),localStorage.clear(),localStorage.setItem("momentum-customization",t),localStorage.setItem("momentum-customization-1",o),void this.showLogoutMessageAndReload(null,i)}if(m.commandManager.execute("user.cleanup",{type:"all"}),localStorage.token&&localStorage.token_uuid){var a={token:localStorage.token,token_uuid:localStorage.token_uuid};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(a),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/logout"}).done(function(e){}).fail(function(e,t){}).always(function(e,t){n.removeTokensClearLogoutReload(i)})}else n.removeTokensClearLogoutReload(i)},removeTokensClearLogoutReload:function(e){localStorage.removeItem("token"),localStorage.removeItem("token_uuid"),m.conditionalFeatures.clearFeatures(),this.showLogoutMessageAndReload(null,e)},showLogoutMessageAndReload:function(e,t){localStorage.setItem("loggedOut",Date.now());var i=t||"You have been logged out.";m.commandManager.execute("notification.show.enhanced",{message:i,display_time:5e3,viewLimit:1,priority:2},function(){window.location.reload()},!0)}}),m.commands.SyncEnable=m.models.Command.extend({defaults:{id:"sync.enable"},execute:function(e,t,i){m.conditionalFeatures.featureEnabled("serverfocus")||m.conditionalFeatures.featureEnabled("servertodos")||m.conditionalFeatures.featureEnabled("serverlinks")||localStorage.token&&m.syncCoordinator.submitFeatureAccessRequest("sync-early-access",function(){window.location.reload()},function(){m.commandManager.execute("notification.show.enhanced",{message:"Unable to enable account sync. Reload the tab and try again, or check our help site.",viewLimit:1,priority:2})})}}),m.commands.WindowNavigate=m.models.Command.extend({defaults:{id:"window.navigate"},execute:function(e,t){if(t){var i=null;t.url&&(i=t.url),e&&t.urlField&&(i=e.get(t.urlField)),i&&(window.location.href=i)}}}),m.commands.WindowOpen=m.models.Command.extend({defaults:{id:"window.open"},execute:function(e,t){if(t){var i=null;t.url&&(i=t.url),e&&t.urlField&&(i=e.get(t.urlField)),i&&window.open(i,t.windowName||"_blank")}}}),m.commands.NotificationShow=m.models.Command.extend({defaults:{id:"notification.show"},execute:function(e,t){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessage(e,t)},10)}}),m.commands.NotificationShowEnhanced=m.models.Command.extend({defaults:{id:"notification.show.enhanced"},execute:function(e,t,i){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessageEnhanced(e,t,i)},10)}}),m.commands.NotificationDismiss=m.models.Command.extend({defaults:{id:"notification.dismiss"},execute:function(){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.dismissMessage()},5)}}),m.commands.UpsellMessage=m.models.Command.extend({defaults:{id:"upsell.message"},execute:function(e){m.widgetManager.getWidget(e.targetRegion).showUpsell(e)}}),m.commands.UpsellWebsite=m.models.Command.extend({defaults:{id:"upsell.website"},execute:function(e,t){var i="https://momentumdash.com/plus?utm_source=extension&utm_medium=organic";t&&t.source?i+="&utm_campaign="+encodeURIComponent(t.source):!t&&e&&e.source&&(i+="&utm_campaign="+encodeURIComponent(e.source)),m.commandManager.execute("window.open",null,{url:i})}}),m.isValidDate=function(e){return"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e.getTime())},function(e){e.fn.mFadeIn=function(e,t){e=void 0!==e?e:500,this.timeouts&&this.timeouts.forEach(function(e){clearTimeout(e)}),this.timeouts=[];var i=this;return this.addClass("m-hide"),this.removeClass("m-hide-display"),this.timeouts.push(setTimeout(function(){i.removeClass("m-hide-visibility m-hide")},10)),this.timeouts.push(setTimeout(function(){t&&t()},e+10)),this},e.fn.mFadeOut=function(e,t,i){e=void 0!==e?e:500,this.timeouts&&this.timeouts.forEach(function(e){clearTimeout(e)}),this.timeouts=[];var n=this;return this.addClass("m-hide"),this.timeouts.push(setTimeout(function(){t?n.addClass("m-hide-visibility"):n.addClass("m-hide-display"),i&&i()},e)),this},e.fn.mShow=function(){return this.removeClass("m-hide-display m-hide-visibility"),this},e.fn.mHide=function(e){return e?this.addClass("m-hide-visibility"):this.addClass("m-hide-display"),this}}(jQuery),m.models.Date=Backbone.Model.extend({defaults:function(){return{date:new Date}},initialize:function(){this.listenTo(this,"change:date",this.updateTime,this)},setUpdateTimer:function(){var e=this,t=6e4,i=new Date;t=t-1e3*i.getSeconds()-i.getMilliseconds(),this.dateTimeoutId=setTimeout(function(){e.set("date",new Date),e.setUpdateTimer()},t)},getTimeString:function(e){var t=m.models.customization.get("hour12clock"),i=(e=e||this.get("date")).getHours(),n=e.getMinutes();return 1==t&&(i=(i+11)%12+1),i<10&&!t&&(i="0"+i),n<10&&(n="0"+n),i+":"+n},getTimePeriod:function(){return 12<=this.get("date").getHours()?"PM":"AM"},updateTime:function(){var e=this.getTimeString();this.get("time")!=e&&this.set("time",e)}}),m.views.Dashboard=Backbone.View.extend({initialize:function(){this.$loading=$('<span class="message-fill"><i class="loading-icon"></i> Loading...</span>'),m.console.log(m.elapsed()+": Dashboard Init"),m.models.themeManager=new m.models.ThemeManager,m.models.customization.fetch({error:function(){m.models.customization.save(),m.models.themeManager.initializeThemes()},success:function(){m.models.themeManager.initializeThemes()}}),this.listenTo(m,"processAddIns",this.processAddIns),m.models.backgroundManager=new m.models.BackgroundManager,m.models.teamInfo=new m.models.TeamInfo,m.views.background=new m.views.Background({region:"background"}),m.views.backgroundInfo=new m.views.BackgroundInfo({region:"bottom-left"}),m.models.backgroundManager.firstFetch(),m.models.notificationManager=new m.models.NotificationManager,m.bootstrappers.InitializeQuote(m,$),m.models.date&&m.models.date.setUpdateTimer(),this.newDayIntervalId=setInterval(function(){if(localStorage.activeDate){if(localStorage.activeDate!=getActiveDateString()){var e=9e3*Math.random()+1e3;setTimeout(function(){localStorage.activeDate=getActiveDateString(),m.trigger("newDay")},e)}}else localStorage.activeDate=getActiveDateString()},1e4),!m.models.customization.get("displayname")||localStorage.doLoginOnNextLoad?(m.readyForWidgets=!1,m.widgetManager.loadWidget("introduction"),m.listenToOnce(m.models.customization,"initialized",onSettingsInitialized)):(m.readyForWidgets=!0,m.trigger("readyForWidgets"),this.render());var e=getBrowserName();document.body.classList.add(e),"Firefox"===e&&getBrowserVersion()<57&&document.body.classList.add("oldFireFox"),this.initializeCompleted=!0},addEventHandler:function(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent?e.attachEvent("on"+t,i):e["on"+t]=i},processAddIns:function(){var e=this;e.processAddInsIntervalId=setInterval(function(){e.initializeCompleted&&(clearInterval(e.processAddInsIntervalId),m.addinManager.processPending())},50)},render:function(e,t){this.renderedOnce||(this.renderedOnce=!0,m.bootstrappers.RenderQuote(m,$,e),m.views.backgroundInfo&&(m.views.backgroundInfo.parentReady(e),m.widgets.push(m.views.backgroundInfo)),m.views.settingsPane=new m.views.settings.SettingsPane({region:"bottom-left",order:"prepend"}),m.widgets.push(m.views.settingsPane),m.models.notificationManager.setParent(m.views.settingsPane),m.views.greeting=new m.views.Greeting({model:m.models.date,region:"center",order:"prepend"}),m.widgets.push(m.views.greeting),m.views.centerClock=new m.views.CenterClock({model:m.models.date,region:"center",order:"prepend"}),m.widgets.push(m.views.centerClock),m.trigger("main-render-complete"),t&&t())},getViewById:function(t){var i=null;return _.each(m.widgets,function(e){e.el.id===t&&(i=e)}),i},removeView:function(t){_.each(m.widgets,function(e){e.el.id===t&&e.$el.fadeTo(500,0,function(){e.remove(),m.widgets.splice(m.widgets.indexOf(e),1)})})},removeAllViews:function(e){_.each(m.widgets,function(e){e&&e.$el.fadeTo(500,0,function(){e.remove()})}),m.widgets=[],_.delay(e,475)}}),$(function(){!function(){try{for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<1e3;i++)e+=t.charAt(Math.floor(Math.random()*t.length));localStorage.setItem("capacityTest",e),localStorage.removeItem("capacityTest")}catch(e){try{localStorage.removeItem("capacityTest");var n=Date.now()-1728e5,o=[],a=!1,s=null;for(i=0;i<localStorage.length;i++)a=!1,"last_cleanup"==(s=localStorage.key(i)).substring(0,12)&&(a=!0),"archived-"==s.substring(0,9)&&(a=!0),"fallback-"==s.substring(0,9)&&(a=!0),"listCache-"==s.substring(0,10)&&(a=!0),"font-"==s.substring(0,5)&&(a=!0),"image_displayed-"==s.substring(0,16)&&(a=!0),"weather-loc-"==s.substring(0,12)?a=!0:"ddl-bg-"==s.substring(0,7)?localStorage.getItem(s)<n&&(a=!0):"ddl-qt-"==s.substring(0,7)&&localStorage.getItem(s)<n&&(a=!0),a&&o.push(s);for(i=0;i<o.length;i++)localStorage.removeItem(o[i])}catch(e){}}}(),m.utils.setMomentumAuthHeader=setMomentumAuthHeader,m.utils.validateEmail=validateEmail,m.utils.getQueryParameter=getQueryParameter,m.utils.getActiveDateString=getActiveDateString,m.utils.activeDateStringForDate=activeDateStringForDate,m.utils.getDayName=getDayName,m.utils.getMonthName=getMonthName,m.utils.getDaysInMonth=getDaysInMonth,m.utils.dateDiffIntegerDays=dateDiffIntegerDays,m.utils.dateIsYesterday=dateIsYesterday,m.utils.dateIsToday=dateIsToday,m.utils.dateIsTomorrow=dateIsTomorrow,m.utils.dateIsInLast7d=dateIsInLast7d,m.utils.getFriendlyDate=getFriendlyDate,m.utils.formatYearRelative=formatYearRelative,m.utils.formatMonthDayRelative=formatMonthDayRelative,m.utils.getHoursMinsStr=getHoursMinsStr,m.utils.toUTC=toUTC,m.utils.toLocalTime=toLocalTime,m.utils.nightsBetween=nightsBetween,m.utils.dateAdd=dateAdd,m.utils.twoDigit=twoDigit,m.utils.captionFormatter=function(e){return e},m.utils.mergeObjects=function(e,t,i){for(var n in e=e||{},t)e[n]=i&&e[n]||t[n];return e},m.utils.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},m.utils.toTodaysTime=function(e){var t=new Date,i=e.indexOf(":"),n=e.substring(0,i);return n=12==n?0:n,t.setHours(parseInt(n)+("p"===e[e.length-2].toLowerCase()?12:0)),t.setMinutes(parseInt(e.substring(i+1,e.length-2))),t},m.utils.memberwiseCompareObject=function(e,t,i){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(var n in e)if((!i||!_.contains(i,n))&&e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(e[n]!==t[n]){if("object"!=typeof e[n])return!1;if(!Object.equals(e[n],t[n]))return!1}}for(n in t)if((!i||!_.contains(i,n))&&t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0},m.models.date=new m.models.Date,m.models.customization=new m.models.ComputedSettings({id:1}),m.listenToOnce(m.models.customization,"initialized",onSettingsInitialized),m.console.log(m.elapsed()+": Settings requested"),m.models.customization.initializeSettings()});var onSettingsInitialized=function(){m.console.log(m.elapsed()+": Settings initialized"),m.sendEvent("/dashboard.html?v="+m.globals.version,null,null,"pageview");var e="installed-"+m.globals.version;localStorage.getItem(e)||localStorage.setItem(e,!0),m.addinManager=new m.models.AddinManager,m.commandManager=new m.CommandManager,m.models.customization.get("displayname")&&!localStorage.doLoginOnNextLoad||(m.prelogin=!0),m.widgetManager=new m.models.WidgetManager,m.widgetManager.setupWhenReady(),m.appView=new m.views.Dashboard,localStorage.client_uuid||$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({action:"registerClient"}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/client"}).done(function(e){e.client_uuid&&localStorage.client_uuid!=e.client_uuid&&(localStorage.client_uuid=e.client_uuid,m.trigger("client:id_created"))}).fail(function(e,t){}),m.syncCoordinator=new m.models.SyncCoordinator,localStorage.firstSynchronized&&m.trigger("sync:downloadIfNeeded"),m.syncCoordinator.syncSettings(),setTimeout(registerDeferedListeners,2e3)};function registerDeferedListeners(){window.addEventListener("storage",function(e){if("activeDate"==e.key&&e.oldValue!=e.newValue){var t=9e3*Math.random()+1e3;setTimeout(function(){m.trigger("newDay")},t)}}),$(window).resize(function(){m.trigger("globalEvent:window:resize")}),window.onblur=function(){m.trigger("globalEvent:windowBlur")},$(document).click(function(e){m.trigger("globalEvent:click",e)}),$(document).keyup(function(e){27==e.keyCode&&m.trigger("globalEvent:esc",e),32==e.keyCode&&m.focusingOnBg&&(m.focusingOnBg=!1,m.views.backgroundInfo.unfocusBg(),$(".background-info-title, .background-info-source").removeClass("hotkey-hover")),"Alt"==e.key&&m.trigger("globalEvent:altUp",e)}),$(document).keydown(function(e){if(9===e.keyCode&&"BODY"===document.activeElement.tagName){e.preventDefault();var t=$("#search-input");if(t.length)t.focus();else{var i=$("#focuses").find("input");i.length?i.focus():$("a:visible:first").focus()}}if(8==e.keyCode&&e.shiftKey&&e.metaKey&&m.trigger("globalEvent:metaBackspace",e),13==e.keyCode&&e.metaKey&&m.trigger("globalEvent:metaEnter",e),219==e.keyCode&&e.metaKey&&m.trigger("globalEvent:metaBracketLeft",e),221==e.keyCode&&e.metaKey&&m.trigger("globalEvent:metaBracketRight",e),78==e.keyCode&&e.ctrlKey&&m.trigger("globalEvent:ctrlN",e),70==e.keyCode&&e.altKey&&m.trigger("globalEvent:altF",e),76==e.keyCode&&e.altKey&&m.trigger("globalEvent:altL",e),e.altKey&&38==e.keyCode&&m.trigger("globalEvent:altArrowUp",e),e.altKey&&40==e.keyCode&&m.trigger("globalEvent:altArrowDown",e),!(e.ctrlKey||e.metaKey||e.altKey&&78!=e.keyCode||"INPUT"==document.activeElement.tagName||"TEXTAREA"==document.activeElement.tagName||1==document.activeElement.isContentEditable)){var n;if(76==e.keyCode)m.trigger("globalEvent:key:L",e);else if(70==e.keyCode)n="Focus";else if(84==e.keyCode)m.trigger("globalEvent:key:T",e);else if(83==e.keyCode)n="Search";else if(188==e.keyCode){if(e.metaKey)return;n="Settings"}else{if(67==e.keyCode&&isChrome())return n="Chrome Tab",m.sendEvent(n,"Hotkey"),void getBrowser().tabs.update({url:"chrome-search://local-ntp/local-ntp.html"});if(8==e.keyCode)m.trigger("globalEvent:key:backspace",e);else if(13==e.keyCode)m.trigger("globalEvent:key:enter",e);else if(32==e.keyCode){m.trigger("globalEvent:spacebar",e);var o=m.widgetManager.getWidget("todo");if(o&&o.isHovered)return;m.focusingOnBg=!0,m.views.backgroundInfo.focusOnBg(),$(".background-info-title, .background-info-source").addClass("hotkey-hover")}else 38==e.keyCode?m.trigger("globalEvent:arrowUp",e):40==e.keyCode?m.trigger("globalEvent:arrowDown",e):37==e.keyCode?m.trigger("globalEvent:arrowLeft",e):65==e.keyCode?m.trigger("globalEvent:key:A",e):39==e.keyCode?m.trigger("globalEvent:arrowRight",e):78==e.keyCode&&e.shiftKey?m.trigger("globalEvent:key:shiftN",e):78!=e.keyCode||e.shiftKey||m.trigger("globalEvent:key:N",e)}87==e.keyCode?m.views.weather.togglePopup():66==e.keyCode?null!=getBrowser().topSites&&(m.views.bookmarks?m.trigger("bookmarks:toggle",e):m.widgetManager.loadWidget("bookmarks").then(function(){m.trigger("bookmarks:toggle",e)})):e.shiftKey&&191==e.keyCode&&m.commandManager.execute("settings.toggle",null,{section:"help"}),n&&(m.trigger("globalEvent:toggle"+n.replace(/\s+/g,"")),m.sendEvent(n,"Toggle Show","Hotkey"),e.preventDefault())}}),"safari"==m.globals.platform&&$("a").on("click",function(e){safari.self.tab.dispatchMessage("sendClick",{link:this.href,time:(new Date).getTime()})}),m.listenTo(m,"user:successfulLogout",function(){m.appView.removeAllViews(function(){m.appView=new m.views.Dashboard})});var i=$("body");m.conditionalFeatures.featureEnabled("custom-bg")&&!m.models.customization.get("disableDrop")&&(m.appView.addEventHandler(document.body,"dragover",function(e){e.stopPropagation(),e.preventDefault(),_.contains(e.dataTransfer.types,"Files")?e.dataTransfer.dropEffect="copy":e.dataTransfer.dropEffect="none"}),window.addEventListener("dragenter",function(e){_.contains(e.dataTransfer.types,"Files")&&(m.appView.lastTarget=e.target,i.addClass("blur show-drop"))}),window.addEventListener("dragleave",function(e){e.preventDefault(),e.target!==document&&e.target!==m.appView.lastTarget||i.removeClass("blur show-drop")},!1),window.addEventListener("dragover",function(e){e.preventDefault()}),m.appView.addEventHandler(document.body,"drop",function(e){if(e&&e.dataTransfer.files.length&&Array.prototype.some.call(e.dataTransfer.files,function(e){return e&&e.name.match(/\.(gif|jpg|jpeg|tiff|png)$/i)})){if(e.stopPropagation(),e.preventDefault(),i.removeClass("blur show-drop"),!_.contains(e.dataTransfer.types,"Files"))return;if(!m.conditionalFeatures.featureEnabled("custom-bg")){return void m.commandManager.execute("upsell.message",{targetRegion:"settings",sourceEvent:"customBackgrounds-dropFiles",buttonText:"Learn more",title:"Custom Backgrounds",description:"Add your own backgrounds with Plus"})}var t=e.dataTransfer.files;t&&0<t.length&&m.commandManager.ensureCommandLoaded("background.custom.uploadfiles",function(){m.commandManager.execute("background.custom.uploadfiles",t)},null,function(e){})}else i.removeClass("blur show-drop")}))}